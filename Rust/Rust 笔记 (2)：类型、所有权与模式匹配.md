# 1 è¯­è¨€åŸºç¡€

## æ ‡è¯†ç¬¦

- ç”±ä»»æ„éç©ºçš„ï¼Œä¸”é emoji çš„ Unicode å­—ç¬¦æ„æˆ
- ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ï¼Œä¸”ä¸èƒ½ä¸ºå…³é”®å­—
- å•ä¸ª `_` ä½œä¸ºæ ‡è¯†ç¬¦è¡¨ç¤º**å¿½ç•¥**

### åŸå§‹æ ‡è¯†ç¬¦

å½“å’Œå¤–éƒ¨ FFI è¿›è¡Œäº¤äº’æ—¶ï¼Œå¦‚è°ƒç”¨ C åº“ä¸­åä¸º `match` çš„å‡½æ•°ã€‚åœ¨ C ä¸­ match ä¸æ˜¯å…³é”®å­—ï¼Œä½†åœ¨ Rust ä¸­æ˜¯å…³é”®å­—ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ä»¥ `r#` å¼€å¤´çš„åŸå§‹æ ‡è¯†ç¬¦ã€‚

```rust
fn r#fn() {
    let r#i32 = 10;
    println!("{}", r#i32);
}

fn main() {
    r#fn();
}
```

## å¸¸é‡å’Œå˜é‡

**å¸¸é‡**ä½¿ç”¨ `const` å£°æ˜ï¼Œå¿…é¡»æ˜¾å¼æ ‡æ³¨ç±»å‹ï¼Œå¹¶åœ¨å£°æ˜æ—¶åˆå§‹åŒ–ï¼Œå£°æ˜åå€¼ä¸å¯å˜ã€‚

**å˜é‡**ä½¿ç”¨ `let` å£°æ˜ï¼Œå¯ä»¥ä¸æ˜¾å¼å£°æ˜ç±»å‹ï¼Œå€¼ä¸å˜é‡é€šè¿‡**ç»‘å®š**æ¥å…³è”ã€‚ä½† Rust é»˜è®¤å˜é‡ä¹Ÿæ˜¯**ä¸å¯å˜çš„**ï¼Œéœ€è¦æ˜¾å¼ä½¿ç”¨ `mut` ä¿®é¥°æ¥ä½¿å…¶å¯å˜ã€‚

```rust
const MAX: i32 = 5;  // å¸¸é‡
let x = 1;           // ä¸å¯å˜å˜é‡
let mut y: u32 = 2;  // å¯å˜å˜é‡
```

`let` å’Œ `mut` æ˜¯ä¸€ä¸ª**æ¨¡å¼**ï¼Œå¯ä»¥åˆ©ç”¨**æ¨¡å¼åŒ¹é…**æ¥å£°æ˜å˜é‡ï¼š

```rust
let (mut a, b) = (1, 2);  // a å¯å˜ï¼Œb ä¸å¯å˜
```

å˜é‡å¯ä»¥ä¸å¿…åœ¨å£°æ˜æ—¶åˆå§‹åŒ–ï¼Œä½†ä½¿ç”¨å‰å¿…é¡»è¢«åˆå§‹åŒ–ï¼š

```rust
let x;
x = 1;
println!("{x}");
```

å¸¸é‡å’Œä¸å¯å˜å˜é‡çš„åŒºåˆ«ï¼š

- å¸¸é‡çš„å€¼å¿…é¡»èƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸå°±è®¡ç®—å‡ºï¼Œä¸èƒ½æ˜¯åœ¨è¿è¡Œæ—¶æ‰è®¡ç®—å‡ºçš„å€¼
- å¸¸é‡å¯ä»¥åœ¨ä»»ä½•ä½œç”¨åŸŸä¸­å£°æ˜ï¼ŒåŒ…æ‹¬å…¨å±€ä½œç”¨åŸŸï¼Œè€Œå˜é‡åªèƒ½åœ¨å‡½æ•°ä½œç”¨åŸŸå£°æ˜

### éšè—

å¯ä»¥é€šè¿‡ `let` æ¥å®šä¹‰ä¸€ä¸ªä¸å·²å£°æ˜å˜é‡æˆ–å‡½æ•°åŒåçš„æ–°å˜é‡ï¼Œæ–°å˜é‡ä¼šéšè—ä¹‹å‰çš„å˜é‡æˆ–å‡½æ•°ã€‚

```rust
fn sum(x: i32, y: i32) -> i32 {
    x + y
}

fn main() {
    let x = 1;
    let x = x + 2;
    let x = 1.2;    // ç±»å‹å¯ä»¥ä¸åŒ
    let sum = sum(1, 2);
    sum(3, 4);      // é”™è¯¯ï¼Œsum å‡½æ•°åœ¨æ­¤å¤„ä¸å¯ç”¨
}
```

æ–°å˜é‡åªåœ¨å…¶ä½œç”¨åŸŸå†…èµ·ä½œç”¨ï¼Œå½“ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå¤–éƒ¨è¢«éšè—çš„é¡¹ä¼šæ¢å¤ï¼š

```rust
let v = 2;
{
    let v = 4;
    println!("{v}");   // è¾“å‡º 4
}
println!("{v}");       // è¾“å‡º 2
```

è¢«éšè—çš„å˜é‡å®é™…ä¸Šä¾ç„¶å­˜åœ¨ï¼š

```rust
let x = 5;
let ref_x = &x;
let x = 1.0;
assert_eq!(*ref_x, 5);
```

## é™æ€é¡¹

é™æ€é¡¹ä½¿ç”¨ `static` å£°æ˜ï¼Œå¿…é¡»æ˜¾å¼æ ‡æ³¨ç±»å‹å’Œåˆå§‹åŒ–ã€‚ç±»ä¼¼äºå¸¸é‡ï¼Œä½†åœ¨ç¨‹åºä¸­è¡¨ç¤ºä¸€ä¸ªç²¾ç¡®çš„å†…å­˜åœ°å€ï¼Œé€šå¸¸ä¿å­˜åœ¨äºŒè¿›åˆ¶æ–‡ä»¶çš„ `.data` åŒºå—ä¸­ã€‚æ‰€æœ‰å¯¹é™æ€é¡¹çš„å¼•ç”¨éƒ½æŒ‡å‘ç›¸åŒçš„å†…å­˜åœ°å€ï¼Œå¹¶å…·æœ‰ ` 'static` ç”Ÿå‘½å‘¨æœŸï¼Œä¸”ä¸ä¼šåœ¨ç¨‹åºç»“æŸæ—¶è°ƒç”¨ææ„å‡½æ•° `drop`ã€‚

èƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸæ±‚å€¼çš„å¸¸é‡è¡¨è¾¾å¼å¯ä½œä¸ºé™æ€é¡¹çš„åˆå§‹åŒ–ï¼Œå¹¶å¯å¼•ç”¨å…¶å®ƒé™æ€é¡¹ã€‚

æ‰€æœ‰è®¿é—®é™æ€é¡¹çš„æ“ä½œéƒ½æ˜¯å®‰å…¨çš„ï¼Œä½†æœ‰ä¸€äº›é™åˆ¶ï¼š

- é™æ€é¡¹çš„æ•°æ®ç±»å‹å¿…é¡»å®ç° `Sync`
- å¸¸é‡é¡¹ä¸èƒ½å¼•ç”¨é™æ€é¡¹

é™æ€é¡¹å¯ä½¿ç”¨ `mut` å£°æ˜ï¼Œä½†å¯¹å…¶æ‰€æœ‰è®¿é—®æ“ä½œéƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œéœ€è¦åœ¨ `unsafe` å—ä¸­ä½¿ç”¨ã€‚

```rust
static mut COUNT: i32 = 0;

unsafe fn read_count() -> i32 {
    COUNT
}

unsafe fn write_count(n: i32) {
    COUNT += n;
}
```

## åŸºæœ¬ç±»å‹

Rust æ˜¯**é™æ€ç±»å‹**è¯­è¨€ï¼Œç¼–è¯‘å™¨èƒ½å¤Ÿè¿›è¡Œç±»å‹æ¨æ–­ã€‚å½“å¤šç§ç±»å‹å‡æœ‰å¯èƒ½æ—¶ï¼Œå¿…é¡»å¢åŠ **ç±»å‹æ ‡æ³¨**ã€‚

```rust
let x: u32 = 10;
let y: f32 = 3.14;
```

æ¯ä¸€ä¸ªå€¼éƒ½å±äºæŸç§æ•°æ®ç±»å‹ï¼ŒRust æœ‰ä¸¤ç§æ•°æ®ç±»å‹ï¼š**æ ‡é‡**å’Œ**å¤åˆ**ã€‚

### æ ‡é‡ç±»å‹

æ ‡é‡ç±»å‹ä»£è¡¨ä¸€ä¸ªå•ç‹¬çš„å€¼ã€‚Rust æœ‰å››ç§åŸºæœ¬æ ‡é‡ç±»å‹ï¼š**æ•´å‹**ã€**æµ®ç‚¹å‹**ã€**å¸ƒå°”ç±»å‹**å’Œ**å­—ç¬¦ç±»å‹**ã€‚

#### æ•´å‹

| **é•¿åº¦** | **æœ‰ç¬¦å·** | **æ— ç¬¦å·** |
| -------- | ---------- | ---------- |
| 8 bit    | i8         | u8         |
| 16 bit   | i16        | u16        |
| 32 bit   | i32 (é»˜è®¤) | u32        |
| 64 bit   | i64        | u64        |
| 128 bit  | i128       | u128       |
| arch     | isize      | usize      |

- æœ‰ç¬¦å·æ•°ä»¥**è¡¥ç **å½¢å¼å­˜å‚¨

- `isize` å’Œ `usize` ä¾èµ–äºè¿è¡Œç¨‹åºçš„è®¡ç®—æœºæ¶æ„

| **å­—é¢å€¼**     | **ä¾‹**        |
| -------------- | ------------- |
| Decimal        | `10_000`      |
| Hex            | `0xfe`        |
| Octal          | `0o77`        |
| Binary         | `0b1010_1000` |
| Byte (ä»… `u8`) | `b'A'`        |

- é™¤ Byte ä»¥å¤–çš„æ‰€æœ‰å­—é¢å€¼å…è®¸ä½¿ç”¨ç±»å‹åç¼€ï¼Œå¦‚ `12_u8`ï¼Œä¹Ÿå…è®¸ä½¿ç”¨ `_` ä½œä¸ºåˆ†éš”ç¬¦

- å¯¹äºæ•´æ•°æº¢å‡ºï¼Œéä¼˜åŒ–ç¼–è¯‘æ—¶ï¼Œä¼šæ£€æŸ¥è¿™ç±»é—®é¢˜å¹¶ panicã€‚ä¼˜åŒ–ç¼–è¯‘æ—¶ä¸æ£€æŸ¥ï¼Œå¹¶æŒ‰ç…§è¡¥ç è®¡ç®—å®é™…å€¼

#### æµ®ç‚¹å‹

Rust æœ‰ `f32` å’Œ `f64` ä¸¤ç§æµ®ç‚¹ç±»å‹ï¼Œéµå¾ª [IEEE 754](https://zh.wikipedia.org/wiki/IEEE_754) æ ‡å‡†ï¼Œå­—é¢å€¼é»˜è®¤ä¸º `f64`ã€‚

#### å¸ƒå°”å‹

`bool` è¡¨ç¤ºå¸ƒå°”ç±»å‹ï¼Œä»…æœ‰ä¸¤ä¸ªå¯èƒ½çš„å€¼ï¼š`true` å’Œ `false`ã€‚

#### å­—ç¬¦ç±»å‹

`char` è¡¨ç¤ºå­—ç¬¦ç±»å‹ï¼Œå€¼ç”±å•å¼•å·åŒ…æ‹¬ã€‚

```rust
let a: char = 'a';
let b = 'ä½ ';
let c = 'ã‚';
let d = 'Î©';
let e = 'ğŸ˜…';
let f = '\u{102c0}';
```

`char` å¯ä»¥æ˜¯åˆæ³•çš„ Unicode æ ‡é‡å€¼ï¼Œä¸€ä¸ª `char` å  4 ä¸ªå­—èŠ‚ã€‚

Unicode ä¸­æœ‰ä¸€äº›å­—ç¬¦æ˜¯**é›¶å®½åº¦å­—ç¬¦**ï¼Œè¿™äº›ä¸ `''` è¿™ç§ç©ºå­—ç¬¦æ˜¯ä¸ä¸€æ ·çš„ã€‚**Rust æ²¡æœ‰ç©ºå€¼**ï¼Œå› æ­¤ `''` æ˜¯ä¸è¢«å…è®¸çš„ã€‚

```rust
let c = '';  // é”™è¯¯ï¼Œä¸èƒ½ä¸ºç©ºå€¼
```

å¯ä»¥å°†å­—ç¬¦å€¼èµ‹ç»™æ•´å‹å˜é‡ï¼Œä½†é™åˆ¶å¦‚ä¸‹ï¼š

- å¿…é¡»å¢åŠ ç±»å‹å‰ç¼€ `b`

- ä»…æ”¯æŒ `u8`

```rust
let n: u8 = b'A';   // n = 65
```

### å¤åˆç±»å‹

å¤åˆç±»å‹æ˜¯ç”±å¤šä¸ªå€¼ç»„åˆè€Œæˆçš„ç±»å‹ï¼ŒRust çš„åŸç”Ÿå¤åˆç±»å‹ä¸º**å…ƒç»„**å’Œ**æ•°ç»„**ã€‚

#### å…ƒç»„ç±»å‹

å…ƒç»„æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ª**ç›¸åŒæˆ–ä¸åŒç±»å‹å€¼**çš„åˆ—è¡¨ï¼Œä¸”é•¿åº¦å›ºå®šï¼Œç±»å‹è¡¨ç¤ºä¸º `(T, U, ..)`ã€‚å¯é€šè¿‡æ¨¡å¼åŒ¹é…æ¥**è§£æ„**å…¶ä¸­çš„å€¼ï¼Œæˆ–ä½¿ç”¨ `.index` æ¥ç›´æ¥è®¿é—®å…¶ä¸­çš„å€¼ã€‚

```rust
let tup: (i32, f64, u8) = (100, 2.1, 20);
let (x, ..) = tup;
assert!(x == tup.0);
```

ä¸ºäº†é¿å…æ­§ä¹‰ï¼Œå•å…ƒç´ å…ƒç»„éœ€è¦è¿½åŠ  `,`ï¼š

```rust
let tup = (1,);
```

#### æ•°ç»„ç±»å‹

æ•°ç»„æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ª**ç›¸åŒç±»å‹å€¼**çš„åˆ—è¡¨ï¼Œä¸”é•¿åº¦å›ºå®šï¼Œç±»å‹è¡¨ç¤ºä¸º `[T; N]`ã€‚å¯é€šè¿‡æ¨¡å¼åŒ¹é…è§£æ„æˆ–ä½¿ç”¨ `[index]` æ¥ç›´æ¥è®¿é—®å…¶ä¸­çš„å€¼ã€‚

```rust
let arr: [i32; 5] = [1, 2, 3, 4, 5];
let [x, ..] = arr;
assert_eq!(x, arr[0]);
```

å¯é€šè¿‡ `[v; N]` æ¥åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º `N`ï¼Œå…ƒç´ å€¼éƒ½ä¸º `v` çš„æ•°ç»„ï¼š

```rust
let arr = [0; 5];
```

å½“å¯¹æ— æ•ˆçš„æ•°ç»„å…ƒç´ è¿›è¡Œè®¿é—®æ—¶ä¼š panicï¼š

```rust
arr[10];  // panic
```

### å¼•ç”¨ç±»å‹

å¼•ç”¨è¡¨ç¤ºæ‹¥æœ‰æŸä¸ªå€¼çš„å€Ÿç”¨ï¼ŒåŒ…å«ä¸¤ç§ç±»å‹ï¼š

- `&T`ï¼šä¸å¯å˜å¼•ç”¨

- `&mut T`ï¼šå¯å˜å¼•ç”¨

å¼•ç”¨æ˜¯ä¸€ä¸ªå¯¹é½ä¸”é `null` çš„æŒ‡é’ˆï¼ŒæŒ‡å‘åŒ…å«æœ‰æ•ˆå€¼ `T` çš„å†…å­˜ã€‚åœ¨å€¼ä¸Šä½¿ç”¨ `&` æˆ– `&mut`ï¼Œä»¥åŠ `ref` æˆ– `ref mut` æ¨¡å¼å¯è·å¾—è¯¥å€¼çš„å€Ÿç”¨ã€‚

```rust
let n1 = 1;
let rn1 = &n1;
let mut n2 = 2;
let rn2 = &mut n2;

*rn2 = *rn1;

let mut x = 5;
let ref mut y = x;
*y += 1;
assert_eq!(x, 6);
```

### è£¸æŒ‡é’ˆç±»å‹

è£¸æŒ‡é’ˆåŒ…å«ä¸¤ç§ç±»å‹ï¼š

- `*const T`ï¼šä¸å¯å˜è£¸æŒ‡é’ˆ

- `*mut T`ï¼šå¯å˜è£¸æŒ‡é’ˆ

è£¸æŒ‡é’ˆå¯ä»¥æ˜¯æœªå¯¹é½æˆ–ä¸º `null` çš„ã€‚å½“ä½¿ç”¨ `*` è§£å¼•ç”¨è£¸æŒ‡é’ˆæ—¶ï¼Œè¦æ±‚å¿…é¡»å¯¹é½ä¸”é `null`ï¼Œå› æ­¤å¯¹è£¸æŒ‡é’ˆ**è¿›è¡Œè§£å¼•ç”¨æ˜¯ä¸å®‰å…¨çš„**ã€‚

```rust
let n1 = 1;
let pn1: *const i32 = &n1;
let mut n2 = 2;
let pn2: *mut i32 = &mut n2;

unsafe {
    *pn2 = *pn1;
}
```

æˆ–è€…ä½¿ç”¨ `&raw` æ¥å®šä¹‰è£¸æŒ‡é’ˆï¼š

```rust
let x = 1;

// ä¸¤è€…ç­‰ä»·
let px = &x as *const i32;
let px2 = &raw const x;

unsafe {
    assert_eq!(*px, *px2);
}
```

### å•å…ƒç±»å‹

æ²¡æœ‰ä»»ä½•å€¼çš„å…ƒç»„ä¸º**å•å…ƒç±»å‹**ï¼Œä»…æœ‰ä¸€ä¸ª**å•å…ƒå€¼** `()`ã€‚ä¸è¿”å›ä»»ä½•å€¼çš„è¡¨è¾¾å¼å’Œå‡½æ•°ã€ä»¥ `;` ç»“æŸçš„è¯­å¥éƒ½éšå¼åœ°è¿”å› `()`ã€‚

```rust
fn foo() {}
let empty: () = ();
()
```

### never ç±»å‹

`!` ä¸º **never ç±»å‹**ï¼Œä¸»è¦ç”¨äºåœ¨å‡½æ•°æ°¸ä¸è¿”å›æ—¶å……å½“è¿”å›å€¼ï¼Œè¿™ç±»å‡½æ•°ä¹Ÿè¢«ç§°ä¸º**å‘æ•£å‡½æ•°**ã€‚

```rust
fn foo() -> ! {}
```

åœ¨ match è¡¨è¾¾å¼ä¸­ï¼Œéœ€è¦è¿”å›ä¸€ä¸ªå€¼ï¼Œä¸”è¿”å›å€¼ç±»å‹å¿…é¡»ç›¸åŒã€‚

```rust
fn sample_match(val: bool) -> i32 {
    match val {
        true => 42,
        false => "error",   // é”™è¯¯ï¼Œç±»å‹ä¸åŒ¹é…
    }
}
```

é€šè¿‡è¿”å›ä¸€ä¸ª `!`ï¼Œå¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚

```rust
fn loop_with_match(val: bool) {
    loop {
        match val {
            true => {
                println!("True condition detected!");
                break;
            }
            false => loop {},
        }
    }
}
```

`loop`ã€`break`ã€`continue`ã€`panic!`ã€`std::process:exit` ä»¥åŠ `unwrap`ã€`expect` çš„å¤±è´¥æƒ…å†µä¹Ÿè¿”å›çš„æ˜¯ `!`ã€‚

`!` å®é™…ä¸Šæ˜¯æ‰€æœ‰ç±»å‹çš„å­ç±»å‹ï¼Œå› æ­¤å¯ä»¥è¢«å¼ºè½¬ä¸ºä»»ä½•å…¶å®ƒç±»å‹ã€‚

```rust
let x = loop {};
let y: u32 = x;
```

## åŠ¨æ€å¤§å°ç±»å‹

åœ¨ç¼–è¯‘æ—¶å°±å·²çŸ¥å¤§å°çš„ç±»å‹ä¸º**å›ºå®šå¤§å°ç±»å‹**ï¼Œå…·æœ‰ `Sized`ã€‚è€Œåœ¨è¿è¡Œæ—¶æ‰çŸ¥é“å¤§å°çš„ç±»å‹ä¸º**åŠ¨æ€å¤§å°ç±»å‹**ï¼ˆDynamically Sized Typesï¼ŒDSTï¼‰ï¼Œå…·æœ‰ `?Sized`ã€‚å¦‚åˆ‡ç‰‡ `[T]` å’Œ trait å¯¹è±¡ `dyn Trait` éƒ½æ˜¯ DSTï¼Œè¿™ç§ç±»å‹éƒ½ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œ**å¿…é¡»é€šè¿‡æŒ‡é’ˆæˆ–å¼•ç”¨æ¥é—´æ¥ä½¿ç”¨**ï¼Œå¦‚ `&[T]`ã€`&dyn Trait` æˆ– `Box<dyn Trait>` ç­‰ã€‚

```rust
let s1: str = "foo";  // é”™è¯¯
let s2: &str = "bar"
```

- æŒ‡å‘ DST çš„æŒ‡é’ˆå¤§å°æ˜¯å›ºå®šçš„ï¼Œä¸”ä¸ºæŒ‡å‘ `Sized` çš„æŒ‡é’ˆå¤§å°çš„ä¸¤å€ï¼š
  - æŒ‡å‘åˆ‡ç‰‡çš„æŒ‡é’ˆé¢å¤–å­˜å‚¨äº†åˆ‡ç‰‡çš„å…ƒç´ æ•°é‡
  - æŒ‡å‘ trait å¯¹è±¡çš„æŒ‡é’ˆé¢å¤–å­˜å‚¨äº† vtable çš„åœ°å€
- DST å¯ä»¥ä½œä¸ºå®å‚æ¥ä¼ é€’ç»™æœ‰ `?Sized` çº¦æŸçš„æ³›å‹ç±»å‹å‚æ•°ã€‚å½“å…³è”ç±»å‹çš„å£°æ˜æœ‰ `?Sized` çº¦æŸæ—¶ï¼Œä¹Ÿå¯ä»¥è¢«ç”¨äºå…³è”ç±»å‹å®šä¹‰
- é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•æ³›å‹å‚æ•°æˆ–å…³è”ç±»å‹éƒ½æœ‰ `Sized` çº¦æŸï¼Œé™¤éä½¿ç”¨ `?Sized` æ¥æ”¾å®½çº¦æŸ
- ä¸æ³›å‹ç±»å‹å‚æ•°ä¸åŒï¼Œtrait å®šä¹‰ä¸­çš„é»˜è®¤çº¦æŸä¸º `Self: ?Sized`ï¼Œå› æ­¤å¯ä»¥ä¸º DST å®ç° trait
- ç»“æ„ä½“çš„æœ€åä¸€ä¸ªå­—æ®µå¯ä»¥ä¸º DSTï¼Œè¿™è®©è¯¥ç»“æ„ä½“ä¹Ÿæ˜¯ä¸€ä¸ª DST

> é™æ€é¡¹ã€å¸¸é‡ã€å˜é‡å’Œå‡½æ•°å‚æ•°å¿…é¡»å…·æœ‰ `Sized`ã€‚

## ç±»å‹åˆ«å

ä½¿ç”¨ `type` å…³é”®å­—æ¥ç»™ç°æœ‰ç±»å‹å£°æ˜ä¸€ä¸ªç±»å‹åˆ«åã€‚

```rust
type MyType = i32;
```

`MyType` å®é™…ä¸Šæ˜¯ `i32` çš„åŒä¹‰è¯ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå…¨æ–°çš„ç±»å‹ ï¼Œè¯¥ç±»å‹çš„å€¼å°†è¢«å½“ä½œ `i32` æ¥å¯¹å¾…ã€‚

```rust
type MyType = i32;

let x: i32 = 5;
let y: MyType = 5;

println!("x + y = {}", x + y);
```

ç±»å‹åˆ«åä¸»è¦ç”¨äºå‡å°‘é‡å¤ï¼Œå¦‚ä¸€ä¸ªå¾ˆé•¿çš„ç±»å‹ï¼š

```rust
Box<dyn Fn() + Send + 'static>
```

åœ¨å‡½æ•°ç­¾åæˆ–ç±»å‹æ³¨è§£ä¸­å†™è¿™ä¸ªæ˜¯ååˆ†ç¹çä¸”å†—é•¿çš„ï¼š

```rust
let f: Box<dyn Fn() + Send + 'static> = Box::new(|| println!("hi"));
fn takes_long_type(f: Box<dyn Fn() + Send + 'static>) {}
fn returns_long_type() -> Box<dyn Fn() + Send + 'static> {}
```

é€šè¿‡ç±»å‹åˆ«åç®€åŒ–åï¼š

```rust
type Thunk = Box<dyn Fn() + Send + 'static>;
let f: Thunk = Box::new(|| println!("hi"));
fn takes_long_type(f: Thunk) {}
fn returns_long_type() -> Thunk {}
```

ç±»å‹åˆ«åä¹Ÿå¸¸ä¸ `Result<T, E>` ç»“åˆä½¿ç”¨æ¥å‡å°‘é‡å¤ã€‚

```rust
type Result<T> = std::result::Result<T, Box<dyn std::error::Error>>;

fn inverse_number(num: f64) -> Result<f64> {
    if num == 0.0 {
        Err(Box::new(std::io::Error::new(
            std::io::ErrorKind::InvalidInput,
            "Cannot divide by zero",
        )))
    } else {
        Ok(1.0 / num)
    }
}
```

å…ƒç»„ç»“æ„ä½“å’Œå•å…ƒç»“æ„ä½“çš„ç±»å‹åˆ«å**ä¸èƒ½ç”¨äºå……å½“è¯¥ç±»å‹çš„æ„é€ å‡½æ•°**ã€‚

```rust
struct MyStruct(i32);
use MyStruct as UseAlias;
type TypeAlias = MyStruct;

fn main() {
    let _ = UseAlias(5);
    let _ = TypeAlias(5); // é”™è¯¯
}
```

## å­—ç¬¦ä¸²

Rust ä¸­ä¸»è¦æœ‰ `str` å’Œ `String` ä¸¤ç§å­—ç¬¦ä¸²ç±»å‹ï¼Œå…¶ä¸­ `str` æ˜¯åŸç”Ÿç±»å‹ï¼Œå­˜å‚¨åœ¨æ ˆä¸Šï¼Œ`String` å­˜å‚¨åœ¨å †ä¸Šã€‚è¿™ä¸¤ç§å€¼çš„è¡¨ç¤ºæ–¹æ³•ä¸ `[u8]` ç›¸åŒï¼Œä¸”éƒ½ä¿è¯æ•°æ®æ˜¯æœ‰æ•ˆçš„ UTF-8 åºåˆ—ã€‚ç”±äº `str` æ˜¯ä¸€ä¸ª DSTï¼Œå…·æœ‰ `?Sized`ï¼Œå› æ­¤åªèƒ½é€šè¿‡æŒ‡é’ˆç±»å‹é—´æ¥ä½¿ç”¨ï¼Œå¦‚ `&str` å’Œ `Box<str>`ã€‚

```rust
let s1: &str = "foo";  // å®é™…ä¸Šä¼šè¢«æ¨æ–­ä¸º &'static str
let s2: &'static str = "bar";
let s3: String = String::from("haha");
let s4: &str = &s3;
let s5: Box<str> = String::from("hehe").into_boxed_str();
```

`&str` å’Œ `String`ï¼š

- `&str`ï¼šä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œè¡¨ç¤ºå¯¹æŸä¸ªå­—ç¬¦ä¸²æ•°æ®çš„ä¸å¯å˜å¼•ç”¨
- `String`ï¼šåœ¨å †ä¸Šåˆ†é…çš„å­—ç¬¦ä¸²

`&str` å’Œ `&'static str`ï¼š

- ä¸æ˜¯æ‰€æœ‰çš„ `&str` éƒ½æ˜¯ `&'static str`ã€‚ä¸€ä¸ªå­—ç¬¦ä¸²å­—é¢é‡å¦‚ `"hello"`ï¼Œåˆ™é»˜è®¤å…·æœ‰ `'static` ç”Ÿå‘½å‘¨æœŸ
- è‹¥ä» `String` åˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡ï¼Œè¯¥åˆ‡ç‰‡çš„ç”Ÿå‘½å‘¨æœŸåˆ™ä¸æ˜¯ `'static`

å¤§å¤šæ•°æ—¶å€™ï¼Œå¯ä»¥ä¸ç”¨æ˜¾å¼æ ‡æ³¨ `&str` æˆ– `&'static str`ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ¨æ–­ç”Ÿå‘½å‘¨æœŸã€‚

### åŸå§‹å­—ç¬¦ä¸²

ä»¥ `r` æˆ– `r#` çš„å½¢å¼æ¥è¡¨ç¤ºåŸå§‹å­—ç¬¦ä¸²ï¼Œä¸ä¼šå¯¹å­—ç¬¦è¿›è¡Œè½¬ä¹‰ã€‚

```rust
let s = r"foo\t\nbar";
let s1 = r#"foo\t\nbar"#;
let s2 = r##"foo\t\nbar"##;
let s3 = r###"foo\t\nbar"###;
```

å½“ä½¿ç”¨ `r#` çš„å½¢å¼æ—¶ï¼Œéœ€è¦ç¡®ä¿å‰å `#` çš„æ•°é‡æ˜¯ä¸€è‡´çš„ã€‚

### C å­—ç¬¦ä¸²

ä» Rust 1.77 å¼€å§‹ï¼Œä¹Ÿæ”¯æŒ `c"foo"` å½¢å¼çš„ C é£æ ¼å­—ç¬¦ä¸²ï¼Œå…¶ä»¥ `\0` ç»“æŸï¼Œå®é™…ä¸Šæ˜¯ `&'static std::ffi::CStr` ç±»å‹ã€‚

```rust
let s = c"foo"; // &'static CStr;
assert_eq!(4, std::mem::size_of_val(s));
```

åŸå§‹å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥å’Œç‰¹å®šæ ¼å¼å­—ç¬¦ä¸²ç»„åˆï¼š

```rust
let s1 = cr"foo\t\nbar";
let s2 = cr#"foo\t\nbar"#;
let s3 = br"foo\t\nbar";
let s4 = br#"foo\t\nbar"#;
```

## è¯­å¥å’Œè¡¨è¾¾å¼

Rust æ˜¯ä¸€ç§åŸºäºè¡¨è¾¾å¼çš„è¯­è¨€ï¼Œæ±‚å€¼éƒ½é€šè¿‡è¡¨è¾¾å¼å®Œæˆã€‚è¡¨è¾¾å¼å¯å†…åµŒåˆ°å¦ä¸€ä¸ªè¡¨è¾¾å¼ä¸­ï¼Œæ±‚å€¼è§„åˆ™åŒ…æ‹¬æŒ‡å®šè¡¨è¾¾å¼äº§ç”Ÿçš„å€¼å’ŒæŒ‡å®šå…¶å„ä¸ªå­è¡¨è¾¾å¼çš„æ±‚å€¼é¡ºåºã€‚è¯­å¥åˆ™ä¸»è¦ç”¨äºåŒ…å«è¡¨è¾¾å¼ï¼Œä»¥åŠæ˜¾å¼å®‰æ’è¡¨è¾¾å¼çš„æ±‚å€¼é¡ºåºã€‚è¡¨è¾¾å¼å’Œè¯­å¥çš„æ˜¾è‘—åŒºåˆ«ï¼šè¡¨è¾¾å¼**è®¡ç®—å¹¶äº§ç”Ÿä¸€ä¸ªå€¼**ï¼Œè¯­å¥æ‰§è¡Œæ“ä½œä½†**ä¸è¿”å›å€¼**ã€‚

### å£°æ˜è¯­å¥

å£°æ˜è¯­å¥æ˜¯åœ¨å…¶å°é—­è¯­å¥å—å†…éƒ¨å¼•å…¥ä¸€ä¸ªæˆ–å¤šä¸ªåç§°çš„è¯­å¥ï¼ŒåŒ…å«ä¸¤ç§ï¼šç¨‹åºé¡¹å£°æ˜å’Œ `let` å£°æ˜ã€‚

#### ç¨‹åºé¡¹å£°æ˜

ç¨‹åºé¡¹å£°æ˜è¯­å¥ä¸ä¼šéšå¼æ•è·å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„å‡½æ•°å‚æ•°ã€æ³›å‹å‚æ•°å’Œå±€éƒ¨å˜é‡ã€‚

```rust
fn foo(a: i32) {
    let v = a + 1;

    fn bar() {
        a + v;  // é”™è¯¯ï¼Œå‚æ•° a å’Œå±€éƒ¨å˜é‡ v éƒ½ä¸èƒ½è¢«æ•è·
    }
}
```

#### let å£°æ˜

`let` è¯­å¥é€šè¿‡ä¸å¯åé©³çš„æ¨¡å¼å¼•å…¥äº†ä¸€ç»„æ–°çš„å˜é‡ã€‚é™¤éè¢«å¦ä¸€ä¸ªå˜é‡å£°æ˜éšè—ï¼Œå¦åˆ™ä»»ä½•å˜é‡ä»å£°æ˜ç‚¹åˆ°å°é—­å—ä½œç”¨åŸŸçš„ç»“æŸéƒ½æ˜¯å¯è§çš„ã€‚`let` è¿˜é€šè¿‡**ç»‘å®š**ä½¿å€¼å’Œå˜é‡å…³è”èµ·æ¥ï¼Œä»»ä½•å€¼åªæœ‰è¢«ç»‘å®šåï¼Œæ‰èƒ½ç»§ç»­å­˜åœ¨ï¼Œå¦åˆ™å…¶**ç”Ÿå‘½å‘¨æœŸä¼šåœ¨å½“å‰è¯­å¥ç»“æŸæ—¶ç»“æŸ**ã€‚

### è¡¨è¾¾å¼è¯­å¥

è¡¨è¾¾å¼è¯­å¥æ˜¯å¯¹è¡¨è¾¾å¼æ±‚å€¼å¹¶å¿½ç•¥å…¶ç»“æœçš„è¯­å¥ã€‚

```rust
1 + 2;  // å¿½ç•¥è®¡ç®—å€¼
```

### è¯­å¥å±æ€§

è¯­å¥å¯ä»¥æœ‰å¤–éƒ¨å±æ€§ï¼Œåœ¨è¯­å¥ä¸­æœ‰æ„ä¹‰çš„å±æ€§æ˜¯ `cfg` å’Œ lint æ£€æŸ¥å±æ€§ã€‚

```rust
#[cfg(target_os = "windows")]
#[allow(unused)]
let greet = "Hello Windows!";

#[cfg(target_os = "linux")]
let greet = "Hello Linux!";
```

### æ§åˆ¶æµè¡¨è¾¾å¼

Rust ä¸­æœ‰ 4 ä¸­æ§åˆ¶æµè¡¨è¾¾å¼ï¼š`if`ã€`loop`ã€`while` å’Œ `for`ï¼Œå…¶ä¸­çš„æ¡ä»¶**å¿…é¡»æ˜¯ `bool` å€¼**ã€‚

`if` ç”¨äºæ§åˆ¶åˆ†æ”¯ï¼Œå¯ä¸ `else` æ­é…ä½¿ç”¨ã€‚

```rust
let mut x = 10;
x = if x < 3 {
    x + 1
} else if x < 6 {
    x + 2
} else {
    x + 3
};
```

`loop` ç”¨äºæ— é™å¾ªç¯ï¼Œ`while` ç”¨äºæ¡ä»¶å¾ªç¯ï¼Œ`for` ç”¨äºéå†ï¼Œ`break` ç”¨äºæå‰è·³å‡ºå¾ªç¯ï¼Œ`continue` ç”¨äºæå‰ç»“æŸæœ¬æ¬¡å¾ªç¯ã€‚ç”±äº `loop` é»˜è®¤è¿”å›ä¸€ä¸ª `!`ï¼Œå› æ­¤**åªæœ‰ `loop` èƒ½å¤Ÿä½¿ç”¨ `break + <value>` çš„å½¢å¼æ¥è¿”å›ä¸€ä¸ªå€¼**ã€‚

```rust
// loop
let mut x = 0;
let y = loop {
    x = x + 1;
    if x > 10 {
        break x;
    }
};

// while
let arr = [1, 2, 3];
let mut i = 0;
while i < arr.len() {
    println!("{}", arr[i]);
    i += 1;
}

// for
for e in 1..4 {
    println!("{e}");
}
```

`break` å’Œ `continue` åªèƒ½ç”¨äºå†…å±‚å¾ªç¯ï¼Œä½¿ç”¨ `'` + `æ ‡è¯†ç¬¦` çš„å½¢å¼å®šä¹‰ä¸€ä¸ª**å¾ªç¯æ ‡ç­¾**ï¼Œåˆ™å¯ä½œç”¨äºå¤–å±‚å¾ªç¯ã€‚

```rust
'out: loop {
    loop {
        println!("Do this");
        break 'out;
    }
    println!("Never do");
}
println!("Do this after loop");
```

### å…¶å®ƒè¡¨è¾¾å¼

Rust ä¸­çš„è¡¨è¾¾å¼æœ‰å¾ˆå¤šç§ï¼Œä¸»è¦æœ‰ï¼š

- å­—é¢é‡è¡¨è¾¾å¼
- è·¯å¾„è¡¨è¾¾å¼
- å—è¡¨è¾¾å¼
- è¿ç®—ç¬¦è¡¨è¾¾å¼
- ç»“æ„ä½“è¡¨è¾¾å¼
- è°ƒç”¨è¡¨è¾¾å¼
- é—­åŒ…è¡¨è¾¾å¼
- åŒºé—´è¡¨è¾¾å¼
- æ¨¡å¼åŒ¹é…è¡¨è¾¾å¼
- è¿”å›è¡¨è¾¾å¼
- å¼‚æ­¥è¡¨è¾¾å¼
- ...

> æ›´å¤šå…³äºè¡¨è¾¾å¼çš„ä¿¡æ¯ï¼Œå¯å‚è€ƒ [Expressions](https://doc.rust-lang.org/nightly/reference/expressions.html)ã€‚

# 2 æ‰€æœ‰æƒ

## æ‰€æœ‰æƒè§„åˆ™

æ‰€æœ‰æƒæ˜¯ Rust ç”¨æ¥ç®¡ç†å†…å­˜çš„æœºåˆ¶ã€‚

- æ¯ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ª**æ‰€æœ‰è€…**
- å€¼**æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª**æ‰€æœ‰è€…
- å½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒ

### ä½œç”¨åŸŸ

ä½œç”¨åŸŸæ˜¯é¡¹åœ¨ç¨‹åºä¸­æœ‰æ•ˆçš„èŒƒå›´ã€‚

```rust
let s1 = "foo";       // s1 ç”Ÿæ•ˆ
{                     // ä½œç”¨åŸŸå¼€å§‹
    let s2 = "bar";   // s2 ç”Ÿæ•ˆ
}                     // ä½œç”¨åŸŸç»“æŸï¼Œs2 æ— æ•ˆï¼Œs1 æœ‰æ•ˆ
```

å½“å˜é‡è¿›å…¥ä½œç”¨åŸŸæ—¶ï¼Œå°±æ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸€ç›´æŒç»­åˆ°ç¦»å¼€ä½œç”¨åŸŸä¸ºæ­¢ã€‚å˜é‡æŒ‰å…¶å®šä¹‰çš„ç›¸åé¡ºåºä¸¢å¼ƒï¼Œç»“æ„ä½“å’Œå…ƒç»„çš„å­—æ®µæŒ‰å…¶å®šä¹‰çš„é¡ºåºä¸¢å¼ƒã€‚

### å †ä¸Šçš„æ•°æ®

åœ¨ç¼–è¯‘æ—¶å°±çŸ¥é“çš„å¤§å°çš„æ•°æ®é€šå¸¸æ”¾åœ¨æ ˆä¸Šï¼Œè€Œå˜åŒ–çš„æˆ–è¿è¡Œæ—¶æ‰çŸ¥é“å¤§å°çš„æ•°æ®é€šå¸¸æ”¾åœ¨å †ä¸Šã€‚`String` ç±»å‹å°±æ˜¯ä¸€ç§æ”¾åœ¨å †ä¸Šçš„æ•°æ®ã€‚

```rust
let mut s = String::from("foo");
s.push_str("bar");
```

`&str` åœ¨ç¼–è¯‘æ—¶å°±çŸ¥é“å…¶å†…å®¹ï¼Œè¢«ç›´æ¥ç¡¬ç¼–ç è¿›äºŒè¿›åˆ¶æ–‡ä»¶çš„åªè¯»åŒºå—ä¸­ï¼Œå› æ­¤æ•ˆç‡é«˜ï¼Œä½†ä¸å¯å˜ã€‚

å¯¹äº `String` ç±»å‹ï¼Œä¸ºäº†æ”¯æŒä¸€ä¸ªå¯å˜çš„æ–‡æœ¬ç‰‡æ®µï¼Œéœ€è¦åœ¨å †ä¸Šåˆ†é…ä¸€å—åœ¨ç¼–è¯‘æ—¶æœªçŸ¥å¤§å°çš„å†…å­˜æ¥å­˜æ”¾å†…å®¹ï¼Œè¿™éœ€è¦ï¼š

- åœ¨è¿è¡Œæ—¶å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜
- åœ¨å¤„ç†å®Œåé‡Šæ”¾å†…å­˜çš„æ–¹æ³•

åœ¨æœ‰åƒåœ¾å›æ”¶çš„è¯­è¨€ä¸­ï¼Œ GC ç®¡ç†è¿™éƒ¨åˆ†å†…å­˜ï¼Œåœ¨æ²¡æœ‰ GC çš„è¯­è¨€ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†ã€‚æå‰é‡Šæ”¾å’Œé‡å¤é‡Šæ”¾éƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼Œè¿™éœ€è¦ç²¾ç¡®é…å¯¹æ¯ä¸€ä¸ªç”³è¯·å’Œé‡Šæ”¾ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œè¿™ç§é—®é¢˜ä¼šæ›´ä¸¥é‡ã€‚

æ‰€æœ‰æƒçš„ç­–ç•¥ä¸ºï¼š**å˜é‡ç¦»å¼€ä½œç”¨åŸŸåå†…å­˜å°±è‡ªåŠ¨é‡Šæ”¾**ã€‚

```rust
{
    let s = String::from("foo");  // s ä»æ­¤å¤„å¼€å§‹ç”Ÿæ•ˆ
}                                 // s æ— æ•ˆ
```

å½“å˜é‡ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œåœ¨ç»“å°¾çš„ `}` å¤„å°†è‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•° `drop` é‡Šæ”¾å†…å­˜ã€‚

> åœ¨ C++ ä¸­ï¼Œè¿™ç§åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶é‡Šæ”¾**èµ„æº**çš„æ¨¡å¼è¢«ç§°ä½œ RAIIï¼ˆResource Acquisition Is Initializationï¼Œèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰ã€‚èµ„æºå¯ä»¥æ˜¯å†…å­˜åœ°å€ï¼ŒåŒ…å«æŸä¸ªå€¼çš„å˜é‡ã€å…±äº«å†…å­˜å¼•ç”¨ã€æ–‡ä»¶å¥æŸ„ã€ç½‘ç»œå¥—æ¥å­—æˆ–æ•°æ®åº“è¿æ¥å¥æŸ„ç­‰ã€‚

### ç§»åŠ¨è¯­ä¹‰

Rust ä¸­çš„å¤šä¸ªå˜é‡å¯ä»¥é‡‡ç”¨ä¸€ç§ç‹¬ç‰¹çš„æ–¹å¼ä¸åŒä¸€æ•°æ®äº¤äº’ã€‚

```rust
let x = 5;
let y = x;
let s1 = String::from("hello");
let s2 = s1;
```

`x` å’Œ `y` éƒ½æ˜¯å›ºå®šå¤§å°ç±»å‹ï¼Œç›´æ¥å­˜æ”¾åœ¨æ ˆä¸Šï¼Œå› æ­¤ `y` å¤åˆ¶äº† `x`ã€‚å¯¹äº `String`ï¼Œ`s2` å¹¶ä¸ä¼šå¤åˆ¶ `s1`ã€‚

`String` ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š**æŒ‡å‘å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€é•¿åº¦å’Œå®¹é‡**ã€‚è¿™ä¸€ç»„æ•°æ®å­˜å‚¨åœ¨æ ˆä¸Šï¼Œå †ä¸Šåˆ™å­˜æ”¾å­—ç¬¦ä¸²çš„å†…å®¹ã€‚

![String åœ¨å†…å­˜ä¸­çš„è¡¨ç¤º](https://raw.githubusercontent.com/genskyff/image-hosting/main/images/202203232352837.png)

å½“æŠŠ `s1` èµ‹å€¼ç»™ `s2` æ—¶ï¼Œ`String` åœ¨æ ˆä¸Šçš„æ•°æ®è¢«å¤åˆ¶äº†ï¼Œè€Œå †ä¸Šçš„æ•°æ®æ²¡æœ‰å¤åˆ¶ã€‚åªå¤åˆ¶æŒ‡é’ˆã€é•¿åº¦å’Œå®¹é‡è¿™äº›æ ˆä¸Šçš„æ•°æ®å¯çœ‹åš**æµ…æ‹·è´**ï¼Œè€ŒæŠŠæ ˆå’Œå †ä¸Šçš„æ•°æ®éƒ½è¿›è¡Œå¤åˆ¶å¯çœ‹åš**æ·±æ‹·è´**ã€‚Rust ä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®çš„æ·±æ‹·è´ï¼Œå› æ­¤ä»»ä½•è‡ªåŠ¨çš„å¤åˆ¶å¯ä»¥è¢«è®¤ä¸ºå¯¹è¿è¡Œæ—¶æ€§èƒ½å½±å“è¾ƒå°ã€‚

![s1 å’Œ s2 æŒ‡å‘åŒä¸€å—å †å†…å­˜](https://raw.githubusercontent.com/genskyff/image-hosting/main/images/202203240158188.png)

æŒ‰ç…§æ‰€æœ‰æƒè§„åˆ™ï¼Œå½“å˜é‡ç¦»å¼€ä½œç”¨åŸŸåï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•°ï¼Œä½† `s1` å’Œ `s2` éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªå †å†…å­˜ï¼Œè¿™å°±ä¼šå¯¼è‡´äºŒæ¬¡é‡Šæ”¾ã€‚ä¸ºäº†ç¡®ä¿å†…å­˜å®‰å…¨ï¼Œè¿™ç§æƒ…å†µä¸‹å°±è®¤ä¸º `s1` ä¸å†æœ‰æ•ˆï¼Œå› æ­¤ `s1` ä¸éœ€è¦åœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶è¿›è¡Œæ¸…ç†ã€‚

```rust
let s1 = String::from("hello");
let s2 = s1;        // s1 å¤±æ•ˆ
println!("{s1}");   // é”™è¯¯
```

è¿™ç§è¡Œä¸ºå¯ä»¥çœ‹ä½œ `s1` è¢«ç§»åŠ¨åˆ°äº† `s2` ä¸­ï¼Œç§°ä¸º**ç§»åŠ¨**ã€‚å½“æŒæœ‰å †ä¸­æ•°æ®çš„å˜é‡ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå…¶å€¼å°†é€šè¿‡ `drop` å‡½æ•°è¢«æ¸…ç†æ‰ï¼Œ**é™¤éæ•°æ®è¢«ç§»åŠ¨ä¸ºå¦ä¸€ä¸ªå˜é‡æ‰€æœ‰**ã€‚

### æ˜¾å¼æ·±æ‹·è´

è‹¥ç¡®å®éœ€è¦å¤åˆ¶å †ä¸Šçš„æ•°æ®ï¼Œè€Œä¸ä»…ä»…æ˜¯æ ˆä¸Šçš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ `clone`ã€‚

```rust
let s1 = String::from("foo");
let s2 = s1.clone();
println!("{s1}, {s2}");
```

ç”±äº `clone` éœ€è¦å¤åˆ¶å †ä¸Šçš„æ•°æ®ï¼Œå› æ­¤ä¼šå½±å“è¿è¡Œæ—¶æ€§èƒ½ã€‚

### Copy å’Œ Clone

ä»»ä½•èƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸå°±çŸ¥é“å¤§å°çš„ç±»å‹ï¼Œéƒ½å…·æœ‰ `Copy`ï¼Œåœ¨èµ‹å€¼æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œå¤åˆ¶ï¼Œå…·æœ‰å¤åˆ¶è¯­ä¹‰ï¼Œå¦‚åŸºæœ¬ç±»å‹ã€å‡½æ•°ç±»å‹ã€å‡½æ•°æŒ‡é’ˆã€æ²¡æœ‰æ•è·å€¼æˆ–æ•è·çš„å€¼å…·æœ‰ `Copy` çš„é—­åŒ…ã€‚è€Œåœ¨å †ä¸Šçš„æ•°æ®åˆ™ä¸å…·æœ‰ `Copy`ï¼Œä½†å¯èƒ½å…·æœ‰ `Clone`ï¼Œå¯ä»¥æ˜¾å¼è°ƒç”¨ `clone` è¿›è¡Œæ·±æ‹·è´ã€‚åŒæ—¶ä»»ä½•å®ç°äº† `Drop` çš„ç±»å‹ä¹Ÿä¸èƒ½å…·æœ‰ `Copy`ã€‚

å¯¹äºæŒ‡é’ˆç±»å‹ï¼Œæ‰€æœ‰çš„ `&T` å’Œ `*const T` éƒ½å…·æœ‰ `Copy`ï¼Œè€Œ `&mut T` å’Œ `*mut T` åˆ™ä¸å…·æœ‰ã€‚

### æ‰€æœ‰æƒä¸å‡½æ•°

å°†å€¼ä¼ é€’ç»™å‡½æ•°åœ¨è¯­ä¹‰ä¸Šä¸ç»™å˜é‡èµ‹å€¼ç±»ä¼¼ï¼Œå‘å‡½æ•°ä¼ é€’å€¼å¯èƒ½ä¼šç§»åŠ¨æˆ–å¤åˆ¶ã€‚

```rust
fn print_number(n: i32) {
    println!("{n}");
}   // n è¢«ç§»å‡ºä½œç”¨åŸŸ

fn print_string(s: String) { // s ä½œç”¨åŸŸå¼€å§‹
    println!("{s}");
}   // s è¢«ç§»å‡ºä½œç”¨åŸŸå¹¶è°ƒç”¨ drop å‡½æ•°

fn main() {
    let n = 1;
    let s = String::from("foo");
    print_number(n);      // n çš„å€¼ç§»åŠ¨åˆ°å‡½æ•°ä¸­ï¼Œä½† i32 æ˜¯ Copy çš„ï¼Œå¯åœ¨ä¹‹åç»§ç»­ä½¿ç”¨
    print_string(s);      // s çš„å€¼ç§»åŠ¨åˆ°å‡½æ•°ä¸­ï¼Œä¹‹åä¸èƒ½ç»§ç»­ä½¿ç”¨
    println!("{n}");      // n ä¾æ—§æœ‰æ•ˆ
    println!("{s}");      // é”™è¯¯ï¼Œs å·²ç»æ— æ•ˆ
}   // n è¢«ç§»å‡ºä½œç”¨åŸŸï¼Œs çš„å€¼å·²è¢«ç§»èµ°ï¼Œä¸ä¼šè°ƒç”¨ææ„å‡½æ•°
```

### è¿”å›å€¼ä¸ä½œç”¨åŸŸ

è¿”å›å€¼ä¹Ÿå¯ä»¥è½¬ç§»æ‰€æœ‰æƒã€‚

```rust
fn ret() -> String {
    let s = String::from("foo");
    s   // å°† s çš„å€¼ç§»å‡ºï¼Œè¿”å›ç»™è°ƒç”¨å®ƒçš„å‡½æ•°
}

fn take_and_ret(ts: String) -> String {
    ts  // å°† ts çš„å€¼ç§»å‡ºï¼Œè¿”å›ç»™è°ƒç”¨å®ƒçš„å‡½æ•°
}

fn main() {
    let s1 = ret();             // å‡½æ•°å°†è¿”å›å€¼ç§»åŠ¨åˆ° s1
    let s2 = String::from("foo");
    let s3 = take_and_ret(s2);  // s2 çš„å€¼è¢«ç§»åŠ¨åˆ°å‡½æ•°ä¸­ï¼Œå‡½æ•°å°†è¿”å›å€¼ç§»åŠ¨åˆ° s3
}   // s1ã€s3 è¢«ç§»å‡ºä½œç”¨åŸŸï¼Œè°ƒç”¨ææ„å‡½æ•°ï¼Œs2 çš„å€¼å·²è¢«ç§»èµ°ï¼Œä¸ä¼šè°ƒç”¨ææ„å‡½æ•°
```

## å¼•ç”¨å’Œå€Ÿç”¨

### å¼•ç”¨ç±»å‹

ä»¥ä¸€ä¸ªå¯¹è±¡çš„**å¼•ç”¨**ä½œä¸ºå‚æ•°è€Œä¸è·å–å€¼çš„æ‰€æœ‰æƒï¼Œç±»å‹è¡¨ç¤ºä¸º `&T`ï¼Œåˆ›å»ºä¸€ä¸ªå¼•ç”¨çš„è¡Œä¸ºç§°ä¸º**å€Ÿç”¨**ã€‚

```rust
fn str_len(s: &String) -> usize {   // s æ˜¯å¯¹ String çš„å¼•ç”¨
    s.len()
}   // s ç¦»å¼€ä½œç”¨åŸŸï¼Œä½†å®ƒå¹¶ä¸æ‹¥æœ‰å¼•ç”¨å€¼çš„æ‰€æœ‰æƒï¼Œæ‰€ä»¥ä¸ä¼šè°ƒç”¨ææ„å‡½æ•°

fn main() {
    let s1 = String::from("hello");
    let len = str_len(&s1);
    println!("s1: {s1}, len: {len}");
}
```

ä¼ é€’ `&s1` ç»™å‡½æ•°ï¼ŒåŒæ—¶åœ¨å‡½æ•°å®šä¹‰ä¸­ï¼Œè·å– `&String` è€Œä¸æ˜¯ `String`ã€‚`&` è¡¨ç¤ºå¼•ç”¨ï¼Œå…è®¸ä½¿ç”¨å€¼ä½†ä¸è·å–å…¶æ‰€æœ‰æƒã€‚å› ä¸ºå¹¶ä¸æ‹¥æœ‰è¿™ä¸ªå€¼ï¼Œå½“å¼•ç”¨ç¦»å¼€ä½œç”¨åŸŸæ—¶å…¶æŒ‡å‘çš„å€¼ä¹Ÿä¸ä¼šè¢«ä¸¢å¼ƒã€‚å‡½æ•°ç­¾åä½¿ç”¨ `&` æ¥è¡¨æ˜å‚æ•° `s` çš„ç±»å‹æ˜¯ä¸€ä¸ªå¼•ç”¨ã€‚

![å¯¹è±¡çš„å¼•ç”¨](https://raw.githubusercontent.com/genskyff/image-hosting/main/images/202203240005250.png)

å¼•ç”¨å’ŒæŒ‡é’ˆç±»ä¼¼ï¼Œå…¶ä¿å­˜äº†ä¸€ä¸ªåœ°å€ï¼Œå¯ä»¥ç”±æ­¤è®¿é—®å‚¨å­˜äºè¯¥åœ°å€çš„æ•°æ®ï¼Œå¹¶ä¸”ç¡®ä¿æŒ‡å‘çš„å€¼æ˜¯æœ‰æ•ˆçš„ã€‚

> ä¸ `&` ç›¸åçš„æ“ä½œæ˜¯**è§£å¼•ç”¨**ï¼Œä½¿ç”¨è§£å¼•ç”¨è¿ç®—ç¬¦ `*`ã€‚

### åŒºåˆ†å¼•ç”¨å’Œå€Ÿç”¨

`s1` æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå€Ÿç”¨äº†æ¥è‡ª `s` çš„å€¼ï¼Œå³æ¥è‡ª `String` çš„å€Ÿç”¨ï¼Œå› æ­¤ `s1` çš„ç±»å‹ä¸º `&String`ã€‚

```rust
let s = String::new();
let s1 = &s;
```

> é€šå¸¸æƒ…å†µä¸‹å¯ä»¥ä¸ç”¨ä¸¥æ ¼åŒºåˆ†è¿™ä¸¤è€…ã€‚

### å¯å˜å¼•ç”¨

å˜é‡é»˜è®¤æ˜¯ä¸å¯å˜çš„ï¼Œå¼•ç”¨ä¹Ÿä¸€æ ·ï¼Œ**é»˜è®¤ä¸å…è®¸ä¿®æ”¹å¼•ç”¨çš„å€¼**ã€‚

```rust
let s = String::from("foo");
let ps = &s;
ps.push_str("bar");  // é”™è¯¯ï¼Œå¼•ç”¨é»˜è®¤ä¸å¯å˜
```

ä½¿ç”¨ `mut` ä¿®é¥°å˜é‡å’Œå¼•ç”¨ï¼Œå¯ä»¥ä½¿å¼•ç”¨å¯å˜ï¼Œç±»å‹è¡¨ç¤ºä¸º `&mut T`ã€‚

```rust
let mut s = String::from("foo");
let ps = &mut s;
ps.push_str("bar");
```

**`mut` å˜é‡å¯è¢«å¼•ç”¨ä¸º `&` æˆ– `&mut`ï¼Œé `mut` å˜é‡åªèƒ½è¢«å¼•ç”¨ä¸º `&`**ã€‚

```rust
let x = 1;
let mut y = 2;
let rx = &mut x;    // é”™è¯¯ï¼Œé mut å˜é‡åªèƒ½è¢«å¼•ç”¨ä¸º &
let ry = &y;        // æ­£ç¡®ï¼Œå¯ä»¥å¯¹ mut å˜é‡å¼•ç”¨ä¸º &
```

`mut` å˜é‡æŒ‡çš„æ˜¯è¯¥å˜é‡æœ¬èº«æ˜¯å¦å¯å˜ï¼Œ`mut` å¼•ç”¨æŒ‡çš„æ˜¯æ‰€å¼•ç”¨çš„å€¼æ˜¯å¦å¯å˜ã€‚

```rust
let x = 1;
let y = 2;
let mut rx = &x;
rx = &y;    // æ”¹å˜çš„æ˜¯å˜é‡è‡ªèº«

let mut z = 3;
let rz = &mut z;
*rz = 6;    // æ”¹å˜çš„æ˜¯å¼•ç”¨çš„å€¼
```

è‹¥å˜é‡æœ¬èº«çš„ç±»å‹æ˜¯å¼•ç”¨ï¼Œåˆ™ `&` å’Œ `&mut` æ˜¯ä¸¤ç§æ•°æ®ç±»å‹ï¼Œ**å› æ­¤ä¸€ä¸ª `mut` å˜é‡çš„ç±»å‹ä¸èƒ½åœ¨ `&` å’Œ `&mut` ä¹‹é—´åˆ‡æ¢**ã€‚

```rust
let mut x = 1;
let mut y = 2;
let mut rx = &mut x;    // rx çš„ç±»å‹è¢«ç¡®å®šä¸º &mut
rx = &y;                // é”™è¯¯ï¼Œä¸èƒ½å°†ä¸€ä¸ª & ç±»å‹èµ‹å€¼ç»™ rx
let rx = &y;            // æ­£ç¡®ï¼Œå¯ä»¥é€šè¿‡éšè—æ¥æ”¹å˜ rx çš„ç±»å‹
```

**å€¼åœ¨åŒä¸€ä½œç”¨åŸŸå†…æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨**ï¼Œè¿™ä¸ªé™åˆ¶å¯ä»¥é¿å…æ•°æ®ç«äº‰ã€‚

```rust
let mut s = String::from("foo");
let r1 = &mut s;
let r2 = &mut s;    // é”™è¯¯
```

é€šè¿‡åˆ›å»ºæ–°çš„ä½œç”¨åŸŸï¼Œä»¥å…è®¸æ‹¥æœ‰å¤šä¸ªå¯å˜å¼•ç”¨ã€‚

```rust
let mut s = String::from("foo");
{
    let r1 = &mut s;
}   // r1 ç¦»å¼€ä½œç”¨åŸŸï¼Œr2 å¯ä»¥æ‹¥æœ‰ s çš„å¯å˜å¼•ç”¨
let r2 = &mut s;
```

**ä¸èƒ½åœ¨æ‹¥æœ‰ä¸å¯å˜å¼•ç”¨çš„åŒæ—¶æ‹¥æœ‰å¯å˜å¼•ç”¨ï¼Œä½†å¯ä»¥æ‹¥æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨**ã€‚

```rust
let mut s = String::from("foo");
let r1 = &s;
let r2 = &s;
let r3 = &mut s;    // é”™è¯¯ï¼Œå·²æœ‰ä¸å¯å˜å¼•ç”¨
```

ä¸€ä¸ªå¼•ç”¨çš„ä½œç”¨åŸŸä»å£°æ˜çš„åœ°æ–¹å¼€å§‹ä¸€ç›´æŒç»­åˆ°**æœ€åä¸€æ¬¡ä½¿ç”¨ä¸ºæ­¢**ã€‚å¦‚æœ€åä¸€æ¬¡ä½¿ç”¨ä¸å¯å˜å¼•ç”¨åœ¨å£°æ˜å¯å˜å¼•ç”¨ä¹‹å‰ï¼Œæˆ–ä»…åœ¨æœ€åä¸€æ¬¡ä½¿ç”¨å¯å˜å¼•ç”¨**ä¹‹å**ï¼ŒåŸå§‹æ•°æ®æ‰å¯å†æ¬¡è¢«ä¸å¯å˜æˆ–å¯å˜åœ°å€Ÿç”¨ã€‚ç¼–è¯‘å™¨åœ¨ä½œç”¨åŸŸç»“æŸä¹‹å‰åˆ¤æ–­ä¸å†ä½¿ç”¨çš„å¼•ç”¨çš„èƒ½åŠ›ç§°ä¸º**éè¯æ³•ä½œç”¨åŸŸç”Ÿå‘½å‘¨æœŸ**ã€‚

```rust
let mut s = String::from("foo");
let r1 = &s;
let r2 = &s;
println!("{r1}, {r2}");   // æœ€åä¸€æ¬¡ä½¿ç”¨å¼•ç”¨ï¼Œr1ã€r2 ä½œç”¨åŸŸç»“æŸ
let r3 = &mut s;          // å¯ä»¥ä½¿ç”¨
println!("{r3}");
```

åœ¨å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œè¢«å¼•ç”¨çš„å˜é‡æœ¬èº«ä¸å…è®¸æ”¹å˜ï¼Œä¸ç®¡æ˜¯ `&` è¿˜æ˜¯ `&mut`ã€‚

```rust
let mut x = 1;
let rx = &mut x;              // äº¦æˆ–æ˜¯ &x
x = 2;                        // é”™è¯¯ï¼Œä¸å…è®¸ x æœ¬èº«æ”¹å˜
println!("{rx}");
```

### å¤šé‡å¼•ç”¨

`&&T`ï¼šå¯¹ä¸å¯å˜å¼•ç”¨çš„ä¸å¯å˜å¼•ç”¨ã€‚

```rust
let x: i32 = 5;
let y: &i32 = &x;
let z: &&i32 = &y;
```

`&&mut T`ï¼šå¯¹å¯å˜å¼•ç”¨çš„ä¸å¯å˜å¼•ç”¨ï¼Œä¸èƒ½é€šè¿‡è¿™ä¸ªå¼•ç”¨æ”¹å˜åŸå§‹æ•°æ®ï¼Œä½†åŸå§‹æ•°æ®å¯è¢«å…¶å®ƒæ–¹å¼ä¿®æ”¹ã€‚

```rust
let mut x: i32 = 5;
let y: &mut i32 = &mut x;
let z: &&mut i32 = &y;
**z = 10;  // é”™è¯¯
*y = 10;
```

`&mut &T`ï¼šå¯¹ä¸å¯å˜å¼•ç”¨çš„å¯å˜å¼•ç”¨ï¼Œå¯ä»¥æ”¹å˜å¼•ç”¨æœ¬èº«ï¼Œå¦‚æŒ‡å‘å¦ä¸€ä¸ªä¸å¯å˜å¼•ç”¨ï¼Œä½†ä¸èƒ½é€šè¿‡è¯¥å¼•ç”¨ä¿®æ”¹è¢«å¼•ç”¨çš„å€¼ã€‚

```rust
let x: i32 = 5;
let y: i32 = 10;
let mut a: &i32 = &x;
let b: &mut &i32 = &mut a;
*b = &y;
**b = 6;  // é”™è¯¯
```

`&mut &mut T`ï¼šå¯¹å¯å˜å¼•ç”¨çš„å¯å˜å¼•ç”¨ï¼Œæ—¢å¯ä»¥æ”¹å˜å¼•ç”¨æœ¬èº«ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¯¥å¼•ç”¨ä¿®æ”¹è¢«å¼•ç”¨çš„å€¼ã€‚

```rust
let mut x: i32 = 5;
let mut y: &mut i32 = &mut x;
let z: &mut &mut i32 = &mut y;
**z = 10;
```

### å¼•ç”¨è§„åˆ™

- åœ¨ä»»æ„æ—¶åˆ»ï¼Œè¦ä¹ˆä»…æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œè¦ä¹ˆä»…æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä¸å¯å˜å¼•ç”¨
- å¼•ç”¨çš„ä½œç”¨åŸŸæŒç»­åˆ°**æœ€åä¸€æ¬¡ä½¿ç”¨**ä¸ºæ­¢
- å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆ

### æ‚¬å‚å¼•ç”¨

åœ¨æŸäº›è¯­è¨€ä¸­ï¼Œå¯ä»¥åœ¨é‡Šæ”¾å†…å­˜æ—¶ä¿ç•™æŒ‡å‘å®ƒçš„æŒ‡é’ˆä»è€Œé”™è¯¯åœ°ç”Ÿæˆä¸€ä¸ªæ‚¬å‚æŒ‡é’ˆã€‚**æ‚¬å‚æŒ‡é’ˆ**æ˜¯å…¶æŒ‡å‘çš„å†…å­˜å¯èƒ½å·²ç»è¢«åˆ†é…ç»™å…¶å®ƒæ‰€æœ‰è€…ã€‚Rust ç¡®ä¿å¼•ç”¨æ°¸è¿œä¹Ÿä¸ä¼šå˜æˆæ‚¬å‚çŠ¶æ€ï¼š**ç¼–è¯‘å™¨ç¡®ä¿æ•°æ®ä¸ä¼šåœ¨å…¶å¼•ç”¨ä¹‹å‰ç¦»å¼€ä½œç”¨åŸŸ**ã€‚

```rust
fn main() {
    let r = dr();            // å¼•ç”¨æŒ‡å‘æ— æ•ˆçš„ String
}

fn dr() -> &String {        // è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²å¼•ç”¨
    let s = String::from("foo");
    &s                      // é”™è¯¯
}   // s ç¦»å¼€ä½œç”¨åŸŸï¼Œå…¶å†…å­˜å°†è¢«é‡Šæ”¾
```

## åˆ‡ç‰‡ç±»å‹

åˆ‡ç‰‡æ˜¯æ²¡æœ‰æ‰€æœ‰æƒçš„æ•°æ®ç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ç§ DSTï¼Œè®°ä½œ `[T]`ï¼Œå…¶å¼•ç”¨è®°ä½œ `&[T]`ã€‚å®ƒå…è®¸å¼•ç”¨é›†åˆä¸­ä¸€æ®µè¿ç»­çš„å…ƒç´ åºåˆ—ï¼Œè€Œä¸æ˜¯å¼•ç”¨æ•´ä¸ªé›†åˆã€‚ç”±äºåˆ‡ç‰‡åªèƒ½é€šè¿‡å¼•ç”¨ä½¿ç”¨ï¼Œé€šå¸¸ä¸ç”¨ä¸¥æ ¼åŒºåˆ†åˆ‡ç‰‡å’Œåˆ‡ç‰‡çš„å¼•ç”¨ã€‚

### å­—ç¬¦ä¸²åˆ‡ç‰‡

å­—ç¬¦ä¸²åˆ‡ç‰‡æ˜¯å¯¹ `String` æˆ– `str` ä¸­ä¸€éƒ¨åˆ†å€¼çš„å¼•ç”¨ï¼Œè®°ä½œ `&str`ã€‚å®é™…ä¸Š `str` å°±æ˜¯ä¸€ä¸ªç±»å‹ä¸º `[u8]` çš„åŠ¨æ€å¤§å°ç±»å‹ï¼Œè€Œ `&str` å°±æ˜¯ä¸€ä¸ª `&[u8]`ã€‚å’Œé€šå¸¸çš„ `[u8]` æˆ– `&[u8]` çš„åŒºåˆ«ä¸ºï¼Œ`&str` ä¿è¯å…¶ä¸­çš„å€¼ä¸ºåˆæ³•çš„ UTF-8 ç¼–ç ï¼Œæ‰€ä»¥ä¹Ÿå¯çœ‹ä½œä¸€ä¸ª `[char]` æˆ– `&[char]`ã€‚

```rust
let s = String::from("hello world");
let s1 = &s[0..5];
let s2 = &s[6..=10];
```

`..` ä¸º**åŒºé—´è¡¨è¾¾å¼**ï¼Œ`=` è¡¨ç¤ºé—­åŒºé—´ã€‚`s1` å°†å¼•ç”¨æ•´ä¸ª `String` ä¸­ç´¢å¼•å€¼ä¸º `[0..5]` éƒ¨åˆ†ã€‚å®ƒä¸æ˜¯å¯¹æ•´ä¸ª `String` çš„å¼•ç”¨ï¼Œè€Œæ˜¯å¯¹éƒ¨åˆ† `String` çš„å¼•ç”¨ã€‚

![å­—ç¬¦ä¸²åˆ‡ç‰‡](https://raw.githubusercontent.com/genskyff/image-hosting/main/images/202203240457604.png)

å­—ç¬¦ä¸²åˆ‡ç‰‡çš„ç´¢å¼•å¿…é¡»ä½äºæœ‰æ•ˆçš„ UTF-8 å­—ç¬¦è¾¹ç•Œå†…ï¼Œè‹¥å°è¯•ä»ä¸€ä¸ªå¤šå­—èŠ‚å­—ç¬¦çš„ä¸­é—´ä½ç½®åˆ›å»ºå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œåˆ™ä¼š panicã€‚

```rust
let s = String::from("ä½ å¥½");
let s1 = &s[0..3];
let s2 = &s[0..2];   // panicï¼ŒUTF-8 ä¸­æ±‰å­—å  3 ä¸ªå­—èŠ‚
```

å¯¹äºåŒºé—´è¡¨è¾¾å¼ï¼Œè‹¥ä»ç´¢å¼• 0 å¼€å§‹æˆ–åˆ°å°¾éƒ¨ç»“æŸï¼Œå¯ä»¥ä¸å†™ä¸¤ä¸ªç‚¹å·ä¹‹å‰æˆ–ä¹‹åçš„å€¼ã€‚

```rust
let s1 = &s[..5];
let s2 = &s[6..];
let s3 = &s[..];    // è·å–æ•´ä¸ªå­—ç¬¦ä¸²çš„åˆ‡ç‰‡
```

#### å­—ç¬¦ä¸²å­—é¢å€¼å°±æ˜¯åˆ‡ç‰‡

å­—ç¬¦ä¸²å­—é¢å€¼è¢«å‚¨å­˜åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œå› æ­¤å®ƒå°±æ˜¯ä¸€ä¸ªåˆ‡ç‰‡ã€‚

```rust
let s = "foo";
```

è¿™é‡Œ `s` çš„ç±»å‹æ˜¯ `&str`ï¼šå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘äºŒè¿›åˆ¶æ–‡ä»¶ç‰¹å®šä½ç½®çš„åˆ‡ç‰‡ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå­—ç¬¦ä¸²å­—é¢å€¼æ˜¯ä¸å¯å˜çš„ã€‚

#### å­—ç¬¦ä¸²åˆ‡ç‰‡ä½œä¸ºå‚æ•°

å¯¹äºä¸€ä¸ªæ¥å— `&String` å‚æ•°çš„å‡½æ•°ï¼š

```rust
fn foo(s: &String) {}
```

å¯ä»¥æ”¹ä¸ºæ¥å— `&str`ï¼š

```rust
fn foo(s: &str) {}
```

è¿™æ ·å¯ä»¥å¯¹ `String` å€¼å’Œ `&str` å€¼ä½¿ç”¨ç›¸åŒçš„å‡½æ•°ï¼Œä½¿ API æ›´åŠ é€šç”¨ã€‚

```rust
let s1 = String::from("foo");
let s2 = "bar";

foo(&s1);
foo(&s1[..]);
foo(s2);
foo(&s2[..]);
```

### å…¶å®ƒåˆ‡ç‰‡ç±»å‹

é™¤äº†å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œä»»ä½• `&[T]` éƒ½æ˜¯åˆ‡ç‰‡ï¼Œå¦‚ `&[i32]`ã€‚

```rust
let arr = [1, 2, 3, 4, 5];
let slice = &arr[1..3];
assert_eq!(slice, &[2, 3]);
```

### åˆ‡ç‰‡æ–¹æ³•

å¸¸è§åˆ‡ç‰‡æ–¹æ³•ï¼š

- `chunks`ã€`concat`ã€`contains`ã€`flatten`ã€`to_vec`
- `first`ã€`last`
- `start_with`ã€`end_with`ã€`fill`ã€`fill_with`
- `strip_prefix`ã€`strip_suffix`
- `get`ã€`swap`ã€`join`ã€`len`
- `repeat`ã€`reverse`ã€`windows`
- `is_ascii`ã€`is_empty`ã€`is_sorted`
- `make_ascii_lowercase`ã€`make_ascii_uppercase`
- `to_ascii_lowercase`ã€`to_ascii_uppercase`
- `rotate_left`ã€`rotate_right`
- `sort`ã€`sort_by`
- `split`ã€`split_at`ã€`splitn`

> æ›´å¤šå…³äºåˆ‡ç‰‡çš„æ–¹æ³•ï¼Œå¯å‚è€ƒ [slice - Rust](https://doc.rust-lang.org/std/primitive.slice.html#implementations)ã€‚

# 3 è‡ªå®šä¹‰ç±»å‹

## ç»“æ„ä½“

### ç»“æ„ä½“å®šä¹‰

ç»“æ„ä½“æ˜¯ä¸€ç§**ç§¯ç±»å‹**ï¼ˆProduct typeï¼‰ï¼Œé€šè¿‡ `struct` å®šä¹‰ã€‚æ²¡æœ‰ä»»ä½•å­—æ®µçš„ä¸º**å•å…ƒç»“æ„ä½“**ï¼Œé€šå¸¸ç”¨äºä¸å­˜å‚¨æ•°æ®ä»…å®ç°æŸä¸ª trait æ—¶ä½¿ç”¨ã€‚æ²¡æœ‰å­—æ®µååªæœ‰ç±»å‹çš„ä¸º**å…ƒç»„ç»“æ„ä½“**ã€‚

```rust
struct User {
    name: String,
    age: u8,
}

struct U;
struct Rgb(u8, u8, u8);

fn main() {
    let mut user1 = User {
        name: String::from("Alice"),
        age: 18
    };

    let user2 = User {
        name: String::from("Bob"),
        ..user1
    };

    let u = [U, U {}];
    let color = Rgb(255, 255, 255);

    user1.age = 20;
}
```

åœ¨åˆå§‹åŒ–ç»“æ„ä½“æ—¶ï¼Œå¯ä»¥ä½¿ç”¨**ç»“æ„ä½“æ›´æ–°è¯­æ³•** `..`ï¼Œæ¥æŒ‡å®šå‰©ä½™æœªæ˜¾å¼è®¾ç½®å€¼çš„å­—æ®µä¸ç»™å®šå®ä¾‹å¯¹åº”å­—æ®µçš„å€¼ç›¸åŒï¼Œä½†è‹¥ç»™å®šå®ä¾‹ä¸­çš„è¿™äº›å¯¹åº”å­—æ®µæ²¡æœ‰å®ç° `Copy`ï¼Œåˆ™ä¼šå‘ç”Ÿç§»åŠ¨ã€‚

å½“ä½¿ç”¨å˜é‡æ¥è¿›è¡Œåˆå§‹åŒ–æ—¶ï¼Œè‹¥å˜é‡åä¸å­—æ®µåç›¸åŒï¼Œåˆ™å¯ä½¿ç”¨**å­—æ®µåˆå§‹åŒ–ç®€å†™è¯­æ³•**ã€‚

```rust
fn new(name: String, age: u8) -> User {
    User {
        name,
        age
    }
}
```

### æ‰€æœ‰æƒ

ç»“æ„ä½“ä¸æ˜¯æ ‡é‡ç±»å‹ï¼Œæ²¡æœ‰å®ç° `Copy`ï¼Œå› æ­¤ç›´æ¥èµ‹å€¼ä¼šå‘ç”Ÿç§»åŠ¨ã€‚

```rust
struct Foo;

fn main() {
    let s1 = Foo;
    let s2 = s;    // s1 è¢«ç§»åŠ¨åˆ° s2
}
```

## æšä¸¾

### æšä¸¾å®šä¹‰

æšä¸¾æ˜¯ä¸€ç§**å’Œç±»å‹**ï¼ˆSum typeï¼‰ï¼Œé€šè¿‡åˆ—ä¸¾å¯èƒ½çš„**å˜ä½“**æ¥å®šä¹‰ä¸€ä¸ªç±»å‹ã€‚åœ¨ Rust ä¸­ï¼Œæšä¸¾æ˜¯ä¸€ç§æ ‡ç­¾è”åˆä½“ã€‚

```rust
enum IpKind {
    V4,
    V6
}
```

æšä¸¾å˜ä½“æ‹¥æœ‰éšå¼çš„ä» 0 å¼€å§‹çš„æ•´æ•°å€¼ï¼Œå¯ä»¥é€šè¿‡ `as` æ¥è¿›è¡Œç±»å‹è½¬æ¢ï¼Œä¹Ÿå¯ä»¥æ˜¾å¼æŒ‡å®šå€¼ï¼š

```rust
// éšå¼å€¼ï¼Œä» 0 å¼€å§‹
enum Number {
    Zero,
    One,
    Two
}

// æ˜¾å¼å€¼
enum Color {
    Red = 0xff0000,
    Green = 0x00ff00,
    Blue = 0x0000ff
}

fn main() {
    println!("Zero is {}", Number::Zero as i32);
    println!("One is {}", Number::One as i32);

    println!("Red are #{:06x}", Color::Red as i32);
    println!("Blue are #{:06x}", Color::Blue as i32);
}
```

æšä¸¾å˜ä½“è¿˜å¯ä»¥å…³è”ä¸åŒç±»å‹çš„å€¼ï¼š

```rust
enum IpKind {
    V4(u8, u8, u8, u8),
    V6(String)
}

let home = IpKind::V4(127, 0, 0, 1);
let loopback = IpKind::V6(String::from("::1"));
```

**è¿™æ ·å®šä¹‰çš„æšä¸¾å˜ä½“çš„åå­—ä¹Ÿå˜æˆäº†ä¸€ä¸ªæ„å»ºæšä¸¾å®ä¾‹çš„æ„é€ å‡½æ•°**ï¼Œå³ `IpAddr::V4()` æ˜¯ä¸€ä¸ªè·å– `String` å‚æ•°å¹¶è¿”å› `IpKind` ç±»å‹å®ä¾‹çš„å‡½æ•°è°ƒç”¨ã€‚åœ¨å®šä¹‰æšä¸¾æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å®šä¹‰è¿™äº›æ„é€ å‡½æ•°ã€‚

```rust
enum Message {
    Quit,
    Move { x: u32, y: u32 },
    Write(String),
    Color(u8, u8, u8)
}
```

è¿™ä¸ªæšä¸¾æœ‰å››ä¸ªå«æœ‰ä¸åŒç±»å‹çš„å˜ä½“ï¼š

- `Quit` æ²¡æœ‰å…³è”ä»»ä½•æ•°æ®
- `Move` åŒ…å«ä¸€ä¸ªåŒ¿åç»“æ„ä½“
- `Write` åŒ…å«ä¸€ä¸ª `String`
- `Color` åŒ…å«ä¸‰ä¸ª `u8`

ä½¿ç”¨ç»“æ„ä½“ä¹Ÿå¯ä»¥è¿™æ ·å®šä¹‰ï¼Œä½†æ²¡æœ‰ä½¿ç”¨æšä¸¾ç®€æ´ï¼š

```rust
struct QuitMessage;
struct MoveMessage { x: u32, y: u32 }
struct WriteMessage(String);
struct ColorMessage(u8, u8, u8);
```

ä¸åŒ…å«ä»»ä½•å˜ä½“çš„æšä¸¾ä¸º**æ— å˜ä½“æšä¸¾**ï¼Œç”±äºæ²¡æœ‰ä»»ä½•æœ‰æ•ˆçš„å€¼ï¼Œæ‰€ä»¥ä¸èƒ½è¢«å®ä¾‹åŒ–ã€‚å®é™…ä¸Šè¿™ç›¸å½“äº `!` ç±»å‹ï¼Œä½†ä¸èƒ½è¢«å¼ºè½¬ä¸ºå…¶å®ƒç±»å‹ã€‚

```rust
enum ZeroVariants {}

fn main() {
    let x: ZeroVariants = loop {};
    let y: u32 = x; // é”™è¯¯ï¼Œç±»å‹ä¸åŒ¹é…
}
```

### Option æšä¸¾

è®¸å¤šè¯­è¨€ä¸­ï¼Œç©ºå€¼ `null` ä»£è¡¨æ²¡æœ‰å€¼ã€‚å½“å°è¯•åƒéç©ºå€¼é‚£æ ·ä½¿ç”¨ç©ºå€¼ï¼Œå°±ä¼šå‡ºç°é”™è¯¯ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œ**Rust æ²¡æœ‰ç©ºå€¼**ï¼Œä½†æœ‰ä¸€ä¸ªå¯ä»¥è¡¨ç¤ºå­˜åœ¨æˆ–ä¸å­˜åœ¨æ¦‚å¿µçš„æšä¸¾ã€‚

```rust
enum Option<T> {
    Some(T),
    None
}
```

`Option` æšä¸¾å·²è¢«åŒ…å«åœ¨æ ‡å‡†åº“é¢„å¯¼å…¥åŒ…ä¸­ï¼Œä¸éœ€è¦å°†å…¶æ˜¾å¼å¼•å…¥ä½œç”¨åŸŸï¼Œå…¶å˜ä½“ä¹Ÿä¸éœ€è¦ `Option::` å‰ç¼€ï¼Œå¯ç›´æ¥ä½¿ç”¨ `Some` å’Œ `None`ã€‚

```rust
let some_number = Some(5);
let some_string = Some("foo");
let absent_number: Option<i32> = None;
```

è‹¥ä½¿ç”¨ `None` è€Œä¸æ˜¯ `Some`ï¼Œåˆ™éœ€è¦æ˜¾å¼æ ‡æ³¨ç±»å‹ï¼Œå› ä¸ºç¼–è¯‘å™¨åªé€šè¿‡ `None` æ— æ³•è¿›è¡Œç±»å‹æ¨æ–­ã€‚

### Option æ–¹æ³•

å¸¸è§ `Option` æ–¹æ³•ï¼š

- `is_some`ã€`is_none`
- `and`ã€`and_then`
- `or`ã€`or_else`
- `map`ã€`map_or`ã€`map_or_else`
- `expect`ã€`unwrap`
- `unwrap_or`ã€`unwrap_or_else`

> æ›´å¤šå…³äº `Option` çš„æ–¹æ³•ï¼Œå¯å‚è€ƒ [Option in std::option](https://doc.rust-lang.org/std/option/enum.Option.html#implementations)ã€‚

## è”åˆä½“

Rust çš„è”åˆä½“å’Œ C ä¸­çš„è”åˆä½“åŸºæœ¬ç›¸åŒï¼Œä½¿ç”¨ `union` å®šä¹‰ï¼Œä½†ä»…å…è®¸å…·æœ‰ `Copy` çš„ç±»å‹ä½œä¸ºå…¶å­—æ®µã€‚æ¯æ¬¡å¯¹è”åˆä½“çš„è®¿é—®éƒ½å°†å…¶éƒ¨åˆ†å­˜å‚¨å†…å®¹è½¬æ¢ä¸ºè¢«è®¿é—®å­—æ®µçš„ç±»å‹ã€‚ç”±äºè½¬æ¢å¯èƒ½ä¼šå¯¼è‡´æ„å¤–æˆ–æœªå®šä¹‰è¡Œä¸ºï¼Œæ‰€ä»¥è®¿é—®è”åˆä½“å­—æ®µæ˜¯ä¸å®‰å…¨çš„ï¼Œéœ€è¦æ”¾åœ¨ `unsafe` å—ä¸­ã€‚

```rust
union MyUnion {
    i: i32,
    f: f64,
}

fn main() {
    let u = MyUnion { i: 5 };
    println!("{}", unsafe { u.i });
}
```

## å®ç°

å®ç°æ˜¯å°†ç»“æ„ä½“ã€æšä¸¾æˆ–è”åˆä½“è¿™ç±»ç¨‹åºé¡¹ä¸å®ç°ç±»å‹å…³è”èµ·æ¥çš„ç¨‹åºé¡¹ã€‚ä½¿ç”¨ `impl` å®šä¹‰ï¼ŒåŒ…å«äº†å½“å‰å®ç°ç±»å‹å®ä¾‹çš„å‡½æ•°â€”â€”æ–¹æ³•ï¼Œå½“å‰å®ç°ç±»å‹æœ¬èº«çš„é™æ€å‡½æ•°æˆ–å¸¸é‡â€”â€”å…³è”å‡½æ•°æˆ–å…³è”å¸¸é‡ã€‚

å®ç°æœ‰ä¸¤ç§ï¼š

- å›ºæœ‰å®ç°ï¼šåŒ…å«æ–¹æ³•ã€å…³è”å‡½æ•°æˆ–å…³è”å¸¸é‡
- trait å®ç°ï¼šä¸å›ºæœ‰å®ç°ç±»ä¼¼ï¼Œä½†ä½¿ç”¨ `for` æ¥ä¸ºæŸä¸ªå…·ä½“ç±»å‹å®ç° trait

```rust
#[derive(Debug)]
struct Color(u8, u8, u8);

impl Color {
    const WHITE: Color = Color(255, 255, 255);

    fn new(r: u8, g: u8, b: u8) -> Self {
        Self(r, g, b)
    }
}

impl Color {
    fn red() -> Color {
        Color(255, 0, 0)
    }

    fn mix(&self, other: &Color) -> Color {
        let r = self.0 | other.0;
        let g = self.1 | other.1;
        let b = self.2 | other.2;
        Color(r, g, b)
    }
}

impl std::fmt::Display for Color {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        let hex = format!("{:02X}{:02X}{:02X}", self.0, self.1, self.2);
        write!(f, "{}", hex)
    }
}

fn main() {
    let white = Color::WHITE;
    let red = Color::red();
    let blue = Color::new(0, 0, 255);
    println!("{white:?}");
    println!("{red}");
    println!("{blue}");
    println!("{}", red.mix(&blue));
}
```

`new` å’Œ `red` æ˜¯**å…³è”å‡½æ•°**ï¼Œå› ä¸ºå…¶ä½œç”¨äºç±»å‹è€Œéå®ä¾‹ï¼Œ`WHITE` æ˜¯**å…³è”å¸¸é‡**ï¼Œ`mix` æ˜¯**æ–¹æ³•**ã€‚

- å…³è”å‡½æ•°ã€å…³è”å¸¸é‡ï¼šé€šè¿‡ `::` è°ƒç”¨
- æ–¹æ³•ï¼šé€šè¿‡ `.` è°ƒç”¨

æ–¹æ³•ä¸å‡½æ•°ç±»ä¼¼ï¼Œä½†ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯ `self`ï¼Œä»£è¡¨è°ƒç”¨è¯¥æ–¹æ³•çš„å®ä¾‹ã€‚`&self` è¡¨ç¤ºå¼•ç”¨å®ä¾‹æœ¬èº«ï¼Œè¿™å®é™…ä¸Šæ˜¯ `self: &Self` çš„ç¼©å†™ã€‚åœ¨ä¸€ä¸ª `impl` å—ä¸­ï¼Œ`Self` æ˜¯ç±»å‹çš„åˆ«åã€‚åªè¦ç¬¬ä¸€ä¸ªå‚æ•°åä¸º `self`ï¼Œå°±ä»£è¡¨äº†å®ä¾‹æœ¬èº«ã€‚

- `Self`ï¼šå®ä¾‹ç±»å‹çš„åˆ«å
- `self`ï¼šè·å– `self` çš„æ‰€æœ‰æƒ
- `&self`ï¼šä¸å¯å˜åœ°å€Ÿç”¨ `self`
- `&mut self`ï¼šå¯å˜åœ°å€Ÿç”¨ `self`

> åœ¨åŒä¸€ Crate å†…ï¼Œå¯¹åŒä¸€ä¸ªç¨‹åºé¡¹çš„å®ç°å¯åˆ†ä¸ºå¤šä¸ª `impl` å—ï¼Œä¹Ÿå¯åˆå¹¶åˆ°ä¸€èµ·ã€‚

### è‡ªåŠ¨å¼•ç”¨å’Œè§£å¼•ç”¨

åœ¨ C / C++ ä¸­ï¼Œæœ‰ä¸¤ä¸ªä¸åŒçš„è¿ç®—ç¬¦æ¥è°ƒç”¨æ–¹æ³•ï¼š`.` ç›´æ¥åœ¨å¯¹è±¡ä¸Šè°ƒç”¨æ–¹æ³•ï¼Œè€Œ `->` åœ¨ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆä¸Šè°ƒç”¨æ–¹æ³•ï¼Œè¿™æ—¶éœ€è¦å…ˆè§£å¼•ç”¨æŒ‡é’ˆã€‚

```c
object->method();
(*object).method();
```

Rust å¹¶æ²¡æœ‰ä¸€ä¸ªä¸ `->` ç­‰æ•ˆçš„è¿ç®—ç¬¦ï¼Œä½†æœ‰**è‡ªåŠ¨å¼•ç”¨å’Œè§£å¼•ç”¨**ã€‚å½“ä½¿ç”¨ `object.method()` æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸º `object` æ·»åŠ  `&`ã€`&mut` æˆ– `*` ä»¥ä½¿ `object` ä¸æ–¹æ³•ç­¾ååŒ¹é…ã€‚

```rust
let red = Color::red();
let blue = Color::new(0, 0, 255);
println!("{}", red.mix(&blue));
println!("{}", (&red).mix(&blue));
```

`red`ã€`(&red)` å®é™…ä¸Šæ˜¯ç­‰ä»·çš„ï¼Œå› ä¸ºæ–¹æ³•æ˜ç¡®æ¥å— `&self`ï¼Œå› æ­¤ç¼–è¯‘å™¨èƒ½è‡ªåŠ¨æ¨æ–­å‡ºæ˜¯ `self`ã€`&self` è¿˜æ˜¯ `&mut self`ã€‚

## å†…å­˜å¸ƒå±€

Rust çš„å†…å­˜å¸ƒå±€è¿˜æœªç¨³å®šï¼Œå¯¹äºç»“æ„ä½“æˆ–æšä¸¾ç­‰ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šå¯¹å­—æ®µé¡ºåºã€å­—æ®µå†…å­˜ç­‰è¿›è¡Œä¼˜åŒ–ï¼Œä½†å¯ä½¿ç”¨ `repr` å±æ€§æ¥è‡ªå®šä¹‰å†…å­˜å¸ƒå±€ã€‚

```rust
use std::mem::{align_of, size_of};

#[repr(C, align(8))]
struct ThreeInts {
    first: i16,
    second: i8,
    third: i32,
}

#[repr(C)]
union SizeRoundedUp {
    a: u32,
    b: [u16; 5],
}

fn main() {
    assert_eq!(align_of::<ThreeInts>(), 8);
    assert_eq!(size_of::<ThreeInts>(), 8);
    assert_eq!(align_of::<SizeRoundedUp>(), 4);
    assert_eq!(size_of::<SizeRoundedUp>(), 12);
}
```

å¸¦å­—æ®µçš„ `#[repr(C)]` æšä¸¾çš„å†…å­˜å¸ƒå±€å®é™…ä¸Šç­‰æ•ˆäºä¸€ä¸ªå¸¦ä¸¤ä¸ªå­—æ®µçš„ `#[repr(C)]` ç»“æ„ä½“ã€‚

```rust
use std::mem::{size_of, size_of_val};

#[repr(C)]
enum MyEnum {
    A(u32),
    B(f32, u64),
    C { x: u32, y: u8 },
    D,
}

// ç­‰æ•ˆäºä»¥ä¸‹å®šä¹‰
#[repr(C)]
struct MyEnumRepr {
    tag: MyEnumDiscriminant,
    payload: MyEnumFields,
}

#[repr(C)]
enum MyEnumDiscriminant {
    A,
    B,
    C,
    D,
}

#[repr(C)]
union MyEnumFields {
    a: MyAFields,
    b: MyBFields,
    c: MyCFields,
    d: MyDFields,
}

#[repr(C)]
#[derive(Copy, Clone)]
struct MyAFields(u32);

#[repr(C)]
#[derive(Copy, Clone)]
struct MyBFields(f32, u64);

#[repr(C)]
#[derive(Copy, Clone)]
struct MyCFields {
    x: u32,
    y: u8,
}

#[repr(C)]
#[derive(Copy, Clone)]
struct MyDFields;

fn main() {
    let e = MyEnum::A(1);
    let s = MyEnumRepr {
        tag: MyEnumDiscriminant::A,
        payload: MyEnumFields { a: MyAFields(1) },
    };

    assert_eq!(size_of::<MyEnum>(), size_of::<MyEnumRepr>());
    assert_eq!(size_of_val(&e), size_of_val(&s));
}
```

# 4 æ¨¡å¼åŒ¹é…

**æ¨¡å¼**æ˜¯ Rust ä¸­ç‰¹æ®Šçš„è¯­æ³•ï¼Œç”¨æ¥åŒ¹é…ç±»å‹ä¸­çš„ç»“æ„ï¼Œç”±ä»¥ä¸‹å†…å®¹ç»„æˆï¼š

- å­—é¢å€¼ã€å‘½åå˜é‡
- è§£æ„å…ƒç»„ã€æ•°ç»„ã€ç»“æ„ä½“ã€æšä¸¾å’Œè”åˆä½“
- é€šé…ç¬¦ã€å ä½ç¬¦

## ä½¿ç”¨æ¨¡å¼çš„ä½ç½®

### let

let è¯­å¥æ˜¯ä¸€ä¸ªæ¨¡å¼ï¼Œå…¶æ­£å¼å½¢å¼ä¸ºï¼š

```rust
let <PATTERN> = <EXPRESSION>;
```

è¯­å¥ä¸­å˜é‡åä½äº `PATTERN` ä½ç½®ï¼Œç„¶åå°† `EXPRESSION` ä¸­çš„å€¼è§£æ„åç»‘å®šåˆ°å¯¹åº”çš„å˜é‡ã€‚

```rust
let (x, y, z) = (1, 2, 3);
```

### for

åœ¨ `for` å¾ªç¯ä¸­ä½¿ç”¨æ¨¡å¼æ¥è§£æ„å…ƒç»„ï¼š

```rust
let v = vec!['a', 'b', 'c'];

for (i, v) in v.iter().enumerate() {
    println!("{v} is at index {i}");
}
```

### match

`match` å…è®¸å°†ä¸€ä¸ªå€¼ä¸ä¸€ç³»åˆ—çš„æ¨¡å¼æ¯”è¾ƒå¹¶æ ¹æ®åŒ¹é…çš„æ¨¡å¼æ‰§è¡Œç›¸åº”ä»£ç ã€‚

```rust
match VALUE {
    <PATTERN1> => <EXPRESSION1>,
    <PATTERN2> => <EXPRESSION2>,
}
```

åŒ¹é…å˜é‡ `x` ä¸­ `Option<i32>` å€¼çš„ `match` è¡¨è¾¾å¼ï¼š

```rust
match x {
    None => None,
    Some(i) => Some(i + 1),
}
```

`match` è¡¨è¾¾å¼å¿…é¡»æ˜¯**ç©·å°½**çš„ï¼Œä¸”æ¯ä¸ªåˆ†æ”¯çš„è¿”å›å€¼ç±»å‹éƒ½å¿…é¡»ç›¸åŒï¼ˆ`!` ç±»å‹é™¤å¤–ï¼‰ã€‚

### if let

å½“åªå…³æ³¨ä¸€ç§æƒ…å†µçš„æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨ `if let` æ¥çœç•¥ï¼Œå¹¶å¯é€‰ç»„åˆ `else if`ã€`else if let` å’Œ `else` æ¥åŒ¹é…ï¼Œå¹¶ä¸”åŒ¹é…ä¹‹é—´å¯ä»¥ä¸ç›¸å…³è”ï¼Œå…¶ç¼ºç‚¹åœ¨äºåŒ¹é…æ²¡æœ‰ç©·å°½ã€‚

```rust
let value = Some(5);
let flag = false;

if let Some(1) = value {
    println!("1");
} else if let Some(2) = value {
    println!("2");
} else if flag {
    println!("true");
} else {
    println!("other");
}
```

### while let

å½“åªè¦æ¨¡å¼èƒ½åŒ¹é…å°±ä¸€ç›´è¿›è¡Œ `while` å¾ªç¯ã€‚

```rust
let mut stack = Vec::new();

stack.push(1);
stack.push(2);
stack.push(3);

while let Some(top) = stack.pop() {
    println!("{}", top);
}
```

`while` å¾ªç¯åªè¦ `pop` è¿”å› `Some` å°±ä¼šä¸€ç›´è¿è¡Œå…¶å—ä¸­çš„ä»£ç ã€‚ä¸€æ—¦å…¶è¿”å› `None`ï¼Œ`while` å¾ªç¯åœæ­¢ã€‚

> `while let` ä¸èƒ½ä½¿ç”¨ `else if`ã€`else if let` å’Œ `else` åˆ†æ”¯ç»„åˆã€‚

### å‡½æ•°å‚æ•°

å‡½æ•°å‚æ•°ä¹Ÿæ˜¯æ¨¡å¼ã€‚

```rust
fn pair(&(x, y): &(i32, i32)) {
    println!("({}, {})", x, y);
}
```

> é—­åŒ…å‚æ•°ä¹Ÿèƒ½ä½¿ç”¨æ¨¡å¼ã€‚

## å¯åé©³æ€§

æ¨¡å¼æœ‰ä¸¤ç§å½¢å¼ï¼š

- å¯åé©³çš„ï¼šå¯èƒ½ä¼šåŒ¹é…ä¼šå¤±è´¥çš„æ¨¡å¼ï¼Œå¦‚ `match` åˆ†æ”¯ã€`if let` å’Œ `while let` è¡¨è¾¾å¼
- ä¸å¯åé©³çš„ï¼šèƒ½åŒ¹é…ä»»æ„å€¼çš„æ¨¡å¼ï¼Œå¦‚ `let` è¯­å¥ã€`for` å¾ªç¯å’Œå‡½æ•°å‚æ•°

```rust
// é”™è¯¯
let Some(x) = value;
```

å› ä¸º `let` è¯­å¥åªæ¥å—ä¸å¯åé©³çš„æ¨¡å¼ï¼Œè€Œ `value` è¿˜æœ‰å¯èƒ½ä¸º `None`ï¼Œå› æ­¤å¯èƒ½ä¼šå¤±è´¥ï¼Œä½†å¯åŠ ä¸Š `if` æ¥æ„æˆ `if let` è¿™ç§å¯åé©³çš„è¡¨è¾¾å¼ã€‚

```rust
if let Some(x) = value {}
```

## åŒ¹é…é¡¹çš„æ‰€æœ‰æƒ

### éƒ¨åˆ†ç§»åŠ¨

å¯¹äºæ²¡æœ‰å®ç° `Copy` çš„ç±»å‹å€¼ï¼Œåœ¨åŒ¹é…æ—¶ä¼šè·å–æ‰€æœ‰æƒï¼Œä»è€Œå‘ç”Ÿç§»åŠ¨ã€‚

```rust
let s = Some(String::from("foo"));
match s {
    Some(v) => println!("{v}"),
    None => println!("Nothing"),
}
println!("{:?}", s);    // é”™è¯¯ï¼Œs ä¸­çš„å€¼å·²ç»ç§»åŠ¨åˆ° v
```

`Some(v)` ä¸­çš„ `v` ä¼šè·å– `s` ä¸­ `String` çš„æ‰€æœ‰æƒï¼Œ`s` ä¸­çš„ä¸€éƒ¨åˆ†è¢«ç§»åŠ¨äº†ï¼Œåœ¨ä¹‹åå°±ä¸èƒ½ç»§ç»­ä½¿ç”¨ `s` çš„æ•´ä½“ï¼Œä½†å¯ä½¿ç”¨æ²¡æœ‰è¢«ç§»åŠ¨çš„éƒ¨åˆ†ï¼Œè¿™ç§°ä¸º**éƒ¨åˆ†ç§»åŠ¨**ã€‚

åœ¨æ¨¡å¼åŒ¹é…æ—¶ä½¿ç”¨ `ref` å’Œ `ref mut` è·å–ä¸å¯å˜å’Œå¯å˜å¼•ç”¨ã€‚

```rust
fn update_inner(s: &mut Option<String>) {
    match s {
        Some(ref mut v) => v.push_str("bar"),
        None => (),
    }
}

fn print_inner(s: &Option<String>) {
    match s {
        Some(ref v) => println!("{}", v),
        None => println!("Nothing"),
    }
}

fn main() {
    let mut s = Some(String::from("foo"));
    update_inner(&mut s);
    print_inner(&s);
}
```

### & å’Œ ref

`ref` å’Œ `&` éƒ½å¯åœ¨æ¨¡å¼åŒ¹é…ä¸­ä½¿ç”¨ï¼Œä¸»è¦åŒºåˆ«åœ¨äºç”¨æ³•å’Œç›®çš„ã€‚å‰è€…ç”¨äºåœ¨æ¨¡å¼åŒ¹é…ä¸­**åˆ›å»ºä¸€ä¸ªå¼•ç”¨**ï¼Œè€Œä¸æ˜¯è·å¾—å€¼çš„æ‰€æœ‰æƒï¼Œåè€…ä¸»è¦æ˜¯ä¸ºäº†**åŒ¹é…å¼•ç”¨**ã€‚å› æ­¤ `ref` ä¸æ˜¯æ¨¡å¼çš„ä¸€éƒ¨åˆ†ï¼Œè€Œ `&` æ˜¯æ¨¡å¼çš„ä¸€éƒ¨åˆ†ã€‚

```rust
let tup = (String::from("foo"), &1);
match tup {
    (ref x, &y) => println!("({x}, {y})"),
}
```

## æ¨¡å¼è¯­æ³•

### åŒ¹é…å­—é¢å€¼

ç›´æ¥åŒ¹é…å­—é¢å€¼ã€‚

```rust
let x = 1;

match x {
    1 => println!("one"),
    2 => println!("two"),
    3 => println!("three"),
    _ => println!("anything"),
}
```

### åŒ¹é…å‘½åå˜é‡

å‘½åå˜é‡æ˜¯åŒ¹é…ä»»æ„å€¼çš„ä¸å¯åé©³æ¨¡å¼ã€‚

```rust
let x = Some(5);
let y = 10;

match x {
    Some(20) => todo!(),
    Some(y) => println!("y = {y}"),
    _ => println!("x = {:?}", x),
}

println!("x = {:?}, y = {y}", x);
```

ç¬¬ä¸€ä¸ªåˆ†æ”¯ä¸åŒ¹é…ï¼Œç¬¬äºŒä¸ªåˆ†æ”¯åŒ¹é…ä»»æ„å€¼ï¼Œå¹¶å°†è¯¥å€¼ç»‘å®šåˆ° `y` ä¸Šï¼Œè¿™ç›¸å½“äºåœ¨è¿™æ¡åˆ†æ”¯ä¸­åˆ›å»ºäº†ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå› æ­¤è¿™é‡Œçš„ `y` å’Œ `match` å¤–é¢çš„ `y` æ˜¯ä¸åŒçš„ã€‚

### å¤šä¸ªæ¨¡å¼

ä½¿ç”¨**æˆ–**è¿ç®—ç¬¦ `|` æ¥åŒ¹é…å¤šä¸ªæ¨¡å¼ã€‚

```rust
let x = 1;

match x {
    1 | 2 => println!("one or two"),
    3 => println!("three"),
    _ => println!("anything"),
}
```

### åŒ¹é…èŒƒå›´

ä½¿ç”¨ `..` æˆ– `..=` æ¥åŒ¹é…èŒƒå›´å€¼ã€‚

```rust
let x = 5;

match x {
    1..=5 => println!("1 ~ 5"),
    ..30 => println!("~ 29"),
    30.. => println!("30 ~"),
}
```

åŒ¹é… `char` ç±»å‹å€¼çš„èŒƒå›´ã€‚

```rust
let x = 'c';

match x {
    'a'..='z' => println!("lowercase"),
    'A'..='Z' => println!("uppercase"),
    _ => println!("others"),
}
```

### è§£æ„ç»“æ„ä½“

åˆ›å»ºäº†å˜é‡ `a` å’Œ `b` æ¥åŒ¹é…ç»“æ„ä½“ `p` ä¸­çš„ `x` å’Œ `y` å­—æ®µã€‚

```rust
struct Point {
    x: i32,
    y: i32,
}

fn main() {
    let p = Point { x: 0, y: 1 };
    let Point { x: a, y: b } = p;
    assert_eq!(0, a);
    assert_eq!(1, b);
}
```

æ¨¡å¼ä¸­çš„å˜é‡åå¯ä»¥ä¸ä¸ç»“æ„ä½“ä¸­çš„å­—æ®µåä¸€è‡´ï¼Œä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç®€å†™ã€‚

```rust
let p = Point { x: 0, y: 1 };
let Point { x, y } = p;
assert_eq!(0, x);
assert_eq!(1, y);
```

å¯ä»¥åŒ¹é…éƒ¨åˆ†å­—æ®µå€¼ã€‚

```rust
let p = Point { x: 0, y: 1 };

match p {
    Point { x, y: 0 } => todo!(),
    Point { x: 0, y } => todo!(),
    Point { x, y } => todo!()
}
```

### è§£æ„æšä¸¾

è§£æ„æšä¸¾å’Œæšä¸¾åŒ…å«çš„å€¼ã€‚

```rust
enum Message {
    Quit,
    Move { x: i32, y: i32 },
    Write(String),
    ChangeColor(i32, i32, i32),
}

fn main() {
    let msg = Message::ChangeColor(0, 160, 255);

    match msg {
        Message::Quit => todo!(),
        Message::Move { x, y } => todo!(),
        Message::Write(s) => todo!(),
        Message::ChangeColor(r, g, b) => todo!(),
    }
}
```

### è§£æ„åµŒå¥—å€¼

è§£æ„ç»“æ„ä½“å’Œæšä¸¾çš„åµŒå¥—ã€‚

```rust
enum IpKind {
    Ipv4,
    Ipv6,
}

struct IpAddr {
    kind: IpKind,
    value: String,
}

fn main() {
    let ip = IpAddr {
        kind: IpKind::Ipv4,
        value: String::from("127.0.0.1"),
    };

    match ip {
        IpAddr {
            kind: IpKind::Ipv4,
            value,
        } => todo!(),
        IpAddr {
            kind: IpKind::Ipv6,
            value,
        } => todo!(),
    }
}
```

è§£æ„ç»“æ„ä½“å’Œå…ƒç»„çš„åµŒå¥—ã€‚

```rust
let ((a, b), Point { x, y }) = ((1, 2), Point { x: 3, y: 4 });
```

### å¿½ç•¥æ¨¡å¼å€¼

æœ‰æ—¶å¹¶ä¸éœ€è¦ä½¿ç”¨å…¨éƒ¨åŒ¹é…åˆ°çš„æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨ `_` æ¥è¿›è¡Œå¿½ç•¥åŒ¹é…åˆ°çš„å€¼ï¼Œ**ä¸”ä¸è¿›è¡Œç»‘å®š**ï¼Œæˆ–ä½¿ç”¨ `..` å¿½ç•¥æ‰€å‰©éƒ¨åˆ†çš„å€¼ã€‚

```rust
// å¿½ç•¥å‡½æ•°å‚æ•°
fn foo(_: i32, y: i32) {}

// å¿½ç•¥æ¨¡å¼åŒ¹é…
match value {
    Some(_) => todo!(),
    _ => todo!()
}

// å¿½ç•¥åµŒå¥—çš„åŒ¹é…
match (value1, value2) {
    (Some(_), Some(_)) => todo!(),
    _ => todo!()
}

let nums = (1, 2, 3, 4, 5);

// å¿½ç•¥å¤šä¸ªéƒ¨åˆ†
match nums {
    (first, _, third, _, fifth) => todo!(),
    _ => todo!()
}

// å¿½ç•¥ä¸­é—´å€¼
match nums {
    (first, .., last) => todo!()
}

// å¿½ç•¥å°¾éƒ¨å€¼
match nums {
    (first, ..) => todo!()
}
```

é€šè¿‡ `..` æ¥åŒ¹é…æ—¶ä¸èƒ½äº§ç”Ÿæ­§ä¹‰ã€‚

```rust
let nums = (1, 2, 3, 4, 5);

match nums {
    // é”™è¯¯ï¼Œæ— æ³•ç¡®å®šä¸­é—´ä½ç½®
    (.., mid, ..) => todo!()
}
```

### åŒ¹é…é¢å¤–æ¡ä»¶

**åŒ¹é…é¢å¤–æ¡ä»¶**æ˜¯ä¸€ä¸ªæŒ‡å®šäº `match` åˆ†æ”¯æ¨¡å¼ä¹‹åçš„é¢å¤– `if` æ¡ä»¶ï¼Œå®ƒä¹Ÿå¿…é¡»è¢«æ»¡è¶³æ‰èƒ½åŒ¹é…è¯¥åˆ†æ”¯ã€‚

```rust
let num = Some(5);

match num {
    Some(x) if x % 2 == 0 => todo!(),
    Some(x) => todo!(),
    None => todo!()
}
```

ä½¿ç”¨ `|` æ¥æŒ‡å®šå¤šä¸ªæ¨¡å¼ã€‚

```rust
let x = 1;
let y = false;

match x {
    1 | 2 | 3 if y => todo!(),
    _ => todo!()
}
```

è¿™é‡Œ `if` çš„ä¼˜å…ˆçº§æ˜¯æœ€ä½çš„ï¼Œå› æ­¤ç­‰åŒäº `(1 | 2 | 3) if y`ã€‚

### @ ç»‘å®š

`@` è¿ç®—ç¬¦åœ¨æ¨¡å¼åŒ¹é…ä¸­ç”¨äºç»‘å®šå˜é‡åˆ°æ¨¡å¼ã€‚è¿™å¯ä»¥åœ¨ä¸€ä¸ªåŒ¹é…åˆ†æ”¯ä¸­ï¼ŒåŒæ—¶è®¿é—®æ•´ä¸ªå€¼å’Œéƒ¨åˆ†å€¼ã€‚

```rust
let value = Some(1);

match value {
    v @ Some(t) => {
        println!("value: {:?}", v);
        println!("inner value: {t}");
    }
    None => println!("None"),
}

if let a @ b @ Some(_) = value {
    println!("a: {a:?}, b: {b:?}");
}
```

è¿™é‡Œ `v` å°±ç›¸å½“äºæ˜¯ `value`ï¼Œ`t` å°±ç›¸å½“äºæ˜¯ `Option<T>` ä¸­çš„ `T`ï¼Œ`a`ã€`b` ä¸¤ä¸ªä¹Ÿéƒ½ç›¸å½“äº `value`ã€‚ç”±äºå€¼æ˜¯ Copy çš„ï¼Œå› æ­¤å³ä½¿æ¨¡å¼çš„å‘½åå˜é‡ä¼šé€ æˆç»‘å®šï¼Œä½†æ˜¯ä¾ç„¶å¯ä»¥ä½¿ç”¨å€¼ï¼Œå¦åˆ™å°±éœ€è¦ä½¿ç”¨ `ref`ã€‚
