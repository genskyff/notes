# 1 概述

为了对恶意软件进行分析，通常会在虚拟环境中进行。本文将围绕着如何搭建一个完整的虚拟分析环境展开，使用 VMware Workstation、INetSim、Burp Suite 和 Sysinternals Suite 等分析工具，建立一个恶意软件分析环境。

该环境与主机系统和 Internet 隔离，成为一个独立的虚拟网络，并在其中设置两台虚拟机：

-   Kali Linux 作为分析机，用于模拟 HTTP(S)、DNS 等常见网络服务，记录并分析恶意软件的网络通信；
-   Windows 作为受害机，用于运行恶意软件样本，同时也会对进程、注册表、文件等操作进行监控。

![网络拓扑](https://raw.githubusercontent.com/genskyff/image-hosting/main/images/202205150129644.png)

恶意软件将会在不知觉的情况下，连接到分析机而不是 Internet。同时以知名勒索软件 [WannaCry](https://zh.m.wikipedia.org/zh-hans/WannaCry) 为例进行分析。

# 2 工具准备

## 虚拟机

虚拟机可以选择 [VirtualBox](https://www.virtualbox.org/wiki/Downloads) 或 [VMware Workstation](https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html)，这两者使用方法都差不多，前者免费开源，后者功能强大但收费，不过网上随便都能找到注册码。

>   本文以 VMware Workstation 为例。

## 系统镜像

### Windows

Windows ISO 可以去 [ITELLYOU](https://next.itellyou.cn/) 下载，然后在虚拟机中安装。如果嫌麻烦，也可以去 [Microsoft Edge Developer](https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/) 下载打包好了的虚拟机文件，然后直接在虚拟机中打开即可，但是版本较旧，不是特别推荐。

>   本文以 Windows 10 为例。

### Kali Linux

在 [Kali Linux](https://www.kali.org/get-kali/#kali-virtual-machines) 官方下载虚拟机文件即可。

## 分析工具

### INetSim、Burp Suite

由于 Kali Linux 自带了大量工具，因此大部分工具都不需要在上面安装。

>   以下工具全部都是装在 Windows，即受害机上。

### Sysinternals Suite

包含大量工具，但只会使用其中的一小部分，如 Process Explorer、Process Monitor、Autoruns 等。

-   [下载地址](https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite)

### Detect It Easy

用于 PE 文件分析、查壳、查字符串、查导入导出表等。

-   [下载地址](https://github.com/horsicq/DIE-engine/releases)

### Regshot

用于注册表对比。

-   [下载地址](http://www.lupopensuite.com/db/regshot2.htm)

### Wireshark

用于分析网络通信。

-   [下载地址](https://www.wireshark.org/download.html)

### Nmap

用于网络审计、数据包发送等。

-   [下载地址](https://nmap.org/download)

### ApateDNS

用于重定向 DNS 解析。

-   [下载地址](https://www.softpedia.com/get/Network-Tools/Misc-Networking-Tools/ApateDNS.shtml)

### UPX

>   可以装在本机上，而不用装在受害机上。

用于打包解包。

-   [下载地址](https://github.com/upx/upx/releases/tag/v3.96)

### OllDBG

用于 32 位程序用户态动态调试。

-   [下载地址](https://tool.pediy.com/index-detail-1.htm)

### x64dbg

用于 32 和 64 位程序用户态动态调试，比 OllDBG 更现代。

-   [下载地址](https://github.com/x64dbg/x64dbg/releases)

### WinDbg

用于 32 和 64 位用户态和内核态动态调试，微软官方出品，强大不用多说。

-   [下载地址](https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/debugger-download-tools)

### IDA Pro

>   可以装在本机上，而不用装在受害机上。

用于反汇编、反编译。

-   [下载地址](https://www.52pojie.cn/thread-1584115-1-1.html)

# 3 配置虚拟网络

