# 1 åŸºç¡€æ¦‚å¿µ

## æ ‡è¯†ç¬¦

-   ç”±ä»»æ„éç©ºçš„ï¼Œä¸”é emoji çš„ Unicode å­—ç¬¦æ„æˆï¼›
-   ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ï¼Œä¸”ä¸èƒ½ä¸ºå…³é”®å­—ï¼›

-   å½“ä»¥ä¸‹åˆ’çº¿å¼€å¤´æ—¶ï¼Œé•¿åº¦è‡³å°‘ä¸º **2**ï¼›

-   å•ä¸ª `_` ä½œä¸ºæ ‡è¯†ç¬¦è¡¨ç¤º**å¿½ç•¥**ã€‚

### åŸå§‹æ ‡è¯†ç¬¦

å½“å’Œå¤–éƒ¨ FFI è¿›è¡Œäº¤äº’æ—¶ï¼Œå¦‚è°ƒç”¨ C åº“ä¸­åä¸º `match` çš„å‡½æ•°ã€‚åœ¨ C ä¸­ match ä¸æ˜¯å…³é”®å­—ï¼Œä½†åœ¨ Rust ä¸­æ˜¯å…³é”®å­—ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ä»¥ `r#` å¼€å¤´çš„åŸå§‹æ ‡è¯†ç¬¦ã€‚

```rust
fn r#fn() {
    let r#i32 = 123;
    println!("{}", r#i32);
}

fn main() {
    r#fn();
}
```

## å¸¸é‡å’Œå˜é‡

**å¸¸é‡**ä½¿ç”¨ `const` å…³é”®å­—å£°æ˜ï¼Œå¿…é¡»æ˜¾å¼æŒ‡æ˜ç±»å‹ï¼Œå¹¶åœ¨å£°æ˜æ—¶åˆå§‹åŒ–ï¼Œå£°æ˜åå€¼ä¸å¯å˜ã€‚

**å˜é‡**ä½¿ç”¨ `let` å…³é”®å­—å£°æ˜ï¼Œå¯ä»¥ä¸æ˜¾å¼å£°æ˜ç±»å‹ï¼Œå€¼ä¸å˜é‡é€šè¿‡**ç»‘å®š**æ¥å…³è”ã€‚ä½† Rust é»˜è®¤å˜é‡ä¹Ÿæ˜¯**ä¸å¯å˜çš„**ï¼Œéœ€è¦æ˜¾å¼ä½¿ç”¨ `mut` å…³é”®å­—ä¿®é¥°æ¥ä½¿å…¶å¯å˜ã€‚

```rust
const MAX: i32 = 5;  // å¸¸é‡
let x = 1;           // ä¸å¯å˜å˜é‡
let mut y:u32 = 2;   // å¯å˜å˜é‡
```

åŒæ—¶ `let` å’Œ `mut` æ˜¯ä¸€ä¸ª**æ¨¡å¼**ï¼Œå¯ä»¥åˆ©ç”¨**æ¨¡å¼åŒ¹é…**æ¥å£°æ˜å˜é‡ï¼š

```rust
let (mut a, b) = (1, 2);  // a å¯å˜ï¼Œb ä¸å¯å˜
```

å˜é‡å¯ä»¥ä¸å¿…åœ¨å£°æ˜æ—¶åˆå§‹åŒ–ï¼Œä½†ä½¿ç”¨å‰å¿…é¡»è¢«åˆå§‹åŒ–ï¼š

```rust
let x;
x = 1;
println!("{x}");
```

å¸¸é‡å’Œä¸å¯å˜å˜é‡çš„åŒºåˆ«ï¼š

-   å¸¸é‡çš„å€¼å¿…é¡»èƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸå°±èƒ½è®¡ç®—å‡ºï¼Œä¸èƒ½æ˜¯åœ¨è¿è¡Œæ—¶æ‰èƒ½è®¡ç®—å‡ºçš„å€¼ï¼›
-   å¸¸é‡å¯ä»¥åœ¨ä»»ä½•ä½œç”¨åŸŸä¸­å£°æ˜ï¼ŒåŒ…æ‹¬å…¨å±€ä½œç”¨åŸŸï¼Œè€Œå˜é‡åªèƒ½åœ¨å‡½æ•°ä½œç”¨åŸŸç”Ÿæ•ˆã€‚

### éšè—

å¯ä»¥é€šè¿‡ `let` æ¥å®šä¹‰ä¸€ä¸ªä¸å·²å£°æ˜å˜é‡æˆ–å‡½æ•°åŒåçš„æ–°å˜é‡ï¼Œæ–°å˜é‡ä¼šéšè—ä¹‹å‰çš„å˜é‡æˆ–å‡½æ•°ã€‚

```rust
fn sum(x: i32, y: i32) -> i32 {
    x + y
}

fn main() {
    let x = 1;
    let x = x + 2;
    let x = 1.2;    // ç±»å‹å¯ä»¥ä¸åŒ
    let sum = sum(1, 2);
    sum(3, 4);      // é”™è¯¯ï¼Œsum å‡½æ•°åœ¨æ­¤å¤„ä¸å¯ç”¨
}
```

æ–°å˜é‡åªåœ¨å…¶ä½œç”¨åŸŸå†…èµ·ä½œç”¨ï¼Œå½“ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå¤–éƒ¨è¢«éšè—çš„é¡¹ä¼šæ¢å¤ï¼š

```rust
let v = 2;
{
    let v = 4;
    println!("{v}");   // è¾“å‡º 4
}
println!("{v}");       // è¾“å‡º 2
```

## é™æ€é¡¹

é™æ€é¡¹ä½¿ç”¨ `static` å£°æ˜ï¼Œå¿…é¡»æ˜¾å¼æŒ‡æ˜ç±»å‹å’Œåˆå§‹åŒ–ï¼Œç±»ä¼¼äºå¸¸é‡ï¼Œä½†åœ¨ç¨‹åºä¸­è¡¨ç¤ºä¸€ä¸ªç²¾ç¡®çš„å†…å­˜ä½ç½®ã€‚æ‰€æœ‰å¯¹é™æ€é¡¹çš„å¼•ç”¨éƒ½æŒ‡å‘ç›¸åŒçš„å†…å­˜ä½ç½®ï¼Œå¹¶å…·æœ‰ ` 'static` ç”Ÿå‘½å‘¨æœŸï¼Œä¸”ä¸ä¼šåœ¨ç¨‹åºç»“æŸæ—¶è°ƒç”¨ææ„å‡½æ•° `drop`ã€‚

é™æ€é¡¹çš„åˆå§‹åŒ–æ˜¯åœ¨ç¼–è¯‘æœŸæ±‚å€¼çš„å¸¸é‡è¡¨è¾¾å¼ï¼Œå¹¶å¯å¼•ç”¨å…¶å®ƒé™æ€é¡¹ã€‚

æ‰€æœ‰è®¿é—®é™æ€é¡¹çš„æ“ä½œéƒ½æ˜¯å®‰å…¨çš„ï¼Œä½†æœ‰ä¸€äº›é™åˆ¶ï¼š

-   é™æ€é¡¹çš„æ•°æ®ç±»å‹å¿…é¡»æœ‰ `Sync` traitï¼›
-   å¸¸é‡é¡¹ä¸èƒ½å¼•ç”¨é™æ€é¡¹ã€‚

é™æ€æƒ³å¯ä»¥ä½¿ç”¨ `mut` å£°æ˜ï¼Œä½†å¯¹å…¶æ‰€æœ‰è®¿é—®æ“ä½œéƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œéœ€è¦åœ¨ `unsafe` å—ä¸­ä½¿ç”¨ã€‚

```rust
static mut COUNT: i32 = 0;

unsafe fn read_count() -> i32 {
    COUNT
}

unsafe fn write_count(n: i32) {
    COUNT += n;
}
```

## åŸºæœ¬ç±»å‹

Rust æ˜¯**é™æ€ç±»å‹**è¯­è¨€ï¼Œç¼–è¯‘å™¨èƒ½å¤Ÿè¿›è¡Œç±»å‹æ¨æ–­ã€‚å½“å¤šç§ç±»å‹å‡æœ‰å¯èƒ½æ—¶ï¼Œå¿…é¡»å¢åŠ **ç±»å‹æ³¨è§£**ã€‚

```rust
let x: u32 = 10;
let y: f32 = 3.14;
```

æ¯ä¸€ä¸ªå€¼éƒ½å±äºæŸç§æ•°æ®ç±»å‹ï¼ŒRust æœ‰ä¸¤ç±»æ•°æ®ç±»å‹å­é›†ï¼š**æ ‡é‡**å’Œ**å¤åˆ**ã€‚

### æ ‡é‡ç±»å‹

æ ‡é‡ç±»å‹ä»£è¡¨ä¸€ä¸ªå•ç‹¬çš„å€¼ã€‚Rust æœ‰å››ç§åŸºæœ¬çš„æ ‡é‡ç±»å‹ï¼š**æ•´å‹**ã€**æµ®ç‚¹å‹**ã€**å¸ƒå°”ç±»å‹**å’Œ**å­—ç¬¦ç±»å‹**ã€‚

#### æ•´å‹

| é•¿åº¦    | æœ‰ç¬¦å·     | æ— ç¬¦å· |
| ------- | ---------- | ------ |
| 8 bit   | i8         | u8     |
| 16 bit  | i16        | u16    |
| 32 bit  | i32 (é»˜è®¤) | u32    |
| 64 bit  | i64        | u64    |
| 128 bit | i128       | u128   |
| arch    | isize      | usize  |

-   æœ‰ç¬¦å·æ•°ä»¥**è¡¥ç **å½¢å¼å­˜å‚¨ï¼›

-   `isize` å’Œ `usize` ä¾èµ–äºè¿è¡Œç¨‹åºçš„è®¡ç®—æœºæ¶æ„ã€‚

| å­—é¢å€¼         | ä¾‹            |
| -------------- | ------------- |
| Decimal        | `10_000`      |
| Hex            | `0xfe`        |
| Octal          | `0o77`        |
| Binary         | `0b1010_1000` |
| Byte (ä»… `u8`) | `b'A'`        |

-   é™¤ Byte ä»¥å¤–çš„æ‰€æœ‰å­—é¢å€¼å…è®¸ä½¿ç”¨ç±»å‹åç¼€ï¼Œå¦‚ `12_u8`ï¼Œä¹Ÿå…è®¸ä½¿ç”¨ `_` åšä¸ºåˆ†éš”ç¬¦ï¼›

-   å¯¹äºæ•´æ•°æº¢å‡ºï¼Œéä¼˜åŒ–ç¼–è¯‘æ—¶ï¼Œä¼šæ£€æŸ¥è¿™ç±»é—®é¢˜å¹¶ panicã€‚ä¼˜åŒ–ç¼–è¯‘æ—¶ä¸æ£€æŸ¥ï¼Œå¹¶æŒ‰ç…§è¡¥ç è®¡ç®—å®é™…å€¼ã€‚


#### æµ®ç‚¹å‹

Rust æœ‰ `f32` å’Œ `f64` ä¸¤ç§æµ®ç‚¹ç±»å‹ï¼Œéµå¾ª [IEEE 754](https://zh.wikipedia.org/wiki/IEEE_754) æ ‡å‡†ï¼Œå­—é¢å€¼é»˜è®¤ä¸º `f64`ã€‚

#### å¸ƒå°”å‹

`bool` è¡¨ç¤ºå¸ƒå°”ç±»å‹ï¼Œåªæœ‰ä¸¤ä¸ªå¯èƒ½çš„å€¼ï¼š`true` å’Œ `false`ã€‚

#### å­—ç¬¦ç±»å‹

`char` è¡¨ç¤ºå­—ç¬¦ç±»å‹ï¼Œå€¼ç”±å•å¼•å·åŒ…æ‹¬ã€‚

```rust
let a: char = 'a';
let b = 'ä½ ';
let c = 'ã‚';
let d = 'Î©';
let e = 'ğŸ˜…';
let f = '\u{102c0}';
```

`char` å¯ä»¥æ˜¯åˆæ³•çš„ Unicode æ ‡é‡å€¼ï¼Œä¸€ä¸ª `char` å  4 ä¸ªå­—èŠ‚ã€‚

Unicode ä¸­æœ‰ä¸€äº›å­—ç¬¦æ˜¯**é›¶å®½åº¦å­—ç¬¦**ï¼Œå’Œ `''` è¿™ç§ç©ºç™½å­—ç¬¦æ˜¯ä¸ä¸€æ ·çš„ï¼Œ**Rust æ²¡æœ‰ç©ºå€¼**ï¼Œå› æ­¤ `''` æ˜¯ä¸è¢«å…è®¸çš„ã€‚

```rust
let c = '';  // é”™è¯¯ï¼Œä¸èƒ½ä¸ºç©ºå€¼
```

å¯ä»¥å°†å­—ç¬¦å€¼èµ‹å€¼ç»™æ•´å‹å˜é‡ï¼Œä½†é™åˆ¶å¦‚ä¸‹ï¼š

-   å¿…é¡»å¢åŠ ç±»å‹å‰ç¼€ `b`ï¼›

-   åªæ”¯æŒ `u8`ã€‚

```rust
let n: u8 = b'A';   // n = 65
```

### å¤åˆç±»å‹

å¤åˆç±»å‹ç”±å¤šä¸ªå€¼ç»„åˆè€Œæˆä¸€ä¸ªç±»å‹ã€‚Rust çš„åŸç”Ÿå¤åˆç±»å‹ä¸º**å…ƒç»„**å’Œ**æ•°ç»„**ã€‚

#### å…ƒç»„ç±»å‹

å…ƒç»„æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªç›¸åŒæˆ–ä¸åŒç±»å‹å€¼çš„åˆ—è¡¨ï¼Œä¸”é•¿åº¦å›ºå®šï¼Œç±»å‹è¡¨ç¤ºä¸º `(T, U, ..)`ã€‚å¯é€šè¿‡æ¨¡å¼åŒ¹é…æ¥**è§£æ„**å…¶ä¸­çš„å€¼ï¼Œæˆ–ä½¿ç”¨ `.index` æ¥ç›´æ¥è®¿é—®å…¶ä¸­çš„å€¼ã€‚ 

```rust
let tup: (i32, f64, u8) = (100, 2.1, 20);
let (x, y, z) = tup;
assert!(x == tup.0);
```

ä¸ºäº†é¿å…æ··æ·†ï¼Œå•å…ƒç´ å…ƒç»„éœ€è¦åœ¨è¿½åŠ  `,`ï¼š

```rust
let tup = (1,);
```

æ²¡æœ‰ä»»ä½•å€¼çš„å…ƒç»„ä¸º**å•å…ƒç±»å‹**ç±»å‹ `()`ï¼Œåªæœ‰ä¸€ä¸ª**å•å…ƒå€¼** ã€‚è‹¥è¡¨è¾¾å¼æˆ–å‡½æ•°ä¸è¿”å›ä»»ä½•å€¼ï¼Œåˆ™ä¼šéšå¼è¿”å›å•å…ƒå€¼ã€‚

```rust
fn foo() {}
let empty: () = ();
let x = {};     // x = ()
let y = foo();  // y = ()
```

#### æ•°ç»„ç±»å‹

æ•°ç»„æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªç›¸åŒç±»å‹å€¼çš„åˆ—è¡¨ï¼Œä¸”é•¿åº¦å›ºå®šï¼Œç±»å‹è¡¨ç¤ºä¸º `[T; N]`ã€‚å¯é€šè¿‡ `[index]` æ¥ç›´æ¥è®¿é—®å…¶ä¸­çš„å€¼ã€‚

```rust
let arr: [i32; 5] = [1, 2, 3, 4, 5];
let x = arr[0];
let y = arr[1];
```

å¯é€šè¿‡ `[V; N]` æ¥åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º `N`ï¼Œå…ƒç´ å€¼éƒ½ä¸º `V` çš„æ•°ç»„ï¼š

```rust
let arr = [0; 5];
```

å½“å¯¹æ— æ•ˆçš„æ•°ç»„å…ƒç´ è¿›è¡Œè®¿é—®æ—¶ä¼š panicï¼š

```rust
arr[10];  // panic
```

## åŠ¨æ€å¤§å°ç±»å‹

åœ¨ç¼–è¯‘æ—¶å°±å·²çŸ¥çš„å¤§å°çš„ç±»å‹ä¸º**å›ºå®šå¤§å°ç±»å‹**ï¼Œå…·æœ‰ `Sized` traitï¼›åœ¨è¿è¡Œæ—¶æ‰çŸ¥é“å¤§å°çš„ç±»å‹ä¸º**åŠ¨æ€å¤§å°ç±»å‹**ï¼ˆDynamically Sized Typesï¼ŒDSTï¼‰ï¼Œå…·æœ‰ `?Sized` traitã€‚å¦‚åˆ‡ç‰‡ `[T]` å’Œ trait å¯¹è±¡ `dyn Trait` éƒ½æ˜¯ DSTï¼Œè¿™ç§ç±»å‹éƒ½ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œ**å¿…é¡»é€šè¿‡æŒ‡é’ˆæˆ–å¼•ç”¨æ¥é—´æ¥ä½¿ç”¨**ï¼Œå¦‚ `&[T]`ã€`&dyn Trait` å’Œ `Box<dyn Trait>`ã€‚

```rust
let s1: str = "hello";  // é”™è¯¯
let s2: &str = "world"
```

-   æŒ‡å‘ DST çš„æŒ‡é’ˆå¤§å°æ˜¯å›ºå®šçš„ï¼Œä¸”ä¸ºæŒ‡å‘ `Sized` çš„æŒ‡é’ˆå¤§å°çš„ä¸¤å€ï¼›
    -   æŒ‡å‘åˆ‡ç‰‡çš„æŒ‡é’ˆé¢å¤–å­˜å‚¨äº†åˆ‡ç‰‡çš„å…ƒç´ æ•°é‡ï¼›
    -   æŒ‡å‘ trait å¯¹è±¡çš„æŒ‡é’ˆé¢å¤–å­˜å‚¨äº† vtable çš„åœ°å€ã€‚
-   DST å¯ä»¥ä½œä¸ºå®å‚æ¥ä¼ é€’ç»™æœ‰ `?Sized` çº¦æŸçš„æ³›å‹ç±»å‹å‚æ•°ã€‚å½“å…³è”ç±»å‹çš„å£°æ˜æœ‰ `?Sized` çº¦æŸæ—¶ï¼Œä¹Ÿå¯ä»¥è¢«ç”¨äºå…³è”ç±»å‹å®šä¹‰ï¼›
-   é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•ç±»å‹å‚æ•°æˆ–å…³è”ç±»å‹éƒ½æœ‰ `Sized` çº¦æŸï¼Œé™¤éä½¿ç”¨ `?Sized` æ¥æ”¾å®½çº¦æŸï¼›
-   ä¸æ³›å‹ç±»å‹å‚æ•°ä¸åŒï¼Œç”±äº `Self: ?Sized` æ˜¯ trait å®šä¹‰ä¸­çš„é»˜è®¤çº¦æŸï¼Œå› æ­¤å¯ä»¥ä¸º DST å®ç° traitï¼›
-   ç»“æ„ä½“æœ€åä¸€ä¸ªå­—æ®µå¯ä»¥ä¸º DSTï¼Œè¿™ä½¿å¾—è¯¥ç»“æ„ä½“ä¹Ÿæ˜¯ä¸€ä¸ª DSTã€‚

>   å˜é‡ã€å‡½æ•°å‚æ•°ã€å¸¸é‡å’Œé™æ€é¡¹å¿…é¡»æ˜¯ `Sized`ã€‚

## never ç±»å‹

 `!` ä¸º **never ç±»å‹**ï¼Œä¸»è¦ç”¨äºåœ¨å‡½æ•°æ°¸ä¸è¿”å›æ—¶å……å½“è¿”å›å€¼ï¼Œè¿™ç±»å‡½æ•°ä¹Ÿè¢«ç§°ä¸º**å‘æ•£å‡½æ•°**ã€‚

```rust
fn foo() -> ! {}
```

åœ¨ match è¡¨è¾¾å¼ä¸­ï¼Œéœ€è¦è¿”å›ä¸€ä¸ªå€¼ï¼Œä¸”è¿”å›å€¼ç±»å‹å¿…é¡»ç›¸åŒã€‚

```rust
fn sample_match(val: bool) -> i32 {
    match val {
        true => 42,
        false => "error",   // é”™è¯¯
    }
}
```

é€šè¿‡è¿”å›ä¸€ä¸ª `!`ï¼Œå¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚

```rust
fn loop_with_match(val: bool) {
    loop {
        match val {
            true => {
                println!("True condition detected!");
                break;
            }
            false => loop {},
        }
    }
}
```

`loop`ã€`break`ã€`continue`ã€`panic!`ã€`std::process:exit` ä»¥åŠ `unwrap`ã€`expect` çš„å¤±è´¥æƒ…å†µä¹Ÿè¿”å›çš„æ˜¯ `!`ã€‚

`!` å®é™…ä¸Šæ˜¯æ‰€æœ‰ç±»å‹çš„å­ç±»å‹ï¼Œå› æ­¤å¯ä»¥è¢«å¼ºè½¬ä¸ºä»»ä½•å…¶å®ƒç±»å‹ã€‚

```rust
let x = loop {};
let y: u32 = x;
```

## ç±»å‹åˆ«å

ä½¿ç”¨ `type` å…³é”®å­—æ¥ç»™ç°æœ‰ç±»å‹å£°æ˜ä¸€ä¸ªç±»å‹åˆ«åã€‚

```rust
type MyType = i32;
```

`MyType` å®é™…ä¸Šæ˜¯ `i32` çš„åŒä¹‰è¯ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå…¨æ–°çš„ç±»å‹ ï¼Œè¯¥ç±»å‹çš„å€¼å°†è¢«å½“ä½œ `i32` æ¥å¯¹å¾…ã€‚

```rust
type MyType = i32;

let x: i32 = 5;
let y: MyType = 5;

println!("x + y = {}", x + y);
```

ç±»å‹åˆ«åä¸»è¦ç”¨äºå‡å°‘é‡å¤ï¼Œå¦‚ä¸€ä¸ªå¾ˆé•¿çš„ç±»å‹ï¼š

```rust
Box<dyn Fn() + Send + 'static>
```

åœ¨å‡½æ•°ç­¾åæˆ–ç±»å‹æ³¨è§£ä¸­å†™è¿™ä¸ªæ˜¯ååˆ†ç¹çä¸”å†—é•¿çš„ï¼š

```rust
let f: Box<dyn Fn() + Send + 'static> = Box::new(|| println!("hi"));
fn takes_long_type(f: Box<dyn Fn() + Send + 'static>) {}
fn returns_long_type() -> Box<dyn Fn() + Send + 'static> {}
```

é€šè¿‡ç±»å‹åˆ«åæ¥ç®€åŒ–ï¼š

```rust
type Thunk = Box<dyn Fn() + Send + 'static>;
let f: Thunk = Box::new(|| println!("hi"));
fn takes_long_type(f: Thunk) {}
fn returns_long_type() -> Thunk {}
```

ç±»å‹åˆ«åä¹Ÿå¸¸ä¸ `Result<T, E>` ç»“åˆä½¿ç”¨æ¥å‡å°‘é‡å¤ã€‚

```rust
type Result<T> = std::result::Result<T, Box<dyn std::error::Error>>;

fn inverse_number(num: f64) -> Result<f64> {
    if num == 0.0 {
        Err(Box::new(std::io::Error::new(
            std::io::ErrorKind::InvalidInput,
            "Cannot divide by zero",
        )))
    } else {
        Ok(1.0 / num)
    }
}
```

å…ƒç»„ç»“æ„ä½“å’Œå•å…ƒç»“æ„ä½“çš„ç±»å‹åˆ«å**ä¸èƒ½ç”¨äºå……å½“è¯¥ç±»å‹çš„æ„é€ å‡½æ•°**ã€‚

```rust
struct MyStruct(i32);
use MyStruct as UseAlias;
type TypeAlias = MyStruct;

fn main() {
    let _ = UseAlias(5);
    let _ = TypeAlias(5); // é”™è¯¯
}
```

## å­—ç¬¦ä¸²

Rust ä¸­ä¸»è¦æœ‰ `str` å’Œ `String` ä¸¤ç§å­—ç¬¦ä¸²ç±»å‹ï¼Œå…¶ä¸­ `str` æ˜¯åŸç”Ÿç±»å‹ï¼Œå­˜å‚¨åœ¨æ ˆä¸Šï¼Œ`String` å­˜å‚¨åœ¨å †ä¸Šã€‚è¿™ä¸¤ç§å€¼çš„è¡¨ç¤ºæ–¹æ³•ä¸ `[u8]` ç›¸åŒï¼Œä¸”éƒ½ä¿è¯æ•°æ®æ˜¯æœ‰æ•ˆçš„ UTF-8 åºåˆ—ã€‚ç”±äº `str` æ˜¯ä¸€ä¸ª DSTï¼Œå…·æœ‰ `?Sized` traitï¼Œå› æ­¤åªèƒ½é€šè¿‡æŒ‡é’ˆç±»å‹å®ä¾‹åŒ–å¹¶ä½¿ç”¨ï¼Œå¦‚ `&str`ã€‚

```rust
let s1: &str = "hello";  // å®é™…ä¸Šä¼šè¢«æ¨å¯¼ä¸º &'static str
let s2: &'static str = "world";
let s3: String = String::from("haha");
let s4: &str = &s3;
```

`&str` å’Œ `String`ï¼š

-   `&str`ï¼šä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œè¡¨ç¤ºå¯¹æŸä¸ªå­—ç¬¦ä¸²æ•°æ®çš„ä¸å¯å˜å¼•ç”¨ï¼›
-   `String`ï¼šåœ¨å †ä¸Šåˆ†é…çš„å¯å˜å­—ç¬¦ä¸²ã€‚

`&str` å’Œ `&'static str`ï¼š

-   ä¸æ˜¯æ‰€æœ‰çš„ `&str` éƒ½æ˜¯ `&'static str`ã€‚ä¸€ä¸ªå­—ç¬¦ä¸²å­—é¢é‡å¦‚ `"hello"`ï¼Œåˆ™é»˜è®¤å…·æœ‰ `'statuc` ç”Ÿå‘½å‘¨æœŸï¼›
-   è‹¥ä» `String` åˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡ï¼Œé‚£ä¹ˆè¯¥åˆ‡ç‰‡çš„ç”Ÿå‘½å‘¨æœŸåˆ™ä¸æ˜¯ `'static`ã€‚

å¤§å¤šæ•°æ—¶å€™ï¼Œå¯ä»¥ä¸ç”¨æ˜¾å¼æŒ‡æ˜ `&str` æˆ– `&'static str`ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ¨å¯¼å…¶ç”Ÿå‘½å‘¨æœŸã€‚

### åŸå§‹å­—ç¬¦ä¸²

ä»¥ `r` æˆ– `r#` çš„å½¢å¼æ¥è¡¨ç¤ºåŸå§‹å­—ç¬¦ä¸²ï¼Œä¸ä¼šå¯¹å­—ç¬¦è¿›è¡Œè½¬ä¹‰ã€‚

```rust
let s1 = r"hello\t\nhello";
let s2 = r##"hello\t\nhello"##;
let s3 = r###"hello\t\nhello"###;
let s4 = r####"hello\t\nhello"####;
```

å½“ä½¿ç”¨ `r#` çš„å½¢å¼æ—¶ï¼Œéœ€è¦ç¡®ä¿å‰å `#` çš„æ•°é‡æ˜¯ä¸€è‡´çš„ã€‚

## è¯­å¥å’Œè¡¨è¾¾å¼

Rust æ˜¯ä¸€ç§åŸºäºè¡¨è¾¾å¼çš„è¯­è¨€ï¼Œæ±‚å€¼éƒ½é€šè¿‡è¡¨è¾¾å¼å®Œæˆã€‚è¡¨è¾¾å¼å¯å†…åµŒåˆ°å¦ä¸€ä¸ªè¡¨è¾¾å¼ä¸­ï¼Œæ±‚å€¼è§„åˆ™åŒ…æ‹¬æŒ‡å®šè¡¨è¾¾å¼äº§ç”Ÿçš„å€¼å’ŒæŒ‡å®šå…¶å„ä¸ªå­è¡¨è¾¾å¼çš„æ±‚å€¼é¡ºåºã€‚è¯­å¥åˆ™ä¸»è¦ç”¨äºåŒ…å«è¡¨è¾¾å¼ï¼Œä»¥åŠæ˜¾å¼å®‰æ’è¡¨è¾¾å¼çš„æ±‚å€¼é¡ºåºã€‚è¡¨è¾¾å¼å’Œè¯­å¥çš„æ˜¾è‘—åŒºåˆ«ä¸ºè¡¨è¾¾å¼**è®¡ç®—å¹¶äº§ç”Ÿä¸€ä¸ªå€¼**ï¼Œè¯­å¥æ‰§è¡Œæ“ä½œä½†**ä¸è¿”å›å€¼**ã€‚

### å£°æ˜è¯­å¥

å£°æ˜è¯­å¥æ˜¯åœ¨å…¶å°é—­è¯­å¥å—å†…éƒ¨å¼•å…¥ä¸€ä¸ªæˆ–å¤šä¸ªåç§°çš„è¯­å¥ï¼ŒåŒ…å«ä¸¤ç§ï¼šç¨‹åºé¡¹å£°æ˜å’Œ `let` å£°æ˜ã€‚

#### ç¨‹åºé¡¹å£°æ˜

ç¨‹åºé¡¹å£°æ˜è¯­å¥ä¸ä¼šéšå¼æ•è·å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„å‡½æ•°å‚æ•°ã€æ³›å‹å‚æ•°å’Œå±€éƒ¨å˜é‡ã€‚

```rust
fn foo(a: i32) {
    let v = a + 1;

    fn bar() {
        a + v;  // é”™è¯¯ï¼Œå‚æ•° a å’Œå±€éƒ¨å˜é‡ v éƒ½ä¸èƒ½è¢«æ•è·
    }
}
```

#### let å£°æ˜

`let` è¯­å¥é€šè¿‡ä¸å¯åé©³çš„æ¨¡å¼å¼•å…¥äº†ä¸€ç»„æ–°çš„å˜é‡ã€‚é™¤éè¢«å¦ä¸€ä¸ªå˜é‡å£°æ˜éšè—ï¼Œå¦åˆ™ä»»ä½•å˜é‡ä»å£°æ˜ç‚¹åˆ°å°é—­å—ä½œç”¨åŸŸçš„ç»“æŸéƒ½æ˜¯å¯è§çš„ã€‚`let` è¿˜é€šè¿‡**ç»‘å®š**ä½¿å€¼å’Œå˜é‡å…³è”èµ·æ¥ï¼Œä»»ä½•å€¼åªæœ‰è¢«ç»‘å®šåï¼Œæ‰èƒ½ç»§ç»­å­˜åœ¨ï¼Œå¦åˆ™å…¶ç”Ÿå‘½å‘¨æœŸä¼šåœ¨å½“å‰è¯­å¥ç»“æŸæ—¶ç»“æŸã€‚

### è¡¨è¾¾å¼è¯­å¥

è¡¨è¾¾å¼è¯­å¥æ˜¯å¯¹è¡¨è¾¾å¼æ±‚å€¼å¹¶å¿½ç•¥å…¶ç»“æœçš„è¯­å¥ã€‚

```rust
1 + 2;  // å¿½ç•¥è®¡ç®—å€¼
```

### è¯­å¥å±æ€§

è¯­å¥å¯ä»¥æœ‰å¤–éƒ¨å±æ€§ï¼Œåœ¨è¯­å¥ä¸­æœ‰æ„ä¹‰çš„å±æ€§æ˜¯ `cfg` å’Œ lint æ£€æŸ¥å±æ€§ã€‚

```rust
#[cfg(target_os = "windows")]
#[allow(unused)]
let greet = "Hello Windows!";

#[cfg(target_os = "linux")]
let greet = "Hello Linux!";
```

### æ§åˆ¶æµè¡¨è¾¾å¼

Rust ä¸­æœ‰ 4 ä¸­æ§åˆ¶æµè¡¨è¾¾å¼ï¼š`if`ã€`loop`ã€`while` å’Œ `for`ï¼Œå…¶ä¸­çš„æ¡ä»¶**å¿…é¡»æ˜¯ `bool` å€¼**ã€‚

`if` ç”¨äºæ§åˆ¶åˆ†æ”¯ï¼Œå¯ä¸ `else` æ­é…ä½¿ç”¨ã€‚

```rust
let mut x = 10;
x = if x < 3 {
    x + 1
} else if x < 6 {
    x + 2
} else {
    x + 3
};
```

`loop` ç”¨äºæ— é™å¾ªç¯ï¼Œ`while` ç”¨äºæ¡ä»¶å¾ªç¯ï¼Œ`for` ç”¨äºéå†ï¼›`break` ç”¨äºæå‰è·³å‡ºå¾ªç¯ï¼Œ`continue` ç”¨äºæå‰ç»“æŸæœ¬æ¬¡å¾ªç¯ã€‚ç”±äº `loop` é»˜è®¤è¿”å›ä¸€ä¸ª `!`ï¼Œå› æ­¤**åªæœ‰ `loop` èƒ½å¤Ÿä½¿ç”¨ `break + å€¼` çš„å½¢å¼æ¥è¿”å›ä¸€ä¸ªå€¼**ã€‚

```rust
// loop
let mut x = 0;
let y = loop {
    x = x + 1;
    if x > 10 {
        break x;
    }
};

// while
let arr = [1, 2, 3];
let mut i = 0;
while i < arr.len() {
    println!("{}", arr[i]);
    i += 1;
}

// for
for e in 1..4 {
    println!("{e}");
}
```

`break` å’Œ `continue` åªèƒ½ç”¨äºå†…å±‚å¾ªç¯ï¼Œä½¿ç”¨ `'` + `æ ‡è¯†ç¬¦` çš„å½¢å¼å®šä¹‰ä¸€ä¸ª**å¾ªç¯æ ‡ç­¾**ï¼Œåˆ™å¯ä½œç”¨äºå¤–å±‚å¾ªç¯ã€‚

```rust
'out: loop {
    loop {
        println!("Do this");
        break 'out;
    }
    println!("Never do");
}
println!("Do this after loop");
```

### å…¶å®ƒè¡¨è¾¾å¼

Rust ä¸­çš„è¡¨è¾¾å¼æœ‰å¾ˆå¤šç§ï¼Œä¸»è¦æœ‰ï¼š

-   å­—é¢é‡è¡¨è¾¾å¼
-   è·¯å¾„è¡¨è¾¾å¼
-   å—è¡¨è¾¾å¼
-   è¿ç®—ç¬¦è¡¨è¾¾å¼
-   ç»“æ„ä½“è¡¨è¾¾å¼
-   è°ƒç”¨è¡¨è¾¾å¼
-   é—­åŒ…è¡¨è¾¾å¼
-   åŒºé—´è¡¨è¾¾å¼
-   æ¨¡å¼åŒ¹é…è¡¨è¾¾å¼
-   è¿”å›è¡¨è¾¾å¼
-   å¼‚æ­¥è¡¨è¾¾å¼
-   ...

>   æ›´å¤šå…³äºè¡¨è¾¾å¼çš„ä¿¡æ¯ï¼Œå¯å‚è€ƒ [Rust è¡¨è¾¾å¼](https://minstrel1977.gitee.io/rust-reference/expressions.html)ã€‚

# 2 æ‰€æœ‰æƒ

æ‰€æœ‰æƒæ˜¯ Rust ç”¨æ¥ç®¡ç†å†…å­˜çš„æœºåˆ¶ã€‚

## æ‰€æœ‰æƒè§„åˆ™

- Rust ä¸­çš„æ¯ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ª**æ‰€æœ‰è€…**ï¼›
- å€¼**æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª**æ‰€æœ‰è€…ï¼›
- å½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒã€‚

### ä½œç”¨åŸŸ

ä½œç”¨åŸŸæ˜¯ä¸€ä¸ªé¡¹åœ¨ç¨‹åºä¸­æœ‰æ•ˆçš„èŒƒå›´ã€‚

```rust
let s1 = "hello";       // s1 ç”Ÿæ•ˆ
{                       // ä½œç”¨åŸŸå¼€å§‹
    let s2 = "world";   // s2 ç”Ÿæ•ˆ
}                       // ä½œç”¨åŸŸç»“æŸï¼Œs2 æ— æ•ˆï¼Œs1 æœ‰æ•ˆ
```

å½“å˜é‡è¿›å…¥ä½œç”¨åŸŸæ—¶ï¼Œå°±æ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸€ç›´æŒç»­åˆ°ç¦»å¼€ä½œç”¨åŸŸä¸ºæ­¢ã€‚

### å †ä¸Šçš„æ•°æ®

åœ¨ç¼–è¯‘æ—¶å°±çŸ¥é“çš„å¤§å°çš„æ•°æ®é€šå¸¸æ”¾åœ¨æ ˆä¸Šï¼Œè€Œå˜åŒ–çš„æˆ–è¿è¡Œæ—¶æ‰çŸ¥é“å¤§å°çš„æ•°æ®é€šå¸¸æ”¾åœ¨å †ä¸Šã€‚`String` ç±»å‹å°±æ˜¯ä¸€ç§æ”¾åœ¨å †ä¸Šçš„æ•°æ®ã€‚

```rust
let mut s = String::from("hello");
s.push_str(", world!");
```

`&str` åœ¨ç¼–è¯‘æ—¶å°±çŸ¥é“å…¶å†…å®¹ï¼Œè¢«ç›´æ¥ç¡¬ç¼–ç è¿›å¯æ‰§è¡Œæ–‡ä»¶çš„åªè¯»åŒºå—ä¸­ï¼Œå› æ­¤æ•ˆç‡é«˜ï¼Œä½†ä¹Ÿä¸å¯å˜ã€‚

å¯¹äº `String` ç±»å‹ï¼Œä¸ºäº†æ”¯æŒä¸€ä¸ªå¯å˜çš„æ–‡æœ¬ç‰‡æ®µï¼Œéœ€è¦åœ¨å †ä¸Šåˆ†é…ä¸€å—åœ¨ç¼–è¯‘æ—¶æœªçŸ¥å¤§å°çš„å†…å­˜æ¥å­˜æ”¾å†…å®¹ï¼Œè¿™éœ€è¦ï¼š

- åœ¨è¿è¡Œæ—¶å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼›
- åœ¨å¤„ç†å®Œåé‡Šæ”¾å†…å­˜çš„æ–¹æ³•ã€‚

åœ¨æœ‰åƒåœ¾å›æ”¶çš„è¯­è¨€ä¸­ï¼Œ GC ç®¡ç†è¿™éƒ¨åˆ†å†…å­˜å†…å­˜ï¼›åœ¨æ²¡æœ‰ GC çš„è¯­è¨€ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†ã€‚æå‰é‡Šæ”¾å’Œé‡å¤é‡Šæ”¾éƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼Œè¿™éœ€è¦ç²¾ç¡®é…å¯¹æ¯ä¸€ä¸ªç”³è¯·å’Œé‡Šæ”¾ã€‚

**æ‰€æœ‰æƒçš„ç­–ç•¥ä¸ºï¼šå˜é‡ç¦»å¼€ä½œç”¨åŸŸåå†…å­˜å°±è‡ªåŠ¨é‡Šæ”¾ã€‚**

```rust
{
    let s = String::from("hello");  // s ä»æ­¤å¤„å¼€å§‹ç”Ÿæ•ˆ
}                                   // s æ— æ•ˆ
```

å½“å˜é‡ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œåœ¨ç»“å°¾çš„ `}` å¤„å°†è‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•° `drop` é‡Šæ”¾å†…å­˜ã€‚

>   åœ¨ C++ ä¸­ï¼Œè¿™ç§åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶é‡Šæ”¾**èµ„æº**çš„æ¨¡å¼è¢«ç§°ä½œ RAIIï¼ˆResource Acquisition Is Initializationï¼Œèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰ã€‚èµ„æºå¯ä»¥æ˜¯å†…å­˜åœ°å€ï¼ŒåŒ…å«æŸä¸ªå€¼çš„å˜é‡ã€å…±äº«å†…å­˜å¼•ç”¨ã€æ–‡ä»¶å¥æŸ„ã€ç½‘ç»œå¥—æ¥å­—æˆ–æ•°æ®åº“è¿æ¥å¥æŸ„ç­‰ã€‚

### æ•°æ®äº¤äº’ï¼šç§»åŠ¨

Rust ä¸­çš„å¤šä¸ªå˜é‡å¯ä»¥é‡‡ç”¨ä¸€ç§ç‹¬ç‰¹çš„æ–¹å¼ä¸åŒä¸€æ•°æ®äº¤äº’ã€‚

```rust
let x = 5;
let y = x;
let s1 = String::from("hello");
let s2 = s1;
```

`x` å’Œ `y` éƒ½æ˜¯å›ºå®šå¤§å°ç±»å‹ï¼Œç›´æ¥å­˜æ”¾åœ¨æ ˆä¸Šï¼Œå› æ­¤ `y` è·å¾— `x` çš„æ‹·è´ã€‚è€Œå¯¹äº `String`ï¼Œ`s2` å¹¶ä¸ä¼šè·å¾—ä¸€ä¸ª `s1` çš„æ‹·è´ã€‚

`String` ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š**æŒ‡å‘å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€é•¿åº¦å’Œå®¹é‡**ã€‚è¿™ä¸€ç»„æ•°æ®å­˜å‚¨åœ¨æ ˆä¸Šï¼Œå †ä¸Šåˆ™å­˜æ”¾å­—ç¬¦ä¸²çš„å†…å®¹ã€‚

![String åœ¨å†…å­˜ä¸­çš„è¡¨ç¤º](https://raw.githubusercontent.com/genskyff/image-hosting/main/images/202203232352837.png)

å½“æŠŠ `s1` èµ‹å€¼ç»™ `s2` æ—¶ï¼Œ`String` åœ¨æ ˆä¸Šçš„æ•°æ®è¢«å¤åˆ¶äº†ï¼Œè€Œå †ä¸Šçš„æ•°æ®æ²¡æœ‰å¤åˆ¶ã€‚åªå¤åˆ¶æŒ‡é’ˆã€é•¿åº¦å’Œå®¹é‡è¿™äº›æ ˆä¸Šçš„æ•°æ®å¯çœ‹åš**æµ…æ‹·è´**ï¼Œè€ŒæŠŠæ ˆä¸Šå’Œå †ä¸Šçš„æ•°æ®éƒ½è¿›è¡Œå¤åˆ¶å¯çœ‹åš**æ·±æ‹·è´**ã€‚Rust ä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®çš„æ·±æ‹·è´ï¼Œå› æ­¤ä»»ä½•è‡ªåŠ¨çš„å¤åˆ¶å¯ä»¥è¢«è®¤ä¸ºå¯¹è¿è¡Œæ—¶æ€§èƒ½å½±å“è¾ƒå°ã€‚

![s1 å’Œ s2 æŒ‡å‘åŒä¸€å—å †å†…å­˜](https://raw.githubusercontent.com/genskyff/image-hosting/main/images/202203240158188.png)

æŒ‰ç…§æ‰€æœ‰æƒè§„åˆ™ï¼Œå½“å˜é‡ç¦»å¼€ä½œç”¨åŸŸåï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•°ï¼Œä½† `s1` å’Œ `s2` éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªå †å†…å­˜ï¼Œè¿™å°±ä¼šå¯¼è‡´äºŒæ¬¡é‡Šæ”¾ã€‚ä¸ºäº†ç¡®ä¿å†…å­˜å®‰å…¨ï¼Œè¿™ç§æƒ…å†µä¸‹å°±è®¤ä¸º `s1` ä¸å†æœ‰æ•ˆï¼Œå› æ­¤ `s1` ä¸éœ€è¦åœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶è¿›è¡Œæ¸…ç†ã€‚

```rust
let s1 = String::from("hello");
let s2 = s1;        // s1 å¤±æ•ˆ
println!("{s1}");   // é”™è¯¯
```

è¿™ç§è¡Œä¸ºå¯ä»¥çœ‹ä½œ `s1` è¢«ç§»åŠ¨åˆ°äº† `s2` ä¸­ï¼Œå› æ­¤è¢«ç§°ä¸º**ç§»åŠ¨**ã€‚å½“æŒæœ‰å †ä¸­æ•°æ®çš„å˜é‡ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå…¶å€¼å°†é€šè¿‡ `drop` å‡½æ•°è¢«æ¸…ç†æ‰ï¼Œ**é™¤éæ•°æ®è¢«ç§»åŠ¨ä¸ºå¦ä¸€ä¸ªå˜é‡æ‰€æœ‰**ã€‚

### æ•°æ®äº¤äº’ï¼šå…‹éš†

è‹¥ç¡®å®éœ€è¦å¤åˆ¶ `String` ä¸­å †ä¸Šçš„æ•°æ®ï¼Œè€Œä¸ä»…ä»…æ˜¯æ ˆä¸Šçš„æ•°æ®ï¼Œå¯ä»¥è°ƒç”¨ `clone` å‡½æ•°ã€‚

```rust
let s1 = String::from("hello");
let s2 = s1.clone();
println!("{s1}, {s2}");
```

ç”±äº `clone` å‡½æ•°éœ€è¦å¤åˆ¶å †ä¸Šçš„æ•°æ®ï¼Œå› æ­¤ä¼šå½±å“è¿è¡Œæ—¶æ€§èƒ½ã€‚

### Copy å’Œ Clone

ä»»ä½•èƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸå°±çŸ¥é“å¤§å°çš„ç±»å‹ï¼Œéƒ½å…·æœ‰ `Copy` traitï¼Œåœ¨èµ‹å€¼æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œå¤åˆ¶ã€‚è€Œåœ¨å †ä¸Šçš„æ•°æ®åˆ™ä¸å…·æœ‰è¯¥ traitï¼Œä½†å¯èƒ½å…·æœ‰ `Clone` traitï¼Œå¯ä»¥æ˜¾å¼è°ƒç”¨ `clone` å‡½æ•°æ¥å¤åˆ¶æ•°æ®ã€‚

å¯¹äºå¼•ç”¨ç±»å‹ï¼Œæ‰€æœ‰çš„ `&T` éƒ½å…·æœ‰ `Copy` traitï¼Œè€Œ `&mut T` åˆ™ä¸å…·æœ‰ã€‚

### æ‰€æœ‰æƒä¸å‡½æ•°

å°†å€¼ä¼ é€’ç»™å‡½æ•°åœ¨è¯­ä¹‰ä¸Šä¸ç»™å˜é‡èµ‹å€¼ç›¸ä¼¼ï¼Œå‘å‡½æ•°ä¼ é€’å€¼å¯èƒ½ä¼šç§»åŠ¨æˆ–å¤åˆ¶ã€‚

```rust
fn print_number(n: i32) {
    println!("{n}");
}   // n è¢«ç§»å‡ºä½œç”¨åŸŸ

fn print_string(s: String) { // s ä½œç”¨åŸŸå¼€å§‹
    println!("{s}");
}   // s è¢«ç§»å‡ºä½œç”¨åŸŸå¹¶è°ƒç”¨ drop å‡½æ•°

fn main() {
    let n = 1;
    let s = String::from("hello");
    print_number(n);      // n çš„å€¼ç§»åŠ¨åˆ°å‡½æ•°ä¸­ï¼Œä½† i32 æ˜¯ Copy çš„ï¼Œå¯åœ¨ä¹‹åç»§ç»­ä½¿ç”¨
    print_string(s);      // s çš„å€¼ç§»åŠ¨åˆ°å‡½æ•°ä¸­ï¼Œä¹‹åä¸èƒ½ç»§ç»­ä½¿ç”¨
    println!("{n}");      // n ä¾æ—§æœ‰æ•ˆ
    println!("{s}");      // s å·²ç»æ— æ•ˆï¼Œæ­¤è¡Œä»£ç é”™è¯¯
}   // n è¢«ç§»å‡ºä½œç”¨åŸŸï¼Œs çš„å€¼å·²è¢«ç§»èµ°ï¼Œä¸ä¼šæœ‰ç‰¹æ®Šæ“ä½œ
```

### è¿”å›å€¼ä¸ä½œç”¨åŸŸ

è¿”å›å€¼ä¹Ÿå¯ä»¥è½¬ç§»æ‰€æœ‰æƒã€‚

```rust
fn ret() -> String {
    let s = String::from("hello");
    s   // å°† s çš„å€¼ç§»å‡ºï¼Œè¿”å›ç»™è°ƒç”¨å®ƒçš„å‡½æ•°
}

fn take_and_ret(ts: String) -> String {
    ts  // å°† ts çš„å€¼ç§»å‡ºï¼Œè¿”å›ç»™è°ƒç”¨å®ƒçš„å‡½æ•°
}

fn main() {
    let s1 = ret();             // å‡½æ•°å°†è¿”å›å€¼ç§»åŠ¨åˆ° s1
    let s2 = String::from("hello");
    let s3 = take_and_ret(s2);  // s2 çš„å€¼è¢«ç§»åŠ¨åˆ°å‡½æ•°ä¸­ï¼Œå‡½æ•°å°†è¿”å›å€¼ç§»åŠ¨åˆ° s3
}   // s1ã€s3 è¢«ç§»å‡ºä½œç”¨åŸŸï¼Œè°ƒç”¨ drop å‡½æ•°ï¼Œs2 çš„å€¼å·²è¢«ç§»èµ°ï¼Œä¸ä¼šæœ‰ç‰¹æ®Šæ“ä½œ
```

## å¼•ç”¨å’Œå€Ÿç”¨

### å¼•ç”¨ç±»å‹

ä»¥ä¸€ä¸ªå¯¹è±¡çš„**å¼•ç”¨**ä½œä¸ºå‚æ•°è€Œä¸æ˜¯è·å–å€¼çš„æ‰€æœ‰æƒï¼Œç±»å‹è¡¨ç¤ºä¸º `&T`ï¼Œåˆ›å»ºä¸€ä¸ªå¼•ç”¨çš„è¡Œä¸ºç§°ä¸º**å€Ÿç”¨**ã€‚

```rust
fn str_len(s: &String) -> usize {   // s æ˜¯å¯¹ String çš„å¼•ç”¨
    s.len()
}   // s ç¦»å¼€ä½œç”¨åŸŸï¼Œä½†å®ƒå¹¶ä¸æ‹¥æœ‰å¼•ç”¨å€¼çš„æ‰€æœ‰æƒï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ç‰¹æ®Šæ“ä½œ

fn main() {
    let s1 = String::from("hello");
    let len = str_len(&s1);
    println!("s1: {s1}, len: {len}");
}
```

ä¼ é€’ `&s1` ç»™å‡½æ•°ï¼ŒåŒæ—¶åœ¨å‡½æ•°å®šä¹‰ä¸­ï¼Œè·å– `&String` è€Œä¸æ˜¯ `String`ã€‚`&` ç¬¦å·è¡¨ç¤ºå¼•ç”¨ï¼Œå…è®¸ä½¿ç”¨å€¼ä½†ä¸è·å–å…¶æ‰€æœ‰æƒã€‚å› ä¸ºå¹¶ä¸æ‹¥æœ‰è¿™ä¸ªå€¼ï¼Œå½“å¼•ç”¨ç¦»å¼€ä½œç”¨åŸŸæ—¶å…¶æŒ‡å‘çš„å€¼ä¹Ÿä¸ä¼šè¢«ä¸¢å¼ƒã€‚å‡½æ•°ç­¾åä½¿ç”¨ `&` æ¥è¡¨æ˜å‚æ•° `s` çš„ç±»å‹æ˜¯ä¸€ä¸ªå¼•ç”¨ã€‚

![å¯¹è±¡çš„å¼•ç”¨](https://raw.githubusercontent.com/genskyff/image-hosting/main/images/202203240005250.png)

å¼•ç”¨å’ŒæŒ‡é’ˆç±»ä¼¼ï¼Œå…¶ä¿å­˜äº†ä¸€ä¸ªåœ°å€ï¼Œå¯ä»¥ç”±æ­¤è®¿é—®å‚¨å­˜äºè¯¥åœ°å€çš„æ•°æ®ï¼Œå¹¶ä¸”ç¡®ä¿æŒ‡å‘çš„å€¼æ˜¯æœ‰æ•ˆçš„ã€‚

>   ä¸ `&` ç›¸åçš„æ“ä½œæ˜¯**è§£å¼•ç”¨**ï¼Œä½¿ç”¨è§£å¼•ç”¨è¿ç®—ç¬¦ `*`ã€‚

### åŒºåˆ†å¼•ç”¨å’Œå€Ÿç”¨

```rust
let s = String::new();
let s1 = &s;
```

`s1` æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå®ƒå€Ÿç”¨äº†æ¥è‡ª `s` çš„å€¼ï¼Œå³æ¥è‡ª `String` çš„å€Ÿç”¨ï¼Œå› æ­¤ `s1` çš„ç±»å‹ä¸º `&String`ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å¯ä»¥ä¸ç”¨ä¸¥æ ¼åŒºåˆ†è¿™ä¸¤è€…ã€‚

### å¯å˜å¼•ç”¨

å˜é‡é»˜è®¤æ˜¯ä¸å¯å˜çš„ï¼Œå¼•ç”¨ä¹Ÿä¸€æ ·ï¼Œ**é»˜è®¤ä¸å…è®¸ä¿®æ”¹å¼•ç”¨çš„å€¼**ã€‚

```rust
let s = String::from("hello");
let ps = &s;
ps.push_str(" world!");  // é”™è¯¯ï¼Œå¼•ç”¨é»˜è®¤ä¸å¯å˜
```

ä½¿ç”¨ `mut` ä¿®é¥°å˜é‡å’Œå¼•ç”¨ï¼Œå¯ä»¥ä½¿å¼•ç”¨å¯å˜ï¼Œç±»å‹è¡¨ç¤ºä¸º `&mut T`ã€‚

```rust
let mut s = String::from("hello");
let ps = &mut s;
ps.push_str(" world!");
```

**`mut` å˜é‡å¯è¢«å¼•ç”¨ä¸º `&` æˆ– `&mut`ï¼Œé `mut` å˜é‡åªèƒ½è¢«å¼•ç”¨ä¸º `&`ã€‚**

```rust
let x = 1;
let mut y = 2;
let rx = &mut x;    // é”™è¯¯ï¼Œé mut å˜é‡åªèƒ½è¢«å¼•ç”¨ä¸º &
let ry = &y;        // æ­£ç¡®ï¼Œå¯ä»¥å¯¹ mut å˜é‡å¼•ç”¨ä¸º &
```

`mut` å˜é‡æŒ‡çš„æ˜¯è¯¥å˜é‡æœ¬èº«æ˜¯å¦å¯å˜ï¼Œ`mut` å¼•ç”¨æŒ‡çš„æ˜¯æ‰€å¼•ç”¨çš„å€¼æ˜¯å¦å¯å˜ã€‚

```rust
let x = 1;
let y = 2;
let mut rx = &x;
rx = &y;    // æ”¹å˜çš„æ˜¯å˜é‡è‡ªèº«

let mut z = 3;
let rz = &mut z;
*rz = 6;    // æ”¹å˜çš„æ˜¯å¼•ç”¨çš„å€¼
```

è‹¥å˜é‡æœ¬èº«çš„ç±»å‹æ˜¯å¼•ç”¨ï¼Œåˆ™ `&` å’Œ `&mut` æ˜¯ä¸¤ç§æ•°æ®ç±»å‹ï¼Œ**å› æ­¤ä¸€ä¸ª `mut` å˜é‡çš„ç±»å‹ä¸èƒ½åœ¨ `&` å’Œ `&mut` ä¹‹é—´åˆ‡æ¢ã€‚**

```rust
let mut x = 1;
let mut y = 2;
let mut rx = &mut x;    // rx çš„ç±»å‹è¢«ç¡®å®šä¸º &mut
rx = &y;                // é”™è¯¯ï¼Œä¸èƒ½å°†ä¸€ä¸ª & ç±»å‹èµ‹å€¼ç»™ rx
let rx = &y;            // æ­£ç¡®ï¼Œå¯ä»¥é€šè¿‡éšè—æ¥æ”¹å˜ rx çš„ç±»å‹
```

**å€¼åœ¨åŒä¸€ä½œç”¨åŸŸå†…æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨**ï¼Œè¿™ä¸ªé™åˆ¶å¯ä»¥é¿å…æ•°æ®ç«äº‰ã€‚

```rust
let mut s = String::from("hello");
let r1 = &mut s;
let r2 = &mut s;    // é”™è¯¯
```

é€šè¿‡åˆ›å»ºæ–°çš„ä½œç”¨åŸŸï¼Œä»¥å…è®¸æ‹¥æœ‰å¤šä¸ªå¯å˜å¼•ç”¨ã€‚

```rust
let mut s = String::from("hello");
{
    let r1 = &mut s;
}   // r1 ç¦»å¼€ä½œç”¨åŸŸï¼Œr2 å¯ä»¥æ‹¥æœ‰ s çš„å¯å˜å¼•ç”¨
let r2 = &mut s;
```

**ä¸èƒ½åœ¨æ‹¥æœ‰ä¸å¯å˜å¼•ç”¨çš„åŒæ—¶æ‹¥æœ‰å¯å˜å¼•ç”¨**ï¼Œ**ä½†å¯ä»¥æ‹¥æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨**ã€‚

```rust
let mut s = String::from("hello");
let r1 = &s;
let r2 = &s;
let r3 = &mut s;    // é”™è¯¯ï¼Œå·²æœ‰ä¸å¯å˜å¼•ç”¨
```

ä¸€ä¸ªå¼•ç”¨çš„ä½œç”¨åŸŸä»å£°æ˜çš„åœ°æ–¹å¼€å§‹ä¸€ç›´æŒç»­åˆ°**æœ€åä¸€æ¬¡ä½¿ç”¨ä¸ºæ­¢**ã€‚å¦‚æœ€åä¸€æ¬¡ä½¿ç”¨ä¸å¯å˜å¼•ç”¨åœ¨å£°æ˜å¯å˜å¼•ç”¨ä¹‹å‰ï¼Œæˆ–ä»…åœ¨æœ€åä¸€æ¬¡ä½¿ç”¨å¯å˜å¼•ç”¨**ä¹‹å**ï¼ŒåŸå§‹æ•°æ®æ‰å¯ä»¥å†æ¬¡å¯å˜æˆ–ä¸å¯å˜çš„å€Ÿç”¨ã€‚ç¼–è¯‘å™¨åœ¨ä½œç”¨åŸŸç»“æŸä¹‹å‰åˆ¤æ–­ä¸å†ä½¿ç”¨çš„å¼•ç”¨çš„èƒ½åŠ›ç§°ä¸º**éè¯æ³•ä½œç”¨åŸŸç”Ÿå‘½å‘¨æœŸ**ã€‚

```rust
let mut s = String::from("hello");
let r1 = &s;
let r2 = &s;
println!("{r1}, {r2}");   // æœ€åä¸€æ¬¡ä½¿ç”¨å¼•ç”¨ï¼Œr1ã€r2 ä½œç”¨åŸŸç»“æŸ
let r3 = &mut s;          // å¯ä»¥ä½¿ç”¨
println!("{r3}");
```

åœ¨å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œè¢«å¼•ç”¨çš„å˜é‡æœ¬èº«ä¸å…è®¸æ”¹å˜ï¼Œä¸ç®¡æ˜¯ `&` è¿˜æ˜¯ `&mut`ã€‚

```rust
let mut x = 1;
let rx = &mut x;              // äº¦æˆ–æ˜¯ &x
x = 2;                        // é”™è¯¯ï¼Œä¸å…è®¸ x è‡ªèº«å†…å®¹å˜åŒ–
println!("{rx}");
```

### å¼•ç”¨è§„åˆ™

- åœ¨ä»»æ„æ—¶åˆ»ï¼Œè¦ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œè¦ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä¸å¯å˜å¼•ç”¨ï¼›
- å¼•ç”¨çš„ä½œç”¨åŸŸæŒç»­åˆ°æœ€åä¸€æ¬¡**ä½¿ç”¨**ä¸ºæ­¢ï¼›
- å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆã€‚

### æ‚¬å‚å¼•ç”¨

åœ¨æŸäº›è¯­è¨€ä¸­ï¼Œå¯ä»¥åœ¨é‡Šæ”¾å†…å­˜æ—¶ä¿ç•™æŒ‡å‘å®ƒçš„æŒ‡é’ˆä»è€Œé”™è¯¯åœ°ç”Ÿæˆä¸€ä¸ªæ‚¬å‚æŒ‡é’ˆã€‚**æ‚¬å‚æŒ‡é’ˆ**æ˜¯å…¶æŒ‡å‘çš„å†…å­˜å¯èƒ½å·²ç»è¢«åˆ†é…ç»™å…¶å®ƒæ‰€æœ‰è€…ã€‚Rust ç¡®ä¿å¼•ç”¨æ°¸è¿œä¹Ÿä¸ä¼šå˜æˆæ‚¬å‚çŠ¶æ€ï¼š**ç¼–è¯‘å™¨ç¡®ä¿æ•°æ®ä¸ä¼šåœ¨å…¶å¼•ç”¨ä¹‹å‰ç¦»å¼€ä½œç”¨åŸŸ**ã€‚

```rust
fn main() {
    let r = dr();            // å¼•ç”¨æŒ‡å‘æ— æ•ˆçš„ String
}

fn dr() -> &String {        // è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²å¼•ç”¨
    let s = String::from("hello");
    &s                      // é”™è¯¯
}   // s ç¦»å¼€ä½œç”¨åŸŸï¼Œå…¶å†…å­˜å°†è¢«é‡Šæ”¾
```

## åˆ‡ç‰‡ç±»å‹

åˆ‡ç‰‡æ˜¯æ²¡æœ‰æ‰€æœ‰æƒçš„æ•°æ®ç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ç§ DSTï¼Œè®°ä½œ `[T]`ï¼Œå¯¹å®ƒçš„å¼•ç”¨è®°ä½œ `&[T]`ï¼Œå®ƒå…è®¸å¼•ç”¨é›†åˆä¸­ä¸€æ®µè¿ç»­çš„å…ƒç´ åºåˆ—ï¼Œè€Œä¸æ˜¯å¼•ç”¨æ•´ä¸ªé›†åˆã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸ç”¨ä¸¥æ ¼åŒºåˆ†åˆ‡ç‰‡å’Œåˆ‡ç‰‡çš„å¼•ç”¨ã€‚

### å­—ç¬¦ä¸²åˆ‡ç‰‡

å­—ç¬¦ä¸²åˆ‡ç‰‡æ˜¯å¯¹ `String` æˆ– `str` ä¸­ä¸€éƒ¨åˆ†å€¼çš„å¼•ç”¨ï¼Œè®°ä½œ `&str`ã€‚å®é™…ä¸Š `str` å°±æ˜¯ä¸€ä¸ªç±»å‹ä¸º `[u8]` çš„åŠ¨æ€å¤§å°ç±»å‹ï¼Œè€Œ `&str` å°±æ˜¯ä¸€ä¸ª `&[u8]`ã€‚å’Œé€šå¸¸çš„ `[u8]` æˆ– `&[u8]` çš„åŒºåˆ«ä¸ºï¼Œ`&str` ä¿è¯å…¶ä¸­çš„å€¼ä¸ºåˆæ³•çš„ UTF-8 ç¼–ç ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ª `[char]` æˆ– `&[char]`ã€‚

```rust
let s = String::from("hello world");
let s1 = &s[0..5];
let s2 = &s[6..=10];
```

`..` ä¸º**åŒºé—´è¡¨è¾¾å¼**ï¼Œ`=` è¡¨ç¤ºé—­åŒºé—´ã€‚`s1` å°†å¼•ç”¨æ•´ä¸ª `String` ä¸­ç´¢å¼•å€¼ä¸º `[0..5]` éƒ¨åˆ†ã€‚å®ƒä¸æ˜¯å¯¹æ•´ä¸ª `String` çš„å¼•ç”¨ï¼Œè€Œæ˜¯å¯¹éƒ¨åˆ† `String` çš„å¼•ç”¨ã€‚

![å­—ç¬¦ä¸²åˆ‡ç‰‡](https://raw.githubusercontent.com/genskyff/image-hosting/main/images/202203240457604.png)

å­—ç¬¦ä¸²åˆ‡ç‰‡çš„ç´¢å¼•å¿…é¡»ä½äºæœ‰æ•ˆçš„ UTF-8 å­—ç¬¦è¾¹ç•Œå†…ï¼Œè‹¥å°è¯•ä»ä¸€ä¸ªå¤šå­—èŠ‚å­—ç¬¦çš„ä¸­é—´ä½ç½®åˆ›å»ºå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œåˆ™ä¼š panicã€‚

```rust
let s = String::from("ä½ å¥½");
let s1 = &s[0..2];   // é”™è¯¯ï¼ŒUTF-8 ä¸­æ±‰å­—å  3 ä¸ªå­—èŠ‚
let s1 = &s[0..3];   // æ­£ç¡®
```

å¯¹äºåŒºé—´è¡¨è¾¾å¼ï¼Œè‹¥ä»ç´¢å¼• 0 å¼€å§‹æˆ–åˆ°å°¾éƒ¨ç»“æŸï¼Œå¯ä»¥ä¸å†™ä¸¤ä¸ªç‚¹å·ä¹‹å‰æˆ–ä¹‹åçš„å€¼ã€‚

```rust
let s1 = &s[..5];
let s2 = &s[6..];
let s3 = &s[..];    // è·å–æ•´ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡
```

#### å­—ç¬¦ä¸²å­—é¢å€¼å°±æ˜¯åˆ‡ç‰‡

å­—ç¬¦ä¸²å­—é¢å€¼è¢«å‚¨å­˜åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œå› æ­¤å®ƒå°±æ˜¯ä¸€ä¸ªåˆ‡ç‰‡ã€‚

```rust
let s = "hello world";
```

è¿™é‡Œ `s` çš„ç±»å‹æ˜¯ `&str`ï¼šå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘äºŒè¿›åˆ¶æ–‡ä»¶ç‰¹å®šä½ç½®çš„åˆ‡ç‰‡ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå­—ç¬¦ä¸²å­—é¢å€¼æ˜¯ä¸å¯å˜çš„ã€‚

#### å­—ç¬¦ä¸²åˆ‡ç‰‡ä½œä¸ºå‚æ•°

å¯¹äºä¸€ä¸ªæ¥å— `&String` å‚æ•°çš„å‡½æ•°ï¼š

```rust
fn foo(s: &String) {}
```

å¯ä»¥æ”¹ä¸ºæ¥å— `&str`ï¼š

```rust
fn foo(s: &str) {}
```

è¿™æ ·å¯ä»¥å¯¹ `String` å€¼å’Œ `&str` å€¼ä½¿ç”¨ç›¸åŒçš„å‡½æ•°ï¼Œä½¿ API æ›´åŠ é€šç”¨ã€‚

```rust
let s1 = String::from("hello world");
let s2 = "second string";

foo(&s1);
foo(&s1[..]);
foo(s2);
foo(&s2[..]);
```

###  å…¶å®ƒåˆ‡ç‰‡ç±»å‹

é™¤äº†å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œä»»ä½• `&[T]` éƒ½æ˜¯åˆ‡ç‰‡ï¼Œå¦‚ `&[i32]`ã€‚

```rust
let arr = [1, 2, 3, 4, 5];
let slice = &arr[1..3];
assert_eq!(slice, &[2, 3]);
```

# 3 è‡ªå®šä¹‰ç±»å‹

## ç»“æ„ä½“

### å®šä¹‰

ç»“æ„ä½“ä½¿ç”¨ `struct` å®šä¹‰ï¼Œæ²¡æœ‰ä»»ä½•å­—æ®µçš„ä¸º**å•å…ƒç»“æ„ä½“**ï¼Œé€šå¸¸ç”¨äºä¸å­˜å‚¨æ•°æ®ä»…å®ç°æŸä¸ª trait æ—¶ä½¿ç”¨ã€‚æ²¡æœ‰å­—æ®µååªæœ‰ç±»å‹çš„ä¸º**å…ƒç»„ç»“æ„ä½“**ã€‚

```rust
struct User {
    name: String,
    age: u8,
}

struct U;
struct Rgb(u8, u8, u8);

fn main() {
    let mut user1 = User {
        name: String::from("Alice"),
        age: 18
    };

    let user2 = User {
        name: String::from("Bob"),
        ..user1
    };

    let u = [U, U {}];
    let color = Rgb(255, 255, 255);

    user1.age = 20;
}
```

åœ¨åˆå§‹åŒ–ç»“æ„ä½“æ—¶ï¼Œå¯ä»¥ä½¿ç”¨**ç»“æ„ä½“æ›´æ–°è¯­æ³•** `..`ï¼Œæ¥æŒ‡å®šå‰©ä½™æœªæ˜¾å¼è®¾ç½®å€¼çš„å­—æ®µä¸ç»™å®šå®ä¾‹å¯¹åº”å­—æ®µçš„å€¼ç›¸åŒï¼Œä½†è‹¥ç»™å®šå®ä¾‹ä¸­çš„è¿™äº›å¯¹åº”å­—æ®µæ²¡æœ‰å®ç° `Copy` traitï¼Œåˆ™ä¼šå‘ç”Ÿç§»åŠ¨ã€‚

å½“ä½¿ç”¨å˜é‡æ¥è¿›è¡Œåˆå§‹åŒ–æ—¶ï¼Œè‹¥å˜é‡åä¸å­—æ®µåç›¸åŒï¼Œåˆ™å¯ä½¿ç”¨**å­—æ®µåˆå§‹åŒ–ç®€å†™è¯­æ³•**ã€‚

```rust
fn new(name: String, age: u8) -> User {
    User {
        name,
        age
    }
}
```

è‹¥å‡½æ•°å‚æ•°åä¸å­—æ®µåä¸ç›¸åŒï¼Œåˆ™ä¸èƒ½ç®€å†™ã€‚

### æ‰€æœ‰æƒ

ç»“æ„ä½“ä¸æ˜¯æ ‡é‡ç±»å‹ï¼Œæ²¡æœ‰å®ç° `Copy` traitï¼Œå› æ­¤ç›´æ¥èµ‹å€¼ä¼šå‘ç”Ÿç§»åŠ¨ã€‚

```rust
struct Foo;

fn main() {
    let s = Foo;
    let s2 = s;    // s è¢«ç§»åŠ¨åˆ° s2
}
```

## æšä¸¾

### å®šä¹‰

æšä¸¾å…è®¸é€šè¿‡åˆ—ä¸¾å¯èƒ½çš„æˆå‘˜æ¥å®šä¹‰ä¸€ä¸ªç±»å‹ã€‚

```rust
enum IpKind {
    V4,
    V6
}
```

æšä¸¾æˆå‘˜æ‹¥æœ‰éšå¼çš„ä» 0 å¼€å§‹çš„æ•´æ•°å€¼ï¼Œå¯ä»¥é€šè¿‡ `as` æ¥è¿›è¡Œç±»å‹è½¬æ¢ï¼Œä¹Ÿå¯ä»¥æ˜¾å¼æŒ‡å®šå€¼ï¼š

```rust
// éšå¼å€¼ï¼Œä» 0 å¼€å§‹
enum Number {
    Zero,
    One,
    Two
}

// æ˜¾å¼å€¼
enum Color {
    Red = 0xff0000,
    Green = 0x00ff00,
    Blue = 0x0000ff
}

fn main() {
    println!("Zero is {}", Number::Zero as i32);
    println!("One is {}", Number::One as i32);

    println!("Roses are #{:06x}", Color::Red as i32);
    println!("Violets are #{:06x}", Color::Blue as i32);
}
```

æšä¸¾è¿˜å¯ä»¥å…³è”ä¸åŒç±»å‹çš„å€¼ï¼š

```rust
enum IpKind {
    V4(u8, u8, u8, u8),
    V6(String)
}

let home = IpKind::V4(127, 0, 0, 1);
let loopback = IpKind::V6(String::from("::1"));
```

**è¿™æ ·å®šä¹‰çš„æšä¸¾æˆå‘˜çš„åå­—ä¹Ÿå˜æˆäº†ä¸€ä¸ªæ„å»ºæšä¸¾å®ä¾‹çš„æ„é€ å‡½æ•°**ï¼Œå³ `IpAddr::V4()` æ˜¯ä¸€ä¸ªè·å– `String` å‚æ•°å¹¶è¿”å› `IpKind` ç±»å‹å®ä¾‹çš„å‡½æ•°è°ƒç”¨ã€‚ä½œä¸ºå®šä¹‰æšä¸¾çš„ç»“æœï¼Œè¿™äº›æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨å®šä¹‰ã€‚

```rust
enum Message {
    Quit,
    Move { x: u32, y: u32 },
    Write(String),
    Color(u8, u8, u8)
}
```

è¿™ä¸ªæšä¸¾æœ‰å››ä¸ªå«æœ‰ä¸åŒç±»å‹çš„æˆå‘˜ï¼š

-   `Quit` æ²¡æœ‰å…³è”ä»»ä½•æ•°æ®ï¼›
-   `Move` åŒ…å«ä¸€ä¸ªåŒ¿åç»“æ„ä½“ï¼›
-   `Write` åŒ…å«ä¸€ä¸ª `Stringï¼›`
-   `Color` åŒ…å«ä¸‰ä¸ª `u8`ã€‚

ä½¿ç”¨ç»“æ„ä½“ä¹Ÿå¯ä»¥è¿™æ ·å®šä¹‰ï¼Œä½†ä¸å¤Ÿç®€æ´ï¼š

```rust
struct QuitMessage;
struct MoveMessage { x: u32, y: u32 }  
struct WriteMessage(String);
struct ColorMessage(u8, u8, u8);
```

ä¸åŒ…å«ä»»ä½•å˜ä½“çš„æšä¸¾ä¸º**æ— å˜ä½“æšä¸¾**ï¼Œç”±äºæ²¡æœ‰ä»»ä½•æœ‰æ•ˆçš„å€¼ï¼Œæ‰€ä»¥ä¸èƒ½è¢«å®ä¾‹åŒ–ã€‚å®é™…ä¸Šè¿™ç›¸å½“äº `!` ç±»å‹ï¼Œä½†æ˜¯ä¸èƒ½è¢«å¼ºè½¬ä¸ºå…¶å®ƒç±»å‹ã€‚

```rust
enum ZeroVariants {}

fn main() {
    let x: ZeroVariants = loop {};
    let y: u32 = x; // é”™è¯¯ï¼Œç±»å‹ä¸åŒ¹é…
}
```

### Option æšä¸¾

è®¸å¤šè¯­è¨€ä¸­ï¼Œç©ºå€¼ `null` ä»£è¡¨æ²¡æœ‰å€¼ã€‚ä½†å½“å°è¯•åƒéç©ºå€¼é‚£æ ·ä½¿ç”¨ç©ºå€¼ï¼Œå°±ä¼šå‡ºç°é”™è¯¯ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œ**Rust æ²¡æœ‰ç©ºå€¼**ï¼Œä½†æœ‰ä¸€ä¸ªå¯ä»¥ç¼–ç å­˜åœ¨æˆ–ä¸å­˜åœ¨æ¦‚å¿µçš„æšä¸¾ï¼Œè¿™ä¸ªæšä¸¾æ˜¯ `Option<T>`ã€‚

```rust
enum Option<T> {
    Some(T),
    None
}
```

Option æšä¸¾å·²è¢«åŒ…å«åœ¨æ ‡å‡†åº“é¢„å¯¼å…¥åŒ…ä¸­ï¼Œä¸éœ€è¦å°†å…¶æ˜¾å¼å¼•å…¥ä½œç”¨åŸŸï¼Œå…¶æˆå‘˜ä¹Ÿä¸éœ€è¦ `Option::` å‰ç¼€ï¼Œå¯ç›´æ¥ä½¿ç”¨ `Some` å’Œ `None`ã€‚

```rust
let some_number = Some(5);
let some_string = Some("a string");
let absent_number: Option<i32> = None;
```

è‹¥ä½¿ç”¨ `None` è€Œä¸æ˜¯ `Some`ï¼Œåˆ™éœ€è¦æ˜¾å¼æŒ‡æ˜ç±»å‹ï¼Œå› ä¸ºç¼–è¯‘å™¨åªé€šè¿‡ `None` æ— æ³•è¿›è¡Œç±»å‹æ¨å¯¼ã€‚

## è”åˆä½“

Rust çš„è”åˆä½“å’Œ C ä¸­çš„è”åˆä½“åŸºæœ¬ç›¸åŒï¼Œä½¿ç”¨ `union` å®šä¹‰ï¼Œæ¯æ¬¡å¯¹è”åˆä½“çš„è®¿é—®éƒ½å°†å…¶éƒ¨åˆ†å­˜å‚¨å†…å®¹è½¬æ¢ä¸ºè¢«è®¿é—®å­—æ®µçš„ç±»å‹ã€‚ç”±äºè½¬æ¢å¯èƒ½ä¼šå¯¼è‡´æ„å¤–æˆ–æœªå®šä¹‰è¡Œä¸ºï¼Œæ‰€ä»¥è®¿é—®è”åˆä½“å­—æ®µæ˜¯ä¸å®‰å…¨çš„ï¼Œéœ€è¦æ”¾åœ¨ `unsafe` å—ä¸­ã€‚

```rust
union MyUnion {
    i: i32,
    f: f64,
}

fn main() {
    let u = MyUnion { i: 5 };
    println!("{}", unsafe { u.i });
}
```

## å®ç°

å®ç°æ˜¯å°†ç»“æ„ä½“ã€æšä¸¾æˆ–è”åˆä½“è¿™ç±»ç¨‹åºé¡¹ä¸å®ç°ç±»å‹å…³è”èµ·æ¥çš„ç¨‹åºé¡¹ã€‚ä½¿ç”¨ `impl` å®šä¹‰ï¼ŒåŒ…å«äº†å½“å‰å®ç°ç±»å‹å®ä¾‹çš„å‡½æ•°â€”â€”æ–¹æ³•ï¼Œå½“å‰å®ç°ç±»å‹æœ¬èº«çš„é™æ€å‡½æ•°æˆ–å¸¸é‡â€”â€”å…³è”å‡½æ•°æˆ–å…³è”å¸¸é‡ã€‚

å®ç°æœ‰ä¸¤ç§ï¼š

-   å›ºæœ‰å®ç°ï¼šåŒ…å«æ–¹æ³•ã€å…³è”å‡½æ•°æˆ–å…³è”å¸¸é‡ï¼›
-   trait å®ç°ï¼šä¸å›ºæœ‰å®ç°ç±»ä¼¼ï¼Œä½†ä½¿ç”¨ `for` æ¥ä¸ºæŸä¸ªå…·ä½“ç±»å‹å®ç° traitã€‚

```rust
#[derive(Debug)]
struct Color(u8, u8, u8);

impl Color {
    const WHITE: Color = Color(255, 255, 255);

    fn new(r: u8, g: u8, b: u8) -> Self {
        Self(r, g, b)
    }
}

impl Color {
    fn red() -> Color {
        Color(255, 0, 0)
    }

    fn mix(&self, other: &Color) -> Color {
        let r = self.0 | other.0;
        let g = self.1 | other.1;
        let b = self.2 | other.2;
        Color(r, g, b)
    }
}

impl std::fmt::Display for Color {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        let hex = format!("{:02X}{:02X}{:02X}", self.0, self.1, self.2);
        write!(f, "{}", hex)
    }
}

fn main() {
    let white = Color::WHITE;
    let red = Color::red();
    let blue = Color::new(0, 0, 255);
    println!("{white:?}");
    println!("{red}");
    println!("{blue}");
    println!("{}", red.mix(&blue));
}
```

`new` å’Œ `red` æ˜¯**å…³è”å‡½æ•°**ï¼Œå› ä¸ºå…¶ä½œç”¨äºç±»å‹è€Œéå®ä¾‹ï¼Œ`WHITE` æ˜¯**å…³è”å¸¸é‡**ï¼Œ`mix` æ˜¯**æ–¹æ³•**ã€‚

-   å…³è”å‡½æ•°ã€å…³è”å¸¸é‡ï¼šé€šè¿‡ `::` è°ƒç”¨ï¼›
-   æ–¹æ³•ï¼šé€šè¿‡ `.` è°ƒç”¨ã€‚

æ–¹æ³•ä¸å‡½æ•°ç±»ä¼¼ï¼Œä½†ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯ `self`ï¼Œä»£è¡¨è°ƒç”¨è¯¥æ–¹æ³•çš„å®ä¾‹ã€‚`&self` è¡¨ç¤ºå¼•ç”¨å®ä¾‹æœ¬èº«ï¼Œè¿™å®é™…ä¸Šæ˜¯ `self: &Self` çš„ç¼©å†™ã€‚åœ¨ä¸€ä¸ª `impl` å—ä¸­ï¼Œ`Self` æ˜¯ç±»å‹çš„åˆ«åã€‚åªè¦ç¬¬ä¸€ä¸ªå‚æ•°åä¸º `self`ï¼Œå°±ä»£è¡¨äº†å®ä¾‹æœ¬èº«ã€‚

-   `Self`ï¼šå®ä¾‹ç±»å‹çš„åˆ«åï¼›
-   `self`ï¼šè·å– `self` çš„æ‰€æœ‰æƒï¼›
-   `&self`ï¼šä¸å¯å˜åœ°å€Ÿç”¨ `self`ï¼›
-   `&mut self`ï¼šå¯å˜åœ°å€Ÿç”¨ `self`ã€‚

>   åœ¨åŒä¸€ Crate å†…ï¼Œå¯¹åŒä¸€ä¸ªç¨‹åºé¡¹çš„å®ç°å¯ä»¥åˆ†ä¸ºå¤šä¸ª `impl` å—ï¼Œä¹Ÿå¯ä»¥åˆå¹¶åˆ°ä¸€ä¸ªé‡Œé¢ã€‚
>

### è‡ªåŠ¨å¼•ç”¨å’Œè§£å¼•ç”¨

åœ¨ C / C++ è¯­è¨€ä¸­ï¼Œæœ‰ä¸¤ä¸ªä¸åŒçš„è¿ç®—ç¬¦æ¥è°ƒç”¨æ–¹æ³•ï¼š`.` ç›´æ¥åœ¨å¯¹è±¡ä¸Šè°ƒç”¨æ–¹æ³•ï¼Œè€Œ `->` åœ¨ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆä¸Šè°ƒç”¨æ–¹æ³•ï¼Œè¿™æ—¶éœ€è¦å…ˆè§£å¼•ç”¨æŒ‡é’ˆã€‚

```c
object->method();
(*object).method();
```

Rust å¹¶æ²¡æœ‰ä¸€ä¸ªä¸ `->` ç­‰æ•ˆçš„è¿ç®—ç¬¦ï¼Œä½†æœ‰**è‡ªåŠ¨å¼•ç”¨å’Œè§£å¼•ç”¨ã€‚å½“ä½¿ç”¨ `object.method()` æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸º `object` æ·»åŠ  `&`ã€`&mut` æˆ– `*` ä»¥ä½¿ `object` ä¸æ–¹æ³•ç­¾ååŒ¹é…ã€‚

```rust
let red = Color::red();
let blue = Color::new(0, 0, 255);
println!("{}", red.mix(&blue));
println!("{}", (&red).mix(&blue));
```

`red`ã€`(&red)` å®é™…ä¸Šæ˜¯ç­‰ä»·çš„ï¼Œå› ä¸ºæ–¹æ³•æ˜ç¡®æ¥å— `&self`ï¼Œå› æ­¤ç¼–è¯‘å™¨èƒ½è‡ªåŠ¨æ¨å¯¼å‡ºæ˜¯ `self`ã€`&self` è¿˜æ˜¯ `&mut self`ã€‚

## å†…å­˜å¸ƒå±€

Rust çš„å†…å­˜å¸ƒå±€è¿˜æœªç¨³å®šï¼Œå¯¹äºç»“æ„ä½“æˆ–æšä¸¾ç­‰ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šå¯¹å­—æ®µé¡ºåºã€å­—æ®µå†…å­˜ç­‰è¿›è¡Œä¼˜åŒ–ï¼Œä½†å¯ä½¿ç”¨ `repr` å±æ€§æ¥å®šä¹‰å†…å­˜å¸ƒå±€ã€‚

```rust
use std::mem::{align_of, size_of};

#[repr(C, align(8))]
struct ThreeInts {
    first: i16,
    second: i8,
    third: i32,
}

#[repr(C)]
union SizeRoundedUp {
    a: u32,
    b: [u16; 5],
}

fn main() {
    assert_eq!(align_of::<ThreeInts>(), 8);
    assert_eq!(size_of::<ThreeInts>(), 8);
    assert_eq!(align_of::<SizeRoundedUp>(), 4);
    assert_eq!(size_of::<SizeRoundedUp>(), 12);
}
```

å¸¦å­—æ®µçš„ `#[repr(C)]` æšä¸¾çš„å†…å­˜å¸ƒå±€å®é™…ä¸Šç­‰æ•ˆäºä¸€ä¸ªå¸¦ä¸¤ä¸ªå­—æ®µçš„ `#[repr(C)]` ç»“æ„ä½“ã€‚

```rust
use std::mem::{size_of, size_of_val};

#[repr(C)]
enum MyEnum {
    A(u32),
    B(f32, u64),
    C { x: u32, y: u8 },
    D,
}

// ç­‰æ•ˆäºä»¥ä¸‹å®šä¹‰
#[repr(C)]
struct MyEnumRepr {
    tag: MyEnumDiscriminant,
    payload: MyEnumFields,
}

#[repr(C)]
enum MyEnumDiscriminant {
    A,
    B,
    C,
    D,
}

#[repr(C)]
union MyEnumFields {
    a: MyAFields,
    b: MyBFields,
    c: MyCFields,
    d: MyDFields,
}

#[repr(C)]
#[derive(Copy, Clone)]
struct MyAFields(u32);

#[repr(C)]
#[derive(Copy, Clone)]
struct MyBFields(f32, u64);

#[repr(C)]
#[derive(Copy, Clone)]
struct MyCFields {
    x: u32,
    y: u8,
}

#[repr(C)]
#[derive(Copy, Clone)]
struct MyDFields;

fn main() {
    let e = MyEnum::A(1);
    let s = MyEnumRepr {
        tag: MyEnumDiscriminant::A,
        payload: MyEnumFields { a: MyAFields(1) },
    };
    
    assert_eq!(size_of::<MyEnum>(), size_of::<MyEnumRepr>());
    assert_eq!(size_of_val(&e), size_of_val(&s));
}
```

# 4 æ¨¡å¼åŒ¹é…

**æ¨¡å¼**æ˜¯ Rust ä¸­ç‰¹æ®Šçš„è¯­æ³•ï¼Œç”¨æ¥åŒ¹é…ç±»å‹ä¸­çš„ç»“æ„ï¼Œç”±ä»¥ä¸‹å†…å®¹ç»„æˆï¼š

-   å­—é¢å€¼ã€å‘½åå˜é‡
-   è§£æ„å…ƒç»„ã€æ•°ç»„ã€ç»“æ„ä½“ã€æšä¸¾å’Œè”åˆä½“
-   é€šé…ç¬¦ã€å ä½ç¬¦

## ä½¿ç”¨æ¨¡å¼çš„ä½ç½®

### let

ä¸€ä¸ª let è¯­å¥å°±æ˜¯ä¸€ä¸ªæ¨¡å¼ã€‚

```rust
let x = 5;
```

å…¶æ›´æ­£å¼çš„å½¢å¼ä¸ºï¼š

```rust
let PATTERN = EXPRESSION;
```

è¿™æ ·çš„è¯­å¥ä¸­å˜é‡åä½äº `PATTERN` ä½ç½®ï¼Œ`x` ä»£è¡¨å°†åŒ¹é…åˆ°çš„å€¼ç»‘å®šåˆ°å˜é‡ `x` çš„æ¨¡å¼ã€‚

```rust
let (x, y, z) = (1, 2, 3);
```

è¿™é‡Œå°†ä¸€ä¸ªå…ƒç»„ä¸æ¨¡å¼åŒ¹é…ã€‚`(1, 2, 3)` ä¸æ¨¡å¼ `(x, y, z)` ç›¸åŒ¹é…åŒ¹é…ï¼Œå› æ­¤è¿™ä¸ªå…ƒç»„æ¨¡å¼å¯çœ‹ä½œæ˜¯å°†ä¸‰ä¸ªç‹¬ç«‹çš„å˜é‡æ¨¡å¼ç»“åˆåœ¨ä¸€èµ·ã€‚

---

å¦‚æœæ¨¡å¼ä¸­å…ƒç´ çš„æ•°é‡ä¸åŒ¹é…å…ƒç»„ä¸­å…ƒç´ çš„æ•°é‡ï¼Œåˆ™æ•´ä¸ªç±»å‹ä¸åŒ¹é…ï¼Œå¹¶ä¼šå¾—åˆ°ä¸€ä¸ªç¼–è¯‘æ—¶é”™è¯¯ã€‚

```rust
// é”™è¯¯
let (x, y) = (1, 2, 3);
```

### for

åœ¨ `for` å¾ªç¯ä¸­ä½¿ç”¨æ¨¡å¼æ¥è§£æ„å…ƒç»„ï¼š

```rust
let v = vec!['a', 'b', 'c'];

for (index, value) in v.iter().enumerate() {
    println!("{} is at index {}", value, index);
}
```

è¿™é‡Œä½¿ç”¨ `enumerate` æ–¹æ³•é€‚é…ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«å½“å‰å…ƒç´ çš„ç´¢å¼•å’Œå€¼çš„å…ƒç»„ã€‚

### match

`match` å…è®¸å°†ä¸€ä¸ªå€¼ä¸ä¸€ç³»åˆ—çš„æ¨¡å¼æ¯”è¾ƒå¹¶æ ¹æ®åŒ¹é…çš„æ¨¡å¼æ‰§è¡Œç›¸åº”ä»£ç ã€‚

```rust
match VALUE {
    PATTERN1 => EXPRESSION1,
    PATTERN2 => EXPRESSION2,
}
```

åŒ¹é…å˜é‡ `x` ä¸­ `Option<i32>` å€¼çš„ `match` è¡¨è¾¾å¼ï¼š

```rust
match x {
    None => None,
    Some(i) => Some(i + 1),
}
```

`match` è¡¨è¾¾å¼å¿…é¡»æ˜¯**ç©·å°½**çš„ï¼Œä¸”æ¯ä¸ªåˆ†æ”¯çš„è¿”å›å€¼ç±»å‹éƒ½å¿…é¡»ç›¸åŒã€‚

### if let

å½“åªå…³å¿ƒä¸€ç§æƒ…å†µçš„æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨ `if let` æ¥çœç•¥ï¼Œå¹¶å¯é€‰ç»„åˆ `else if`ã€`else if let` å’Œ `else` æ¥åŒ¹é…ï¼Œå¹¶ä¸”åŒ¹é…ä¹‹é—´å¯ä»¥ä¸ç›¸å…³è”ï¼Œå…¶ç¼ºç‚¹åœ¨äºè¢«ç¼–è¯‘å™¨æ£€æŸ¥ç©·å°½æ€§ã€‚

```rust
let value = Some(5);
let flag = false;
if let Some(1) = value {
    println!("1");
} else if let Some(2) = value {
    println!("2");
} else if flag {
    println!("true");
} else {
    println!("other");
}
```

### while let

å½“åªè¦æ¨¡å¼èƒ½åŒ¹é…å°±ä¸€ç›´è¿›è¡Œ `while` å¾ªç¯ã€‚

```rust
let mut stack = Vec::new();

stack.push(1);
stack.push(2);
stack.push(3);

while let Some(top) = stack.pop() {
    println!("{}", top);
}
```

`while` å¾ªç¯åªè¦ `pop` è¿”å› `Some` å°±ä¼šä¸€ç›´è¿è¡Œå…¶å—ä¸­çš„ä»£ç ã€‚ä¸€æ—¦å…¶è¿”å› `None`ï¼Œ`while` å¾ªç¯åœæ­¢ã€‚

>   `while let` ä¸èƒ½ä½¿ç”¨ `else if`ã€`else if let` å’Œ `else` åˆ†æ”¯ç»„åˆã€‚

### å‡½æ•°å‚æ•°

å‡½æ•°å‚æ•°ä¹Ÿæ˜¯æ¨¡å¼ã€‚

```rust
fn foo(x: i32) {}
```

ç±»ä¼¼ `let`ï¼Œ`x` å°±æ˜¯ä¸€ä¸ªæ¨¡å¼ï¼Œå¯ä»¥åœ¨å‡½æ•°å‚æ•°ä¸­è¿›è¡ŒåŒ¹é…ã€‚

```rust
fn pair(&(x, y): &(i32, i32)) {
    println!("({}, {})", x, y);
}
```

è¿™é‡Œå°±å¯ä»¥å°†ä¸€ä¸ªå…ƒç»„å‚æ•°ï¼Œè§£æ„ä¸ºä¸¤ä¸ª i32 ç±»å‹çš„å€¼ã€‚

>   é—­åŒ…å‚æ•°ä¹Ÿèƒ½ä½¿ç”¨æ¨¡å¼ã€‚

## å¯åé©³æ€§

æ¨¡å¼æœ‰ä¸¤ç§å½¢å¼ï¼š

-   å¯åé©³çš„ï¼šå¯èƒ½ä¼šåŒ¹é…ä¼šå¤±è´¥çš„æ¨¡å¼ï¼Œå¦‚ `match` åˆ†æ”¯ã€`if let` å’Œ `while let` è¡¨è¾¾å¼ï¼›
-   ä¸å¯åé©³çš„ï¼šèƒ½åŒ¹é…ä»»ä½•å€¼çš„æ¨¡å¼ï¼Œå¦‚ `let` è¯­å¥ã€`for` å¾ªç¯å’Œå‡½æ•°å‚æ•°ã€‚

```rust
// é”™è¯¯
let Some(x) = value;
```

å› ä¸º `let` è¯­å¥åªæ¥å—ä¸å¯åé©³çš„æ¨¡å¼ï¼Œè€Œ `value` è¿˜æœ‰å¯èƒ½ä¸º `None`ï¼Œå› æ­¤å¯èƒ½ä¼šå¤±è´¥ã€‚

ç”±äºå¯èƒ½ä¼šå¤±è´¥ï¼Œå› æ­¤å¯ä»¥åŠ ä¸Š `if` æ¥æ„æˆ `if let` è¡¨è¾¾å¼ã€‚

```rust
if let Some(x) = value {}
```

## åŒ¹é…é¡¹çš„æ‰€æœ‰æƒ

### éƒ¨åˆ†ç§»åŠ¨

å¯ä»¥ç§»åŠ¨ä¸€ä¸ªå˜é‡çš„ä¸€éƒ¨åˆ†ï¼Œç§°ä¸º**éƒ¨åˆ†ç§»åŠ¨**ï¼Œä¹‹åçš„ä»£ç ä¸èƒ½ä½¿ç”¨å˜é‡çš„æ•´ä½“ï¼Œä½†å¯ä½¿ç”¨æ²¡æœ‰ç§»åŠ¨çš„éƒ¨åˆ†ã€‚

è¦è·å¾—ä¸€ä¸ªå˜é‡çš„éƒ¨åˆ†æ•°æ®çš„æ‰€æœ‰æƒï¼Œéœ€è¦ä½¿ç”¨æ¨¡å¼åŒ¹é…ï¼Œå¹¶é€šè¿‡ `ref` è·å¾—è§£æ„åçš„å¼•ç”¨ã€‚

```rust
struct Person {
    firstname: String,
    lastname: String,
}

fn main() {
    let p = Person {
        firstname: String::from("AAA"),
        lastname: String::from("BBB"),
    };

    let Person {
        ref firstname,  // è§£æ„æˆä¸€ä¸ªå¼•ç”¨
        lastname,
    } = p;

    println!("{}", p.firstname);
    println!("{}", p.lastname);  // é”™è¯¯
}
```

`ref mut` è·å¾—ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼š

```rust
let mut s = Some(5);
match s {
    Some(ref mut v) => *v += 1,
    _ => (),
}
println!("{:?}", s);
```

`ref` é€šå¸¸ç”¨åœ¨è¦åŒ¹é…çš„å¯¹è±¡æ²¡æœ‰æ‰€æœ‰æƒçš„æ—¶å€™ï¼š

```rust
fn main() {
    let s = Some(String::from("hi"));
    print_s(&s);
}

fn print_s(s: &Option<String>) {
    match *s {
        Some(ref v) => println!("{}", v),
        None => println!("Nothing"),
    }
}
```

`print_s` å‡½æ•°æ¥æ”¶ä¸€ä¸ªå¼•ç”¨ `&T`ï¼Œå› æ­¤å¹¶æ²¡æœ‰è¿™ä¸ªå‚æ•°çš„æ‰€æœ‰æƒï¼Œå½“å¯¹å…¶è¿›è¡Œè§£å¼•ç”¨åï¼ŒåŒ¹é…ä¸­çš„ç±»å‹å˜ä¸º `T`ï¼Œä½†ä¸èƒ½å¯¹å¼•ç”¨çš„å¯¹è±¡è·å¾—æ‰€æœ‰æƒï¼Œå› æ­¤å¿…é¡»å¯¹ `v` ä½¿ç”¨ `ref` ä¿®é¥°ï¼Œå¦åˆ™æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚

>   `ref` å’Œ `&` éƒ½å¯åœ¨æ¨¡å¼åŒ¹é…ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯å‰è€…ä¸æ˜¯æ¨¡å¼çš„ä¸€éƒ¨åˆ†ï¼Œè€Œåè€…æ˜¯æ¨¡å¼çš„ä¸€éƒ¨åˆ†ã€‚`ref` ä»…è¡¨ç¤ºè·å¾—å€¼çš„ä¸€ä¸ªå¼•ç”¨ï¼Œè€Œä¸è·å–æ‰€æœ‰æƒã€‚

å¯¹äºæ²¡æœ‰å®ç° `Copy` trait çš„ç±»å‹å€¼ï¼Œåœ¨åŒ¹é…æ—¶ä¼šè·å¾—æ‰€æœ‰æƒï¼Œä»è€Œå‘ç”Ÿç§»åŠ¨ã€‚

```rust
let s = Some(String::from("hello"));
match s {
    Some(v) => println!("{v}"),
    None => println!("Nothing"),
}
println!("{:?}", s);    // é”™è¯¯ï¼Œs ä¸­çš„å€¼å·²ç»ç§»åŠ¨åˆ° v
```

`Some(v)` ä¸­çš„ `v` ä¼šè·å¾— `s` ä¸­ `String` çš„æ‰€æœ‰æƒï¼Œ`s` ä¸­çš„ä¸€éƒ¨åˆ†è¢«ç§»åŠ¨äº†ï¼Œåœ¨ä¹‹åå°±ä¸èƒ½ç»§ç»­ä½¿ç”¨ `s` æ•´ä½“ï¼Œä½†å¯ä½¿ç”¨æ²¡æœ‰è¢«ç§»åŠ¨çš„éƒ¨åˆ†ã€‚

å¦‚æœå€¼ä¸æ˜¯ Copy çš„ï¼Œè¿˜æƒ³é‡å¤ä½¿ç”¨çš„è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨ `ref` æ¥åŒ¹é…ã€‚

```rust
let value = Some(String::from("hello"));

match value {
    ref v@ Some(ref t) => {
        println!("value: {:?}", v);
        println!("inner value: {t}");
    },
    None => println!("None"),
}

println!("value: {:?}", value);
```

`ref` é€šè¿‡å¼•ç”¨æ¥åŒ¹é…ï¼Œè€Œä¸æ˜¯æ ¹æ®å€¼å¹¶è·å–æ‰€æœ‰æƒã€‚

`ref` è¿˜å¯ä»¥ç”¨åœ¨ `let` è¯­å¥å’Œå‡½æ•°å‚æ•°ä¸­ã€‚

```rust
let s1 = String::from("hello");
let s2 = String::from("world");

let (ref r1, ref r2) = (s1, s2);

// é”™è¯¯ï¼Œs1 å’Œ s2 å·²ç»è¢«ç§»åŠ¨
println!("{s1}, {s2}");
```

è¿™é‡Œ `r1` å’Œ `r2` å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå…¶ç±»å‹ä¸º `&String`ï¼Œä½† `s1` å’Œ `s2` åˆ™ç§»åŠ¨äº†æ‰€æœ‰æƒã€‚

```rust
let (r1, r2) = (&s1, &s2);
```

è€Œè¿™é‡Œ `r1` å’Œ `r2` ä¹Ÿæ˜¯ä¸€ä¸ª `&String`ï¼Œä½† `s1` å’Œ `s2` åˆ™æ²¡æœ‰æ‰€æœ‰æƒã€‚

---

è€Œåœ¨å‡½æ•°ä¸­ï¼Œå®é™…ä¸Šå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå‘½åå˜é‡ï¼Œå¹¶å°†ä¼ è¿›æ¥çš„å€¼è¿›è¡Œç»‘å®šã€‚

```rust
let s = String::from("hello");
foo(s);
println!("{s}");  // é”™è¯¯ï¼Œs å·²ç»è¢«ç§»åŠ¨

fn get(ref v: String) {
    let t = v;    // t çš„ç±»å‹ä¸º &String
}
```

è¿™é‡Œé€šè¿‡ `ref` å°†å‚æ•°å˜æˆäº†ä¸€ä¸ªå¼•ç”¨ï¼Œä½†æ˜¯è·å–äº†å¤–éƒ¨å‚æ•°çš„æ‰€æœ‰æƒã€‚

å®é™…ä¸Šå°±ç›¸å½“äºåšäº†ä»¥ä¸‹æ“ä½œï¼š

```rust
let ref v = t;

// ç›¸å½“äº
let t = 1;
let v = t;
let v = &v;
```

---

é€šè¿‡åœ¨ `ref` ååŠ  `mut` å…³é”®å­—ï¼Œå¯ä»¥è·å¾—ä¸€ä¸ªå¯å˜å¼•ç”¨ã€‚

```rust
let ref mut v = t;

// ç›¸å½“äº
let v = t;
let v = &mut v;
```

---

åŒæ—¶ `ref` è¿˜å¯ç”¨äºéƒ¨åˆ†ç§»åŠ¨ã€‚å¯¹äºæ²¡æœ‰å®ç° `Copy` trait çš„ç±»å‹ï¼Œåœ¨ä¼ é€’æ—¶ä¼šå‘ç”Ÿç§»åŠ¨ã€‚è‹¥æ˜¯ä¸€ä¸ªç»“æ„ä½“é€šè¿‡æ¨¡å¼åŒ¹é…æ¥å°†å­—æ®µå€¼ä»˜ç»™å…¶å®ƒçš„å˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªç»“æ„ä½“å°±ä¸èƒ½åœ¨åé¢ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥ä½¿ç”¨ã€‚

```rust 
#[derive(Debug)]
struct User {
    id: usize,
    name: String,
}

let user = User {
    id: 1,
    name: String::from("Alice"),
};

let User { id, ref name }= user;
println!("{id}, {name}");
println!("{:?}", user);
```

è¿™é‡Œé€šè¿‡ `ref` æ¥ä»…è·å¾—ä¸€ä¸ªå¼•ç”¨ï¼Œå› æ­¤åœ¨åé¢è¿˜å¯ä»¥ä½¿ç”¨ `user`ã€‚

## æ¨¡å¼è¯­æ³•

### åŒ¹é…å­—é¢å€¼

å¯ä»¥ç›´æ¥åŒ¹é…å­—é¢å€¼ã€‚

```rust
let x = 1;

match x {
    1 => println!("one"),
    2 => println!("two"),
    3 => println!("three"),
    _ => println!("anything"),
}
```

### åŒ¹é…å‘½åå˜é‡

å‘½åå˜é‡æ˜¯åŒ¹é…ä»»ä½•å€¼çš„ä¸å¯åé©³æ¨¡å¼ã€‚

```rust
let x = Some(5);
let y = 10;

match x {
    Some(20) => todo!(),
    Some(y) => println!("y = {y}"),
    _ => println!("x = {:?}", x),
}

println!("x = {:?}, y = {y}", x);
```

ç¬¬ä¸€ä¸ªåˆ†æ”¯ä¸åŒ¹é…ï¼Œç¬¬äºŒä¸ªåˆ†æ”¯åŒ¹é…ä»»æ„å€¼ï¼Œå¹¶å°†è¯¥å€¼ç»‘å®šåˆ° `y` ä¸Šï¼Œè¿™ç›¸å½“äºåœ¨è¿™æ¡åˆ†æ”¯ä¸­åˆ›å»ºäº†ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå¹¶ä½¿ç”¨ `let y = 5;`ï¼Œå› æ­¤è¿™é‡Œçš„ `y` å’Œ `match` å¤–é¢çš„ `y` æ˜¯ä¸åŒçš„ï¼Œå½“ `match` è¡¨è¾¾å¼ç»“æŸï¼Œå…¶ä½œç”¨åŸŸä¹Ÿå°±ç»“æŸäº†ã€‚

### å¤šä¸ªæ¨¡å¼

ä½¿ç”¨**æˆ–**è¿ç®—ç¬¦ `|` æ¥åŒ¹é…å¤šä¸ªæ¨¡å¼ã€‚

```rust
let x = 1;

match x {
    1 | 2 => println!("one or two"),
    3 => println!("three"),
    _ => println!("anything"),
}
```

### åŒ¹é…èŒƒå›´

ä½¿ç”¨ `..=` æ¥åŒ¹é…ä¸€ä¸ªé—­åŒºé—´å†…çš„å€¼ã€‚

```rust
let x = 5;

match x {
    1..=5 => println!("1 ~ 5"),
    _ => println!("others"),
}
```

åŒ¹é… `char` ç±»å‹å€¼çš„èŒƒå›´ã€‚

```rust
let x = 'c';

match x {
    'a'..='z' => println!("lowercase"),
    'A'..='Z' => println!("uppercase"),
    _ => println!("others"),
}
```

### è§£æ„ç»“æ„ä½“

åˆ›å»ºäº†å˜é‡ `a` å’Œ `b` æ¥åŒ¹é…ç»“æ„ä½“ `p` ä¸­çš„ `x` å’Œ `y` å­—æ®µã€‚

```rust
struct Point {
    x: i32,
    y: i32,
}

let p = Point { x: 0, y: 1 };
let Point { x: a, y: b } = p;
assert_eq!(0, a);
assert_eq!(1, b);
```

æ¨¡å¼ä¸­çš„å˜é‡åå¯ä»¥ä¸ä¸ç»“æ„ä½“ä¸­çš„å­—æ®µåä¸€è‡´ï¼Œä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç®€å†™ã€‚

```rust
let p = Point { x: 0, y: 1 };
let Point { x, y } = p;
assert_eq!(0, x);
assert_eq!(1, y);
```

å¯ä»¥åŒ¹é…éƒ¨åˆ†å­—æ®µå€¼ã€‚

```rust
let p = Point { x: 0, y: 1 };

match p {
    Point { x, y: 0 } => todo!(),
    Point { x: 0, y } => todo!(),
    Point { x, y } => todo!()
}
```

### è§£æ„æšä¸¾

è§£æ„æšä¸¾å’Œæšä¸¾åŒ…å«çš„å€¼ã€‚

```rust
enum Message {
    Quit,
    Move { x: i32, y: i32 },
    Write(String),
    ChangeColor(i32, i32, i32),
}

let msg = Message::ChangeColor(0, 160, 255);

match msg {
    Message::Quit => todo!(),
    Message::Move { x, y } => todo!(),
    Message::Write(s) => todo!(),
    Message::ChangeColor(r, g, b) => todo!(),
}
```

### è§£æ„åµŒå¥—å€¼

è§£æ„ç»“æ„ä½“å’Œæšä¸¾çš„åµŒå¥—ã€‚

```rust
enum IpKind {
    Ipv4,
    Ipv6,
}

struct IpAddr {
    kind: IpKind,
    value: String,
}

let ip = IpAddr {
    kind: IpKind::Ipv4,
    value: String::from("127.0.0.1"),
};

match ip {
    IpAddr { kind: IpKind::Ipv4, value } => todo!(),
    IpAddr { kind: IpKind::Ipv6, value} => todo!()
}
```

è§£æ„ç»“æ„ä½“å’Œå…ƒç»„çš„åµŒå¥—ã€‚

```rust
let ((a, b), Point { x, y }) = ((1, 2), Point { x: 3, y: 4 });
```

### å¿½ç•¥æ¨¡å¼å€¼

æœ‰æ—¶å¹¶ä¸éœ€è¦ä½¿ç”¨å…¨éƒ¨åŒ¹é…åˆ°çš„æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨ `_` æ¨¡å¼æ¥è¿›è¡Œå¿½ç•¥ï¼Œæˆ–ä½¿ç”¨ `..` å¿½ç•¥æ‰€å‰©éƒ¨åˆ†çš„å€¼ã€‚

ä½¿ç”¨ `_` å¯ä»¥å¿½ç•¥åŒ¹é…åˆ°çš„å€¼ï¼Œä¸”ä¸è¿›è¡Œç»‘å®šã€‚

```rust
// å¿½ç•¥å‡½æ•°å‚æ•°
fn foo(_: i32, y: i32) {}

// å¿½ç•¥æ¨¡å¼åŒ¹é…
match value {
    Some(_) => todo!(),
    _ => todo!()
}

// å¿½ç•¥åµŒå¥—çš„åŒ¹é…
match (value1, value2) {
    (Some(_), Some(_)) => todo!(),
    _ => todo!()
}

// å¿½ç•¥å¤šä¸ªéƒ¨åˆ†
let nums = (1, 2, 3, 4, 5);

match nums {
    (first, _, third, _, fifth) => todo!(),
    _ => todo!()
}
```

è¿˜å¯ä»¥ä½¿ç”¨ `..` æ¥å¿½ç•¥å‰©ä½™å€¼ã€‚

```rust
let nums = (1, 2, 3, 4, 5);

// å¿½ç•¥ä¸­é—´å€¼
match nums {
    (first, .., last) => todo!()
}

// å¿½ç•¥å°¾éƒ¨å€¼
match nums {
    (first, ..) => todo!()
}
```

é€šè¿‡ `..` æ¥åŒ¹é…ä¸èƒ½äº§ç”Ÿæ­§ä¹‰ã€‚

```rust
let nums = (1, 2, 3, 4, 5);

// é”™è¯¯
match nums {
    (.., mid, ..) => todo!()
}
```

å› ä¸ºä¸èƒ½ç¡®å®šä¸­é—´çš„æ˜¯å“ªä¸ªï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ã€‚

### åŒ¹é…é¢å¤–æ¡ä»¶

**åŒ¹é…å®ˆå«**æ˜¯ä¸€ä¸ªæŒ‡å®šäº `match` åˆ†æ”¯æ¨¡å¼ä¹‹åçš„é¢å¤– `if` æ¡ä»¶ï¼Œå®ƒä¹Ÿå¿…é¡»è¢«æ»¡è¶³æ‰èƒ½é€‰æ‹©æ­¤åˆ†æ”¯ã€‚

```rust
let num = Some(5);

match num {
    Some(x) if x % 2 == 0 => todo!(),
    Some(x) => todo!(),
    None => todo!()
}
```

è¿˜å¯ä»¥åœ¨åŒ¹é…å®ˆå«ä¸­ä½¿ç”¨ `|` æ¥æŒ‡å®šå¤šä¸ªæ¨¡å¼ã€‚

```rust
let x = 1;
let y = false;

match x {
    1 | 2 | 3 if y => todo!(),
    _ => todo!()
}
```

ä½¿ç”¨ `1 | 2 | 3 if y` å®é™…ä¸Šæ˜¯ç›¸å½“äº `(4 | 5 | 6) if y`ï¼Œè€Œä¸æ˜¯ `4 | 5 | (6 if y)`ã€‚

### @ ç»‘å®š

`@` è¿ç®—ç¬¦åœ¨ `match` è¯­å¥ä¸­ç”¨äºç»‘å®šå˜é‡åˆ°æ¨¡å¼ã€‚è¿™å¯ä»¥åœ¨ä¸€ä¸ªåŒ¹é…åˆ†æ”¯ä¸­ï¼ŒåŒæ—¶è®¿é—®æ•´ä¸ªå€¼å’Œéƒ¨åˆ†å€¼ã€‚

è®¾æœ‰ä¸€ä¸ª `Option<T>`ï¼ŒåŒ¹é…åœ¨ `Some` çš„æ—¶å€™ä½¿ç”¨å‘½åå˜é‡è·å–å†…éƒ¨å€¼ï¼Œä½†åŒæ—¶ä¹Ÿéœ€è¦æ•´ä¸ª `Option<T>` å€¼ã€‚

```rust
let value = Some(1);

match value {
    v@ Some(t) => {
        println!("value: {:?}", v);
        println!("inner value: {t}");
    },
    None => println!("None"),
}
```

è¿™é‡Œ `v` å°±ç›¸å½“äºæ˜¯ `value`ï¼Œ`t` å°±ç›¸å½“äºæ˜¯ `Option<T>` ä¸­çš„ `T`ã€‚ç”±äºå€¼æ˜¯ Copy çš„ï¼Œå› æ­¤å³ä½¿æ¨¡å¼çš„å‘½åå˜é‡ä¼šé€ æˆç»‘å®šï¼Œä½†æ˜¯ä¾ç„¶å¯ä»¥ä½¿ç”¨å€¼ï¼Œå¦åˆ™å°±éœ€è¦ä½¿ç”¨ `ref`ã€‚

# 5 å‡½æ•°å’Œé—­åŒ…

## å‡½æ•°

å‡½æ•°ä»¥ `fn` å®šä¹‰ï¼Œç±»å‹è¡¨ç¤ºä¸º `fn(T, U, ..) -> R`ï¼Œå‡½æ•°ç±»å‹éƒ½å®ç°äº† `FnOnce`ã€`FnMut`ã€`Fn`ã€`Copy`ã€`Clone`ã€`Send` å’Œ `Sync` traitã€‚

```rust
fn add(x: i32, y: i32) -> i32 {
    x + y
}
```

å½“å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å¸¦æœ‰ `self`ï¼Œåˆ™æ˜¯åœ¨ trait æˆ– impl ä¸­çš„æ–¹æ³•ã€‚

```rust
trait T {
    fn foo(&self);
}

struct S;
impl S {
    fn foo(&self) {}
}
```

å¯¹äº `extern` å—ï¼Œå¯åœ¨æœ€åä¸€ä¸ªå‚æ•°ä½¿ç”¨ `...` æ¥è¡¨ç¤ºå¯å˜å‚æ•°ã€‚

```rust
extern "C" {
    fn foo(x: i32, ...);
    fn with_name(format: *const u8, args: ...);
}
```

å‡½æ•°ä¹Ÿå¯ä»¥ä½œä¸ºå‡½æ•°æŒ‡é’ˆæ¥èµ‹å€¼æˆ–ä¼ é€’å‚æ•°ã€‚

```rust
fn add(x: i32, y: i32) -> i32 {
    x + y
}

fn get_add(x: i32, y: i32, f: fn(i32, i32) -> i32) {
    f(x, y);
}

fn main() {
    let f = add;
    get_add(1, 2, f);
}
```

### å¸¸é‡å‡½æ•°

å¸¸é‡å‡½æ•°ä¸ºåœ¨ç¼–è¯‘æœŸæ‰§è¡Œçš„å‡½æ•°ï¼Œé€šè¿‡ `const` å®šä¹‰ï¼Œå¿…é¡»æ˜¯**çº¯å‡½æ•°**ï¼Œä¹Ÿä¸èƒ½åŒ…å«å¦‚å †åˆ†é…è¿™æ ·çš„è¿è¡Œæ—¶æ“ä½œã€‚

```rust
const fn read_header(buf: &[u8]) -> (u8, u8, u8, u8) {
    (buf[0], buf[1], buf[2], buf[3])
}

const FILE_HEADER: (u8, u8, u8, u8) = read_header(include_bytes!("test.txt"));
```

### å‚æ•°å±æ€§

å‡½æ•°å‚æ•°ä¹Ÿå¯ä»¥æœ‰å±æ€§ã€‚

```rust
fn len(
    #[cfg(linux)]
    slice: &[u8],
    #[cfg(not(linux))]
    slice: &[u16]
) -> usize {
    slice.len()
}
```

## ä»€ä¹ˆæ˜¯é—­åŒ…

**é—­åŒ…**æ˜¯å¯ä»¥ä¿å­˜è¿›å˜é‡ã€ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–å‡½æ•°æˆ–ä½œä¸ºè¿”å›å€¼çš„**åŒ¿åå‡½æ•°**ã€‚å¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹åˆ›å»ºé—­åŒ…ï¼Œç„¶ååœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œé—­åŒ…è¿ç®—ã€‚ä¸åŒäºå‡½æ•°ï¼Œé—­åŒ…å…è®¸æ•è·è°ƒç”¨è€…ä½œç”¨åŸŸä¸­çš„å€¼ã€‚

## å‡½æ•°é‡å¤è°ƒç”¨

```rust
fn calc(x: i32) -> i32 {
    x + 1
}

fn run(n: i32) {
    if n < 10 {
        println!("{}", calc(n));
        println!("{}", calc(n));
    } else if n < 20 {
        println!("{}", calc(n));
    } else if n < 30 && n % 3 == 0 {
        println!("{}", calc(n));
    } else {
        println!("Do nothing");
    }
}
```

`calc` å‡½æ•°ç”¨æ¥æ¨¡æ‹Ÿä¸€äº›ååˆ†è€—æ—¶çš„è¿ç®—ï¼Œè¿™é‡Œç®€å•è¿”å›å‚æ•°å€¼åŠ ä¸€ã€‚`run` å‡½æ•°ç”¨æ¥æ¨¡æ‹Ÿæ ¹æ®ä¸åŒæƒ…å†µæ‰§è¡Œå®é™…çš„è¿ç®—ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰å¤šå¤„è°ƒç”¨äº† `calc` å‡½æ•°ã€‚ç¬¬ä¸€ä¸ª if å—è°ƒç”¨äº† 2 æ¬¡ï¼Œç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªåˆ†åˆ«è°ƒç”¨äº† 1 æ¬¡ï¼Œæœ€åä¸€ä¸ªæ²¡æœ‰è°ƒç”¨ã€‚

è¿™é‡Œæœ‰ä¸¤å¤„é—®é¢˜ï¼š

-   ç¬¬ä¸€ä¸ª if å—åšäº† 2 æ¬¡è°ƒç”¨ï¼Œä½†å®é™…åªéœ€è¦ 1 æ¬¡ï¼›
-   å¤šä¸ª if å—ä¸­éƒ½è¿›è¡Œäº†ç›¸åŒçš„è°ƒç”¨ï¼Œå¯ä»¥ç®€åŒ–ã€‚

### é‡æ„å‡½æ•°

é¦–å…ˆå¯ä»¥å°†å‡½æ•°è°ƒç”¨çš„è¿”å›å€¼ä¿å­˜åˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼Œä¹‹åç›´æ¥ä¼ é€’å˜é‡å€¼å³å¯ï¼Œå¦‚ä¸‹ï¼š

```rust
fn run(n: i32) {
    let result = calc(n);
// --snip--
}
```

ä½†è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè‹¥ `n` çš„å€¼ä¸€å¼€å§‹å°±æ»¡è¶³æœ€åä¸€ä¸ª if å—ï¼Œé‚£ä¹ˆå°±ä¼šåšä¸€æ¬¡ä¸å¿…è¦çš„è®¡ç®—ï¼Œè€Œä¸”è‹¥æŸä¸ªå‡½æ•°è°ƒç”¨æ‰€ä¼ é€’çš„å‚æ•°æœ‰æ‰€æ”¹å˜ï¼Œé‚£ä¹ˆå˜é‡ä¿å­˜çš„å€¼åˆ™ä¸èƒ½é€šç”¨ã€‚

ç†æƒ³æƒ…å†µæ˜¯ï¼Œè‹¥å‚æ•°ç›¸åŒï¼Œé‚£ä¹ˆæ‰€éœ€è¦çš„å‡½æ•°åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ï¼Œä¸”åªä¼šåœ¨çœŸæ­£ä½¿ç”¨çš„æ—¶å€™æ‰æ‰§è¡Œè®¡ç®—ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨é—­åŒ…ã€‚

## å®šä¹‰é—­åŒ…

é—­åŒ…å°±æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œå¯ä»¥ä¿å­˜åœ¨å˜é‡ä¸­ï¼Œè¿™é‡Œå¯ä»¥å°† `calc` å‡½æ•°æ”¹å†™ä¸ºé—­åŒ…çš„å½¢å¼ï¼š

```rust
fn run(n: i32) {
    let calc = |x| x + 1;
// --snip--
}
```

é—­åŒ…çš„å®šä¹‰ä»¥ä¸€å¯¹ç«–çº¿ `||` å¼€å§‹ï¼Œåœ¨ç«–çº¿ä¸­æŒ‡å®šé—­åŒ…çš„å‚æ•°ï¼Œè‹¥æœ‰å¤šä¸ªå‚æ•°ï¼Œåˆ™ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ `|param1, param2|`ã€‚

å‚æ•°ä¹‹åæ˜¯å­˜æ”¾é—­åŒ…ä½“çš„å¤§æ‹¬å·ï¼Œè‹¥é—­åŒ…ä½“åªæœ‰ä¸€è¡Œåˆ™å¤§æ‹¬å·å¯ä»¥çœç•¥ã€‚å¤§æ‹¬å·ä¹‹åé—­åŒ…çš„ç»“å°¾ï¼Œéœ€è¦ç”¨äº `let` è¯­å¥çš„åˆ†å·ã€‚å› ä¸ºé—­åŒ…ä½“çš„æœ€åä¸€è¡Œæ²¡æœ‰åˆ†å·ï¼Œæ‰€ä»¥é—­åŒ…ä½“æœ€åä¸€è¡Œçš„å€¼ä½œä¸ºè°ƒç”¨é—­åŒ…æ—¶çš„è¿”å›å€¼ã€‚

```rust
let foo = |param| {
    println!("{}", param);
    param + 1
};
```

>   `let` è¯­å¥è¡¨ç¤º `calc` åŒ…å«ä¸€ä¸ªåŒ¿åå‡½æ•°çš„**å®šä¹‰**ï¼Œè€Œä¸æ˜¯**è¿”å›å€¼**ã€‚

å®šä¹‰äº†é—­åŒ…ä¹‹åï¼Œå°±å¯ä»¥åƒå‡½æ•°é‚£æ ·è°ƒç”¨å€¼ã€‚

```rust
calc(1);
foo(2);
```

## é—­åŒ…ç±»å‹æ¨æ–­å’Œæ³¨è§£

é—­åŒ…ä¸ç”¨åƒå‡½æ•°é‚£æ ·åœ¨å‚æ•°å’Œè¿”å›å€¼ä¸Šæ³¨æ˜ç±»å‹ã€‚å‡½æ•°ä¸­éœ€è¦ç±»å‹æ³¨è§£æ˜¯å› ä¸ºéœ€è¦ä½œä¸ºæ¥å£ç»™å¤–éƒ¨è°ƒç”¨ï¼Œå› æ­¤éœ€è¦ä¸¥æ ¼å®šä¹‰ã€‚ä½†é—­åŒ…æ˜¯åœ¨å±€éƒ¨èŒƒå›´å†…ä½¿ç”¨ï¼Œä¸ç”¨å‘½åæˆ–ä½œä¸ºæ¥å£ã€‚

é—­åŒ…é€šå¸¸å¾ˆçŸ­ï¼Œåªå…³è”å°èŒƒå›´çš„ä¸Šä¸‹æ–‡ã€‚åœ¨è¿™äº›æœ‰é™åˆ¶çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œç¼–è¯‘å™¨å¯æ¨æ–­å‡ºå‚æ•°å’Œè¿”å›å€¼çš„ç±»å‹ã€‚

ä½†ä¹Ÿå¯ä»¥æ˜¾å¼æ ‡æ³¨å‡ºç±»å‹ï¼š

```rust
|param1: i32, param2: i32| -> i32 {}
```

é—­åŒ…è¯­æ³•å’Œå‡½æ•°è¯­æ³•ååˆ†ç±»ä¼¼ï¼Œé™¤äº†ä½¿ç”¨ç«–çº¿è€Œä¸æ˜¯æ‹¬å·ä»¥åŠå‡ ä¸ªå¯é€‰çš„è¯­æ³•ä¹‹å¤–ï¼š

```rust
fn  add_one_v1   (x: u32) -> u32 { x + 1 }
let add_one_v2 = |x: u32| -> u32 { x + 1 };
let add_one_v3 = |x|             { x + 1 };
let add_one_v4 = |x|               x + 1  ;
```

ç¬¬ä¸€è¡Œå±•ç¤ºäº†ä¸€ä¸ªå‡½æ•°å®šä¹‰ï¼Œè€Œç¬¬äºŒè¡Œå±•ç¤ºäº†ä¸€ä¸ªå®Œæ•´æ ‡æ³¨çš„é—­åŒ…å®šä¹‰ã€‚ç¬¬ä¸‰è¡Œé—­åŒ…å®šä¹‰ä¸­çœç•¥äº†ç±»å‹æ³¨è§£ï¼Œè€Œç¬¬å››è¡Œé—­åŒ…ä½“åªæœ‰ä¸€è¡Œï¼Œå› æ­¤å»æ‰äº†å¯é€‰çš„å¤§æ‹¬å·ã€‚è¿™äº›éƒ½æ˜¯æœ‰æ•ˆçš„é—­åŒ…å®šä¹‰ï¼Œå¹¶åœ¨è°ƒç”¨æ—¶äº§ç”Ÿç›¸åŒçš„è¡Œä¸ºã€‚

>   å½“çœç•¥ç±»å‹æ ‡æ³¨æ—¶ï¼Œå¿…é¡»åœ¨ä¸Šä¸‹æ–‡ä¸­ç»™å‡ºèƒ½å¤Ÿè®©ç¼–è¯‘å™¨æ¨æ–­å‡ºç±»å‹çš„ä¿¡æ¯ã€‚

---

é—­åŒ…å®šä¹‰ä¼šä¸ºæ¯ä¸ªå‚æ•°å’Œè¿”å›å€¼æ¨æ–­ä¸€ä¸ªå…·ä½“ç±»å‹ï¼š

```rust
let c = |x| x;
let s = example_closure(String::from("hello"));
let n = example_closure(5);    // æŠ¥é”™
```

ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶ï¼Œå·²ç»æ¨æ–­å‡ºé—­åŒ…çš„ç±»å‹ï¼Œå› æ­¤ç¬¬äºŒæ¬¡ä½¿ç”¨ä¸åŒçš„å‚æ•°ç±»å‹å°±ä¼šæŠ¥é”™ã€‚

---

æ¯ä¸ªå®šä¹‰çš„é—­åŒ…éƒ½æ˜¯å”¯ä¸€çš„ç±»å‹ï¼Œå³ä½¿ç­¾åç›¸åŒï¼š

```rust
let c1 = |x: i32| -> i32 {x + 1};
let c2 = |x: i32| -> i32 {x + 1};
```

è¿™ä¸¤ä¸ªé—­åŒ…è™½ç„¶ç­¾åç›¸åŒï¼Œä½†ç±»å‹æ˜¯ä¸åŒçš„ã€‚

## Fn trait

é—­åŒ…å‘¨å›´çš„ä½œç”¨åŸŸè¢«å®šä¹‰ä¸ºå…¶æ‰€å¤„çš„**ç¯å¢ƒ**ï¼Œå› æ­¤é—­åŒ…é™¤äº†èƒ½å¤Ÿä½œä¸ºå†…è”åŒ¿åå‡½æ•°æ¥ä½¿ç”¨å¤–ï¼Œå’Œå‡½æ•°æœ‰ä¸€ä¸ªæœ€å¤§çš„åŒºåˆ«ï¼š**å¯ä»¥æ•è·ç¯å¢ƒä¸­çš„å€¼**ã€‚

```rust
fn main() {
    let x = 3;
    let equal_to_x = |n| n == x;
    assert!(equal_to_x(3));
}
```

å³ä½¿ `x` å¹¶ä¸æ˜¯ `equal_to_x` é—­åŒ…çš„ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿè¢«å…è®¸ä½¿ç”¨å˜é‡ `x`ï¼Œå› ä¸ºå®ƒä¸ `equal_to_x` å®šä¹‰äºç›¸åŒçš„ä½œç”¨åŸŸã€‚

å‡½æ•°åˆ™ä¸è¡Œï¼Œè¿™æ ·åšå°†æ— æ³•é€šè¿‡ç¼–è¯‘ï¼š

```rust
// é”™è¯¯
fn main() {
    let x = 3;
    fn equal_to_x(n: i32) -> bool {
        n == x
    }
    assert!(equal_to_x(3));
}
```

---

å½“é—­åŒ…ä»ç¯å¢ƒä¸­æ•è·ä¸€ä¸ªå€¼ï¼Œé—­åŒ…ä¼šåœ¨é—­åŒ…ä½“ä¸­å‚¨å­˜è¿™ä¸ªå€¼ï¼Œè¿™ä¼šäº§ç”Ÿé¢å¤–çš„å†…å­˜å¼€é”€ï¼Œè€Œå‡½æ•°ä¸å…è®¸æ•è·ç¯å¢ƒï¼Œå› æ­¤å®šä¹‰å’Œä½¿ç”¨å‡½æ•°ä¹Ÿå°±æ²¡æœ‰è¿™äº›é¢å¤–å¼€é”€ã€‚

é—­åŒ…å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æ•è·å…¶ç¯å¢ƒï¼Œå¯¹åº”å‡½æ•°çš„ä¸‰ç§è·å–å‚æ•°çš„æ–¹å¼ï¼š

-   è·å–æ‰€æœ‰æƒï¼›

-   å¯å˜å€Ÿç”¨ï¼›

-   ä¸å¯å˜å€Ÿç”¨ã€‚

è¿™ä¸‰ç§æ•è·å€¼çš„æ–¹å¼å¯¹åº”ä¸‰ä¸ª `Fn` traitï¼š

-   `std::ops::FnOnce` ä»ç¯å¢ƒè·å–å€¼çš„æ‰€æœ‰æƒï¼Œå› æ­¤è¯¥ç±»é—­åŒ…åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼›
-   `std::ops::FnMut` ä»ç¯å¢ƒè·å–å€¼çš„å¯å˜çš„å€Ÿç”¨ï¼Œå› æ­¤å¯ä»¥æ”¹å˜å…¶ç¯å¢ƒçš„å€¼ï¼›
-   `std::ops::Fn` ä»ç¯å¢ƒè·å–å€¼çš„ä¸å¯å˜çš„å€Ÿç”¨ã€‚

å½“å®šä¹‰ä¸€ä¸ªé—­åŒ…æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®å…¶å¦‚ä½•ä½¿ç”¨ç¯å¢ƒä¸­çš„å€¼æ¥æ¨æ–­å¦‚ä½•å¼•ç”¨ç¯å¢ƒçš„å€¼ï¼š

-   ç”±äºæ‰€æœ‰é—­åŒ…éƒ½å¯ä»¥è¢«è‡³å°‘è°ƒç”¨ä¸€æ¬¡ï¼Œå› æ­¤æ‰€æœ‰é—­åŒ…éƒ½å®ç°äº† `FnOnce` ï¼›
-   æ²¡æœ‰è·å–è¢«æ•è·å€¼çš„æ‰€æœ‰æƒçš„é—­åŒ…éƒ½å®ç°äº† `FnMut` ï¼›
-   æ²¡æœ‰å¯¹è¢«æ•è·å€¼è¿›è¡Œå¯å˜è®¿é—®çš„é—­åŒ…éƒ½å®ç°äº† `Fn` ã€‚ 

å®é™…ä¸Šï¼Œè¿™ä¸‰ç§é—­åŒ… trait çš„é™åˆ¶ç¨‹åº¦ä¾æ¬¡å¢å¤§ï¼Œå› ä¸ºä¸€ä¸ª `FnOnce` é—­åŒ…è¿˜å¯ä»¥æ¥å— `&mut T` å’Œ `&T`ï¼Œè€Œä¸€ä¸ª `Fn` é—­åŒ…åˆ™åªèƒ½æ¥å— `&T`ã€‚ç¼–è¯‘å™¨ä¼šåœ¨æ»¡è¶³ä½¿ç”¨éœ€æ±‚çš„å‰æä¸‹å°½é‡ä»¥é™åˆ¶æœ€å¤šçš„æ–¹å¼æ•è·ã€‚

---

`Fn` ç³»åˆ— trait ç”±æ ‡å‡†åº“æä¾›ï¼Œæ‰€æœ‰çš„é—­åŒ…éƒ½è‡ªåŠ¨å®ç°äº† `FnOnce`ã€`FnMut` æˆ– `Fn` ä¸­çš„ä¸€ä¸ªã€‚

>   å‡½æ•°ä¹Ÿéƒ½å®ç°äº†è¿™ä¸‰ä¸ª `Fn` traitï¼Œè‹¥ä¸éœ€è¦æ•è·ç¯å¢ƒä¸­çš„å€¼ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å®ç°äº† `Fn` trait çš„é—­åŒ…ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨å‡½æ•°ã€‚

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œç”±äº `equal_to_x` é—­åŒ…ä¸å¯å˜çš„å€Ÿç”¨äº† `x`ï¼Œæ‰€ä»¥ `equal_to_x` å…·æœ‰ `Fn` traitã€‚

---

```rust
let mut s = String::from("hello");
let mut add_suffix = || s.push_str(" world");
println!("{s}");  // é”™è¯¯
add_suffix();
```

`add_suffix` è¿™ä¸ªé—­åŒ…å¯å˜çš„å€Ÿç”¨äº† `s`ï¼Œå› æ­¤å…·æœ‰ `FnMut` traitï¼Œä¸”éœ€è¦åŠ ä¸Š `mut` å…³é”®å­—ã€‚

è¿™é‡Œç”±äº `s` å·²ç»è¢«é—­åŒ…å¯å˜çš„å€Ÿç”¨äº†ï¼Œå› æ­¤ `println!` ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒä¼šä¸å¯å˜çš„å€Ÿç”¨ã€‚

---

è‹¥éœ€è¦å¼ºåˆ¶é—­åŒ…è·å–å…¶æ•è·å€¼çš„æ‰€æœ‰æƒï¼Œå¯ä»¥ä½¿ç”¨ `move` å…³é”®å­—ï¼Œè¿™ä¸ªæŠ€å·§é€šå¸¸ç”¨åœ¨å°†é—­åŒ…ä¼ é€’ç»™æ–°çº¿ç¨‹ä»¥ä¾¿å°†æ•°æ®ç§»åŠ¨åˆ°æ–°çº¿ç¨‹ä¸­æ—¶ã€‚

```rust
let s = String::from("hello");
let equal_to_s = move |n| s == n;
println!("{}", s);    // æ­¤å¤„ s å·²å¤±æ•ˆ
assert!(equal_to_s(String::from("hello")));
```

>   ç®€å•ç±»å‹ç”±äºå®ç°äº† `Copy` traitï¼Œå°±ç®—ä½¿ç”¨äº† `move` å…³é”®å­—ï¼Œé—­åŒ…è·å–çš„ä¹Ÿåªæ˜¯å€¼çš„æ‹·è´ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨åƒ `vector`ã€`String` è¿™æ ·çš„ç±»å‹ã€‚

---

```rust
let f = |_| ();
let s = String::from("hello");
f(s);
```

è¿™é‡Œï¼Œç”±äº `f` æ²¡æœ‰æ•è·ç¯å¢ƒçš„å€¼ï¼Œå› æ­¤ `f` å…·æœ‰ `Fn` traitï¼Œä½†æ˜¯å…¶å‚æ•°ä¼šè·å–æ‰€æœ‰æƒï¼Œåœ¨é—­åŒ…è¿è¡Œç»“æŸåï¼Œå°± `s` è¢«ç«‹åˆ»å›æ”¶ï¼Œå› æ­¤è¯¥é—­åŒ…ç›¸å½“äº `drop` å‡½æ•°çš„ä½œç”¨ã€‚

## é—­åŒ…ä½œä¸ºè¿”å›å€¼

Rust éœ€è¦åœ¨ç¼–è¯‘æœŸçŸ¥é“è¿”å›ç±»å‹çš„å¤§å°ï¼Œè€ŒåŒ¿åçš„é—­åŒ…çš„ç±»å‹æ˜¯æœªçŸ¥çš„ï¼Œå› æ­¤åªæœ‰ä½¿ç”¨ `impl Trait` æ‰èƒ½è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Œè¿”å›é—­åŒ…çš„æœ‰æ•ˆ trait æ˜¯ï¼š`FnOnce`ã€`FnMut` å’Œ `Fn`ã€‚

æ­¤å¤–ï¼Œè¿˜å¿…é¡»ä½¿ç”¨ `move` å…³é”®å­—ï¼Œå› ä¸ºåœ¨ç¦»å¼€å‡½æ•°ä½œç”¨åŸŸæ—¶ï¼Œä»»ä½•é€šè¿‡å¼•ç”¨æ•è·çš„å€¼éƒ½è¢«ä¸¢å¼ƒã€‚

```rust
fn ret_fnonce() -> impl FnOnce() {
    move || println!("FnOnce")
}

fn ret_fnmut() -> impl FnMut() {
    move || println!("FnMut")
}

fn ret_fn() -> impl Fn() {
    move || println!("Fn")
}

fn main() {
    let f_once = ret_fnonce();
    let mut f_mut = ret_fnmut();  // FnMut å¿…é¡»åŠ ä¸Š mut å…³é”®å­—
    let f = ret_fn();
    f_once();
    f_mut();
    f();
}
```

## å¸¦æœ‰æ³›å‹å’Œ Fn trait çš„é—­åŒ…

å›åˆ° `run` å‡½æ•°ï¼š

```rust
fn run(n: i32) {
    let calc = |x| x + 1;

    if n < 10 {
        println!("{}", calc(n));
        println!("{}", calc(n));
    } else if n < 20 {
        println!("{}", calc(n + 1));
    } else if n < 30 && n % 3 == 0 {
        println!("{}", calc(n + 1));
    } else {
        println!("Do nothing");
    }
}
```

å°†åŸæ¥çš„ `calc` å‡½æ•°å®šä¹‰æˆäº†ä¸€ä¸ªé—­åŒ…ï¼Œç„¶åå†è°ƒç”¨å®ƒï¼Œä½†è¿™é‡Œç¬¬ä¸€ä¸ª if å—é‡å¤è°ƒç”¨äº†ä¸¤æ¬¡ï¼Œåé¢çš„ if å—åˆ†åˆ«è°ƒç”¨äº†ä¸€æ¬¡ï¼Œä¸”ç”±äºå‚æ•°ä¸åŒï¼Œå› æ­¤ä¸èƒ½ç®€å•çš„åœ¨å¼€å¤´ä½¿ç”¨å˜é‡æ¥ä¿å­˜è¿”å›å€¼ã€‚

### æƒ°æ€§æ±‚å€¼

å¯ä»¥å®šä¹‰ä¸€ä¸ªå­˜æ”¾é—­åŒ…å’Œè°ƒç”¨é—­åŒ…ç»“æœçš„ç»“æ„ä½“ã€‚è¯¥ç»“æ„ä½“åªä¼šåœ¨éœ€è¦ç»“æœæ—¶æ‰§è¡Œé—­åŒ…ï¼Œå¹¶ç¼“å­˜ç»“æœå€¼ï¼Œä¹‹åçš„ä»£ç å°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥å€¼ï¼Œè¿™ç§æ¨¡å¼è¢«ç§°ä¸º**æƒ°æ€§æ±‚å€¼**ã€‚

ä¸ºäº†è®©ç»“æ„ä½“å­˜æ”¾é—­åŒ…ï¼Œéœ€è¦æŒ‡å®šé—­åŒ…çš„ç±»å‹ã€‚ç”±äºæ¯ä¸€ä¸ªé—­åŒ…éƒ½æ˜¯ä¸€ä¸ªå”¯ä¸€çš„ç±»å‹ï¼Œå› æ­¤éœ€è¦å°†é—­åŒ…æ”¾åœ¨æ³›å‹ä¸­ï¼Œå¹¶ä½¿ç”¨ trait bound æ¥çº¦æŸé—­åŒ…çš„ç­¾åã€‚

```rust
struct Cacher<F>
where
    F: Fn(i32) -> i32,
{
    calc: F,
    value: Option<i32>,
}
```

è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª `Cacher` ç»“æ„ä½“ï¼ŒåŒ…å«ç”¨æ¥å­˜æ”¾é—­åŒ…çš„æ³›å‹å­—æ®µ `calc` å’Œç¼“å­˜å€¼ `value`ã€‚`F` çš„ trait bound æŒ‡å®šäº† `F` æ˜¯ä¸€ä¸ªä½¿ç”¨ `Fn` çš„é—­åŒ…ã€‚ä»»ä½•å‚¨å­˜åˆ° `Cacher` å®ä¾‹çš„ `calc` å­—æ®µçš„é—­åŒ…å¿…é¡»æœ‰ä¸€ä¸ª `i32` å‚æ•°ï¼Œä¸”å¿…é¡»è¿”å›ä¸€ä¸ª `i32`ã€‚

å­—æ®µ `value` æ˜¯ `Option<i32>` ç±»å‹çš„ã€‚åœ¨æ‰§è¡Œé—­åŒ…å‰ï¼Œ`value` ä¸º `None`ï¼Œè¿™æ—¶ä½¿ç”¨ `Cacher` çš„å®ç°æ¥è¯·æ±‚é—­åŒ…çš„ç»“æœï¼Œä¼šæ‰§è¡Œé—­åŒ…å¹¶å°†ç»“æœå‚¨å­˜åœ¨ `value` å­—æ®µçš„ `Some` æˆå‘˜ä¸­ã€‚å½“å†æ¬¡è¯·æ±‚é—­åŒ…çš„ç»“æœæ—¶ï¼Œç”±äº `value` å­—æ®µä¸æ˜¯ `None`ï¼Œå› æ­¤ä¸æ‰§è¡Œé—­åŒ…ï¼Œè€Œæ˜¯è¿”å›å­˜æ”¾åœ¨ `Some` æˆå‘˜ä¸­çš„ç»“æœã€‚

ç„¶åå¯¹ `Cacher` è¿›è¡Œå®ç°ï¼š

```rust
impl<F> Cacher<F>
where
    F: Fn(i32) -> i32,
{
    fn new(calc: F) -> Self {
        Self { calc, value: None }
    }

    fn value(&mut self, arg: i32) -> i32 {
        match self.value {
            Some(v) => v,
            None => {
                let v = (self.calc)(arg);
                self.value = Some(v);
                v
            }
        }
    }
}
```

`Cacher::new` å‡½æ•°è·å–ä¸€ä¸ªé—­åŒ…ä½œä¸ºå‚æ•°ï¼Œç±»å‹ä¸ºæ³›å‹å‚æ•° `F`ï¼Œå®šä¹‰äº `impl` å—ä¸Šä¸‹æ–‡ä¸­å¹¶ä¸ `Cacher` ç»“æ„ä½“æœ‰ç€ç›¸åŒçš„ trait boundã€‚`Cacher::new` è¿”å›ä¸€ä¸ªåœ¨ `calc` å­—æ®µä¸­å­˜æ”¾äº†æŒ‡å®šé—­åŒ…å’Œåœ¨ `value` å­—æ®µä¸­å­˜æ”¾äº† `None` å€¼çš„ `Cacher` å®ä¾‹ï¼Œå› ä¸ºæ­¤æ—¶è¿˜æœªæ‰§è¡Œé—­åŒ…ã€‚

å½“éœ€è¦é—­åŒ…çš„æ‰§è¡Œç»“æœæ—¶ï¼Œä¸åŒäºç›´æ¥è°ƒç”¨é—­åŒ…ï¼Œè€Œæ˜¯è°ƒç”¨ `value` æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šæ£€æŸ¥ `self.value` æ˜¯å¦å·²ç»æœ‰äº†ä¸€ä¸ª `Some` çš„ç»“æœå€¼ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™è¿”å› `Some` ä¸­çš„å€¼è€Œä¸æ˜¯å†æ¬¡æ‰§è¡Œé—­åŒ…ã€‚

è‹¥ `self.value` æ˜¯ `None`ï¼Œåˆ™ä¼šè°ƒç”¨ `self.calc` ä¸­å­˜å‚¨çš„é—­åŒ…ï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ° `self.value` åŒæ—¶è¿”å›ç»“æœå€¼ã€‚

ç„¶åå°±å¯ä»¥åœ¨ `run` å‡½æ•°ä¸­å®šä¹‰å¹¶ä½¿ç”¨ï¼š

```rust
fn run(n: i32) {
    let mut closure_cache = Cacher::new(|x| x + 1);

    if n < 10 {
        println!("{}", closure_cache.value(n));
        println!("{}", closure_cache.value(n));
    } else if n < 20 {
        println!("{}", closure_cache.value(n + 1));
    } else if n < 30 && n % 3 == 0 {
        println!("{}", closure_cache.value(n + 1));
    } else {
        println!("Do nothing");
    }
}
```

ä¸åŒäºç›´æ¥å°†é—­åŒ…ä¿å­˜è¿›å˜é‡ï¼Œè€Œæ˜¯ä¿å­˜ä¸€ä¸ª `Cacher` å®ä¾‹æ¥å­˜æ”¾é—­åŒ…ï¼Œæ¥ç€å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹è°ƒç”¨ï¼Œä½†å®é™…è®¡ç®—åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚

### Cacher å®ç°çš„é™åˆ¶

`Cacher` å®ä¾‹å¯¹äº `value` æ–¹æ³•çš„ä»»ä½• `arg` å‚æ•°çš„å€¼éƒ½ä¼šè¿”å›ç›¸åŒçš„å€¼ï¼š

```rust
let mut closure_cache = Cacher::new(|x| x);
// éƒ½æ‰“å° 1
println!("{}", closure_cache.value(1));
println!("{}", closure_cache.value(2));
println!("{}", closure_cache.value(3));
```

ç¬¬ä¸€æ¬¡è°ƒç”¨åï¼Œç”±äº `Cacher` å®ä¾‹å°† `Some(1)` ä¿å­˜è¿› `self.value`ã€‚åœ¨è¿™ä¹‹åæ— è®ºä¼ é€’ä»€ä¹ˆå‚æ•°è°ƒç”¨ `value`ï¼Œæ€»æ˜¯ä¼šè¿”å› 1ã€‚

---

å¯ä»¥é€šè¿‡å†å¢åŠ ä¸€ä¸ª `arg` å­—æ®µç”¨æ¥å­˜æ”¾ä¹‹å‰ä¼ é€’çš„å‚æ•°ï¼Œè‹¥å†æ¬¡è°ƒç”¨çš„å‚æ•°å’Œä¹‹å‰çš„ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å› `value` å­—æ®µçš„å€¼ï¼Œå¦åˆ™å†æ¬¡è°ƒç”¨é—­åŒ…ï¼Œå¹¶å°†å‚æ•°å’Œç»“æœä¿å­˜ã€‚

```rust
struct Cacher<F>
where
    F: Fn(i32) -> i32,
{
    calc: F,
    value: Option<i32>,
    arg: Option<i32>,
}

impl<F> Cacher<F>
where
    F: Fn(i32) -> i32,
{
    fn new(calc: F) -> Self {
        Self {
            calc,
            value: None,
            arg: None,
        }
    }

    fn value(&mut self, arg: i32) -> i32 {
        match self.value {
            Some(v) => match self.arg {
                Some(a) => {
                    if a == arg {
                        v
                    } else {
                        let v = (self.calc)(arg);
                        self.value = Some(v);
                        self.arg = Some(arg);
                        v
                    }
                }
                None => v,
            },
            None => {
                let v = (self.calc)(arg);
                self.value = Some(v);
                self.arg = Some(arg);
                v
            }
        }
    }
}
```

è¿™ç§åšæ³•æ˜¾å¾—ååˆ†ç¹çï¼Œä¸”å«æœ‰é‡å¤ä»£ç ï¼Œæ›´å¥½çš„åšæ³•æ˜¯ä½¿ç”¨å“ˆå¸Œ map æ¥å­˜æ”¾å€¼ã€‚å°† `arg` ä½œä¸º keyï¼Œè€Œé—­åŒ…è°ƒç”¨çš„ç»“æœä½œä¸º valueï¼Œè¿™æ ·åªéœ€è¦ä½¿ç”¨ `entry` å’Œ `or_insert` æ–¹æ³•å³å¯å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚

```rust
struct Cacher<F>
where
    F: Fn(i32) -> i32,
{
    calc: F,
    value: HashMap<i32, i32>,
}

impl<F> Cacher<F>
where
    F: Fn(i32) -> i32,
{
    fn new(calc: F) -> Self {
        Self {
            calc,
            value: HashMap::new(),
        }
    }

    fn value(&mut self, arg: i32) -> i32 {
        *self.value.entry(arg).or_insert((self.calc)(arg))
    }
}
```

## é—­åŒ…åŸç†

Rust ä¸­çš„é—­åŒ…æ˜¯é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„ä½“å®ç°çš„ã€‚å…·ä½“æ¥è¯´ï¼Œæ¯ä¸ªé—­åŒ…éƒ½æ˜¯ä¸€ä¸ªç»“æ„ä½“å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†é—­åŒ…çš„ä»£ç å’Œä»ç¯å¢ƒä¸­æ•è·çš„å˜é‡ã€‚è¿™ä¸ªç»“æ„ä½“å¯¹è±¡å®ç°äº†ä¸€ä¸ªæˆ–å¤šä¸ª `Fn` traitï¼Œä»¥ä¾¿å¯ä»¥åƒå‡½æ•°ä¸€æ ·ä½¿ç”¨å®ƒã€‚å½“å®šä¹‰ä¸€ä¸ªé—­åŒ…æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®é—­åŒ…çš„ä»£ç å’Œæ•è·çš„å˜é‡ç”Ÿæˆä¸€ä¸ªç»“æ„ä½“ç±»å‹ï¼Œè¿™ä¸ªç»“æ„ä½“ç±»å‹å®ç°äº†å¯¹åº”çš„ traitã€‚

å¦‚ä»¥ä¸‹ä»£ç å®šä¹‰äº†ä¸€ä¸ªé—­åŒ… `add_x` å¹¶è°ƒç”¨ã€‚

```rust
let x = 10;
let add_x = |y| x + y;
println!("{}", add_x(5));
```

ç¼–è¯‘æ—¶ä¼šå°†è¿™ä¸ªé—­åŒ…è½¬æ¢ä¸ºç±»ä¼¼å¦‚ä¸‹çš„ç»“æ„ä½“ç±»å‹ã€‚

```rust
struct Closure {
    x: i32,
}

impl FnOnce<(i32,)> for Closure {
    type Output = i32;
    fn call_once(self, args: (i32,)) -> Self::Output {
        self.x + args.0
    }
}

impl FnMut<(i32,)> for Closure {
    fn call_mut(&mut self, args: (i32,)) -> Self::Output {
        self.x + args.0
    }
}

impl Fn<(i32,)> for Closure {
    extern "rust-call" fn call(&self, args: (i32,)) -> Self::Output {
        self.x + args.0
    }
}
```

å½“é—­åŒ…è¢«è°ƒç”¨æ—¶ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡è°ƒç”¨ç»“æ„ä½“çš„æ–¹æ³•æ¥æ‰§è¡Œçš„ã€‚

# 6 é”™è¯¯å¤„ç†

Rust æœ‰ä¸¤ç§é”™è¯¯ç±»åˆ«ï¼š**å¯æ¢å¤é”™è¯¯**å’Œ**ä¸å¯æ¢å¤é”™è¯¯**ã€‚å‰è€…é€šå¸¸ä»£è¡¨å‘ç”¨æˆ·æŠ¥å‘Šé”™è¯¯å¹¶é‡è¯•æ“ä½œï¼Œå¦‚æœªæ‰¾åˆ°æ–‡ä»¶ã€‚åè€…é€šå¸¸æ˜¯ Bugï¼Œå¦‚å°è¯•è®¿é—®è¶…è¿‡æ•°ç»„ç´¢å¼•çš„ä½ç½®ã€‚

å…¶å®ƒè¯­è¨€é€šå¸¸ä¸åŒºåˆ†è¿™ä¸¤ç±»ï¼Œè€Œæ˜¯é‡‡ç”¨å¼‚å¸¸å¤„ç†çš„æ–¹å¼ã€‚Rust æ²¡æœ‰å¼‚å¸¸ï¼Œä½†æœ‰å¯æ¢å¤é”™è¯¯ `Result<T, E>` å’Œä¸å¯æ¢å¤é”™è¯¯ `panic!`ã€‚

## panic! ä¸ä¸å¯æ¢å¤é”™è¯¯

å½“æ‰§è¡Œ `panic!` å®æ—¶ï¼Œä¼šæ‰“å°å‡ºé”™è¯¯ä¿¡æ¯ï¼Œå±•å¼€å¹¶æ¸…ç†æ ˆæ•°æ®ï¼Œç„¶åé€€å‡ºã€‚å‡ºç°è¿™ç§æƒ…å†µçš„åœºæ™¯é€šå¸¸æ˜¯æ£€æµ‹åˆ°ä¸€äº›ç±»å‹çš„ Bugï¼Œè€Œç¨‹åºå¹¶ä¸æ¸…æ¥šè¯¥å¦‚ä½•å¤„ç†ã€‚

å½“å‡ºç° panic æ—¶ï¼Œç¨‹åºé»˜è®¤ä¼šè¿›è¡Œ**æ ˆå±•å¼€**ã€‚Rust ä¼šå›æº¯æ ˆå¹¶æ¸…ç†å®ƒé‡åˆ°çš„æ¯ä¸€ä¸ªå‡½æ•°çš„æ•°æ®ã€‚å¦ä¸€ç§æ˜¯ç›´æ¥**ç»ˆæ­¢**ï¼Œè¿™ä¼šä¸æ¸…ç†æ•°æ®å°±é€€å‡ºç¨‹åºï¼Œç¨‹åºæ‰€ä½¿ç”¨çš„å†…å­˜ç”±æ“ä½œç³»ç»Ÿæ¥æ¸…ç†ã€‚é€šè¿‡åœ¨ *Cargo.toml* çš„ `[profile]` éƒ¨åˆ†å¢åŠ  `panic = "abort"`ï¼Œå¯åœ¨ panic æ—¶ç”±æ ˆå±•å¼€åˆ‡æ¢ä¸ºç»ˆæ­¢ã€‚

```toml
[profile.release]
panic = "abort"
```

**æ–‡ä»¶ï¼šmain.rs**

```rust
panic!("Crash here!");
```

è¾“å‡ºåŒ…å« `panic!` è°ƒç”¨é€ æˆçš„é”™è¯¯ä¿¡æ¯ã€‚ç¬¬ä¸€è¡Œæ˜¾ç¤ºäº† panic æä¾›çš„ä¿¡æ¯å¹¶æŒ‡æ˜äº†æºç ä¸­ panic å‡ºç°çš„ä½ç½®ã€‚

```rust
thread 'main' panicked at 'Crash here!', src\main.rs:2:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
error: process didn't exit successfully: 
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¢«æŒ‡æ˜çš„é‚£ä¸€è¡Œæ˜¯ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œä¸”æŸ¥çœ‹è¿™ä¸€è¡Œçš„è¯ä¼šå‘ç° `panic!` å®çš„è°ƒç”¨ã€‚åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œ`panic!` å¯èƒ½ä¼šå‡ºç°åœ¨ä»£ç æ‰€è°ƒç”¨çš„ä»£ç ä¸­ã€‚é”™è¯¯ä¿¡æ¯æŠ¥å‘Šçš„æ–‡ä»¶åå’Œè¡Œå·å¯èƒ½æŒ‡å‘å…¶å®ƒä»£ç ä¸­çš„ `panic!` å®è°ƒç”¨ï¼Œè€Œä¸æ˜¯æ­¤ä»£ç ä¸­æœ€ç»ˆå¯¼è‡´ `panic!` çš„é‚£ä¸€è¡Œã€‚

### ä½¿ç”¨ panic! çš„ backtrace

å¯ä»¥é€šè¿‡ panic æ—¶ï¼Œè¢«è°ƒå‡½æ•°çš„ backtrace æ¥å¯»æ‰¾å…·ä½“å‡ºé—®é¢˜çš„åœ°æ–¹ã€‚

```rust
let v = vec![1, 2, 3];
v[9];
```

å°è¯•è®¿é—® vector çš„ç¬¬ 10 ä¸ªå…ƒç´ ï¼Œè¶Šç•Œä¼šå¯¼è‡´ panicã€‚`[]` åº”å½“è¿”å›ä¸€ä¸ªå…ƒç´ ï¼Œè‹¥ä¼ é€’äº†ä¸€ä¸ªæ— æ•ˆç´¢å¼•ï¼Œåˆ™æ²¡æœ‰å¯ä¾› Rust è¿”å›çš„æ­£ç¡®çš„å…ƒç´ ã€‚

é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡æ¥è®¾ç½® backtraceï¼š

```shell
# Windows Powershell
$env:RUST_BACKTRACE=1; cargo run

# Windows CMD
set RUST_BACKTRACE=1 && cargo run

# Linux
RUST_BACKTRACE=1 cargo run
```

ç„¶åå°±å¯ä»¥çœ‹åˆ°å¸¦æœ‰ backtrace çš„é”™è¯¯ä¿¡æ¯ï¼š

```
thread 'main' panicked at 'index out of bounds: the len is 3 but the index is 9', src\main.rs:3:5
stack backtrace:
   0: std::panicking::begin_panic_handler
             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a\/library\std\src\panicking.rs:498 
   1: core::panicking::panic_fmt
             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a\/library\core\src\panicking.rs:116
   2: core::panicking::panic_bounds_check
             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a\/library\core\src\panicking.rs:84
   3: core::slice::index::impl$2::index<i32>
             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a\library\core\src\slice\index.rs:189
   4: core::slice::index::impl$0::index<i32,usize>
             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a\library\core\src\slice\index.rs:15
   5: alloc::vec::impl$15::index<i32,usize,alloc::alloc::Global>
             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a\library\alloc\src\vec\mod.rs:2520
   6: exp::main
             at .\src\main.rs:3
   7: core::ops::function::FnOnce::call_once<void (*)(),tuple$<> >
             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a\library\core\src\ops\function.rs:227
```

åœ¨ Debug ä¸‹æ‰èƒ½è·å–å¸¦æœ‰è¿™äº›ä¿¡æ¯çš„ backtraceï¼Œå…¶ä¸­ç¬¬ 6 ä¸ªæŒ‡å‘äº† *src/main.rs* çš„ç¬¬ 3 è¡Œï¼Œå¯ä»¥æ ¹æ®è¿™äº›å›æº¯ä¿¡æ¯æ¥å®šä½é”™è¯¯ã€‚

## Result ä¸å¯æ¢å¤çš„é”™è¯¯

å¤§éƒ¨åˆ†é”™è¯¯å¹¶æ²¡æœ‰ä¸¥é‡åˆ°éœ€è¦ç¨‹åºå®Œå…¨åœæ­¢æ‰§è¡Œã€‚Rust ä¸­æœ‰ä¸€ä¸ª `Result` æšä¸¾ï¼Œå®šä¹‰æœ‰ `Ok` å’Œ `Err` è¿™ä¸¤ä¸ªæˆå‘˜ï¼š

```rust
enum Result<T, E> {
    Ok(T),
    Err(E),
}
```

`T` å’Œ `E` æ˜¯æ³›å‹ç±»å‹å‚æ•°ï¼Œ`T` ä»£è¡¨æˆåŠŸæ—¶è¿”å›çš„ `Ok` æˆå‘˜ä¸­çš„æ•°æ®ç±»å‹ï¼Œè€Œ `E` ä»£è¡¨å¤±è´¥æ—¶è¿”å›çš„ `Err` æˆå‘˜ä¸­çš„æ•°æ®ç±»å‹ã€‚å› æ­¤å¯ä»¥å°† `Result` ç±»å‹å’Œæ ‡å‡†åº“ä¸­ä¸ºå…¶å®šä¹‰çš„å‡½æ•°ç”¨äºå¤šç§åœºæ™¯ï¼Œè¿™äº›æƒ…å†µä¸­éœ€è¦è¿”å›çš„æˆåŠŸå€¼å’Œå¤±è´¥å€¼å¯èƒ½ä¼šå„ä¸ç›¸åŒã€‚

```rust
use std::fs::File;

fn main() {
    let f = match File::open("hello.txt") {
        Ok(file) => file,
        Err(error) => panic!("Problem opening the file: {:?}", error),
    };
}
```

è¿™é‡Œä½¿ç”¨ match è¡¨è¾¾å¼æ¥å¤„ç† `File::open` æ‰€è¿”å›çš„å€¼ï¼Œè¯¥å‡½æ•°ä¼šæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶è¿”å›ä¸€ä¸ª `Result<T, E>`ã€‚æ³›å‹å‚æ•° `T` è¡¨ç¤ºæˆåŠŸå€¼çš„ç±»å‹ `std::fs::File`ï¼Œå¤±è´¥å€¼ `E` çš„ç±»å‹æ˜¯ `std::io::Error`ã€‚`Result` æšä¸¾å¯ä»¥æä¾›è¿™äº›ä¿¡æ¯ï¼ŒæˆåŠŸåˆ™è¿”å›ä¸€ä¸ªåŒ…å«æ–‡ä»¶å¥æŸ„çš„ `Ok` å®ä¾‹ï¼Œå¤±è´¥åˆ™è¿”å›é”™è¯¯ä¿¡æ¯çš„ `Err` å®ä¾‹ï¼Œå¦‚æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ²¡æœ‰è®¿é—®æƒé™ç­‰ã€‚

### åŒ¹é…ä¸åŒçš„é”™è¯¯

å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¹¶ä¸æ˜¯ä»»ä½•é”™è¯¯éƒ½å°†ç¨‹åº panicï¼Œè€Œæ˜¯æ ¹æ®é”™è¯¯ç±»å‹æ¥è¿›è¡Œä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œå› æ­¤å¯ä»¥ç”¨ `match` è¡¨è¾¾å¼åŒ¹é…ä¸åŒçš„é”™è¯¯ã€‚

```rust
use std::fs::File;
use std::io::ErrorKind;

fn main() {
    let f = match File::open("hello.txt") {
        Ok(file) => file,
        Err(error) => match error.kind() {
            ErrorKind::NotFound => match File::create("hello.txt") {
                Ok(fc) => fc,
                Err(e) => panic!("Problem creating the file: {:?}", e),
            },
            _ => panic!("Problem opening the file: {:?}", error),
        },
    };
}
```

`File::open` è¿”å›çš„ `Err` æˆå‘˜ä¸­çš„å€¼ç±»å‹ `io::Error`ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ‡å‡†åº“ä¸­æä¾›çš„ç»“æ„ä½“ã€‚è¿™ä¸ªç»“æ„ä½“æœ‰ä¸€ä¸ªè¿”å› `io::ErrorKind` å€¼çš„ `kind` æ–¹æ³•å¯ä¾›è°ƒç”¨ã€‚`io::ErrorKind` æ˜¯ä¸€ä¸ªæ ‡å‡†åº“æä¾›çš„æšä¸¾ï¼Œå®ƒçš„æˆå‘˜å¯¹åº” `io` æ“ä½œå¯èƒ½å¯¼è‡´çš„ä¸åŒé”™è¯¯ç±»å‹ã€‚è¿™é‡Œåªå¤„ç† `ErrorKind::NotFound`ï¼Œè¡¨ç¤ºæ–‡ä»¶å¹¶ä¸å­˜åœ¨ã€‚

å†…å±‚ `match` ä¸­æ£€æŸ¥çš„æ¡ä»¶æ˜¯ `error.kind()` çš„è¿”å›å€¼æ˜¯å¦ä¸º `ErrorKind`çš„ `NotFound` æˆå‘˜ã€‚å¦‚æœæ˜¯ï¼Œåˆ™å°è¯•é€šè¿‡ `File::create` åˆ›å»ºæ–‡ä»¶ã€‚ä½†åˆ›å»ºæ–‡ä»¶ä¹Ÿå¯èƒ½ä¼šå¤±è´¥ï¼Œå› æ­¤è¿˜éœ€è¦å†å¢åŠ ä¸€ä¸ªå†…å±‚ `match`ã€‚å½“æ–‡ä»¶ä¸èƒ½è¢«æ‰“å¼€ï¼Œä¼šæ‰“å°å‡ºä¸€ä¸ªä¸åŒçš„é”™è¯¯ä¿¡æ¯ã€‚å¤–å±‚ `match` çš„æœ€åä¸€ä¸ªåˆ†æ”¯ä¿æŒä¸å˜ï¼Œè¿™æ ·å¯¹ä»»ä½•é™¤äº†æ–‡ä»¶ä¸å­˜åœ¨çš„é”™è¯¯ä¼šä½¿ç¨‹åº panicã€‚

### unwrap å’Œ expect

é¢‘ç¹çš„ä½¿ç”¨ `match` ä¼šæ˜¾å¾—ååˆ†å†—é•¿è€Œç¹çã€‚`Result<T, E>` ç±»å‹å®šä¹‰äº†å¾ˆå¤šè¾…åŠ©æ–¹æ³•æ¥å¤„ç†å„ç§æƒ…å†µã€‚å…¶ä¸­ä¹‹ä¸€å«åš `unwrap`ï¼Œè‹¥ `Result` å€¼æ˜¯æˆå‘˜ `Ok`ï¼Œ`unwrap` ä¼šè¿”å› `Ok` ä¸­çš„å€¼ã€‚è‹¥ `Result` æ˜¯æˆå‘˜ `Err`ï¼Œ`unwrap` ä¼šç›´æ¥è°ƒç”¨ `panic!`ã€‚

```rust
let f = File::open("hello.txt").unwrap();
```

å‘ç”Ÿé”™è¯¯æ—¶ `unwrap` ä¼šç›´æ¥å¯¼è‡´ panicï¼Œä¸”æ²¡æœ‰é¢å¤–çš„é”™è¯¯ä¿¡æ¯ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨ `expect`ï¼Œå®ƒçš„è¡Œä¸ºä¸ `unwrap`ï¼Œä½†å¯ä»¥æä¾›é¢å¤–çš„ä¿¡æ¯ã€‚

```rust
let f = File::open("hello.txt").expect("Failed to open hello.txt");
```

>   å½“ä½¿ç”¨ unwrap æˆ– expect æ—¶ï¼Œå°±ç›¸å½“äºä¸ç®¡å‘ç”Ÿä»€ä¹ˆç±»å‹çš„é”™è¯¯ï¼Œéƒ½åªä¼šå‘ç”Ÿ panicï¼Œè€Œä¸æ˜¯æ ¹æ®é”™è¯¯ç±»å‹æ¥è¿›è¡Œå¤„ç†ã€‚

### ä¼ æ’­é”™è¯¯

å½“ä¸€ä¸ªå‡½æ•°å¯èƒ½ä¼šå‘ç”Ÿé”™è¯¯æ—¶ï¼Œé™¤äº†åœ¨è¿™ä¸ªå‡½æ•°ä¸­å¤„ç†å¤–ï¼Œè¿˜å¯ä»¥é€‰æ‹©è®©è°ƒç”¨è€…æ¥å¤„ç†ï¼Œç§°ä¸º**ä¼ æ’­é”™è¯¯**ã€‚è¿™æ ·èƒ½æ›´å¥½çš„æ§åˆ¶ä»£ç è°ƒç”¨ï¼Œå› ä¸ºè°ƒç”¨è€…å¯èƒ½æ¯”è¢«è°ƒç”¨è€…æ‹¥æœ‰æ›´å¤šä¿¡æ¯æˆ–é€»è¾‘æ¥å†³å®šåº”è¯¥å¦‚ä½•å¤„ç†é”™è¯¯ã€‚

è¦ä¼ æ’­é”™è¯¯ï¼Œå¯ä»¥å°†é”™è¯¯è¿”å›ï¼š

```rust
use std::fs::File;
use std::io::{self, Read};

fn main() {
    let s = read_content("hello.txt").unwrap();
    println!("{}", s);
}

fn read_content(path: &str) -> Result<String, io::Error> {
    let mut f = match File::open(path) {
        Ok(file) => file,
        Err(error) => return Err(error),
    };

    let mut s = String::new();
    match f.read_to_string(&mut s) {
        Ok(_) => Ok(s),
        Err(e) => Err(e),
    }
}
```

è¯¥å‡½æ•°è¿”å›ä¸€ä¸ª `Result<String, io::Error>` ç±»å‹çš„å€¼ã€‚è‹¥æ²¡æœ‰ä»»ä½•é”™è¯¯å¹¶æˆåŠŸè¿”å›ï¼Œåˆ™è°ƒç”¨è€…ä¼šæ”¶åˆ°ä¸€ä¸ªåŒ…å« `String` çš„ `Ok` å€¼ã€‚è‹¥é‡åˆ°ä»»ä½•é”™è¯¯ï¼Œåˆ™è°ƒç”¨è€…ä¼šæ”¶åˆ°ä¸€ä¸ªåŒ…å« `io::Error` çš„ `Err` å€¼ã€‚`File::open` å’Œ `read_to_string` éƒ½è¿”å› `io::Error` ç±»å‹çš„é”™è¯¯å€¼ã€‚

æ¥ç€ä½¿ç”¨ `match` å¤„ç† `File::open` è¿”å›çš„ `Result`ã€‚å¦‚æœé”™è¯¯ï¼Œåˆ™è¿”å› `Err` å®ä¾‹ã€‚`read_to_string` æ–¹æ³•ä¹Ÿè¿”å›ä¸€ä¸ª `Result`ï¼ŒåŒæ ·ä½¿ç”¨ `match` æ¥å¤„ç†ã€‚

### ç®€åŒ–ä¼ æ’­é”™è¯¯

ä½¿ç”¨ä¼ æ’­é”™è¯¯çš„æ¨¡å¼ååˆ†å¸¸è§ï¼Œå› æ­¤ Rust æä¾›äº† `?`  è¿ç®—ç¬¦æ¥ç®€åŒ–ã€‚

```rust
fn read_content(path: &str) -> Result<String, io::Error> {
    let mut f = File::open(path)?;
    let mut s = String::new();
    f.read_to_string(&mut s)?;
    Ok(s)
}
```

`Result` å€¼ä¹‹åçš„ `?` è¿ç®—ç¬¦è¢«å®šä¹‰ä¸ºä¸ä½¿ç”¨ `match` è¡¨è¾¾å¼æœ‰ç€å®Œå…¨ç›¸åŒçš„å¤„ç†æ–¹å¼ã€‚è‹¥ `Result` çš„å€¼ä¸º `Ok`ï¼Œåˆ™ä¼šè¿”å› `Ok` ä¸­çš„å€¼è€Œç¨‹åºå°†ç»§ç»­æ‰§è¡Œã€‚è‹¥å€¼ä¸º `Err`ï¼Œåˆ™ä½¿ç”¨ `Err` ä½œä¸ºè¿”å›å€¼ä»å‡½æ•°ä¸­æå‰è¿”å›ã€‚

ä¸ä½¿ç”¨ `match` ä¸åŒçš„æ˜¯ï¼Œ`?` è¿ç®—ç¬¦æ‰€ä½¿ç”¨æ¥æ”¶çš„é”™è¯¯å€¼è¢«ä¼ é€’ç»™äº† `from` å‡½æ•°ï¼Œå®ƒå®šä¹‰äºæ ‡å‡†åº“çš„ `From` trait ä¸­ï¼Œå…¶ç”¨æ¥å°†é”™è¯¯ä»ä¸€ç§ç±»å‹è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ã€‚å½“ `?` è¿ç®—ç¬¦è°ƒç”¨ `from` å‡½æ•°æ—¶ï¼Œæ”¶åˆ°çš„é”™è¯¯ç±»å‹è¢«è½¬æ¢ä¸º**ç”±å½“å‰å‡½æ•°è¿”å›ç±»å‹æ‰€æŒ‡å®šçš„é”™è¯¯ç±»å‹**ã€‚è¿™åœ¨å½“å‡½æ•°è¿”å›å•ä¸ªé”™è¯¯ç±»å‹æ¥ä»£è¡¨æ‰€æœ‰å¯èƒ½å¤±è´¥çš„æ–¹å¼æ—¶ååˆ†æœ‰æ•ˆï¼Œå³ä½¿å…¶å¯èƒ½ä¼šå› å¾ˆå¤šç§åŸå› å¤±è´¥ã€‚åªè¦æ¯ä¸€ä¸ªé”™è¯¯ç±»å‹éƒ½å®ç°äº† `from` å‡½æ•°æ¥å®šä¹‰å¦‚ä½•å°†è‡ªèº«è½¬æ¢ä¸ºè¿”å›çš„é”™è¯¯ç±»å‹ï¼Œ`?` è¿ç®—ç¬¦ä¼šè‡ªåŠ¨å¤„ç†è¿™äº›è½¬æ¢ã€‚

è¿˜å¯ä»¥åœ¨ `?` ä¹‹åä½¿ç”¨é“¾å¼æ–¹æ³•è°ƒç”¨æ¥è¿›ä¸€æ­¥ç®€åŒ–ä»£ç ï¼š

```rust
fn read_content(path: &str) -> Result<String, io::Error> {
    let mut s = String::new();
    File::open(path)?.read_to_string(&mut s)?;
    Ok(s)
}
```

`File::open(path)?` ç›´æ¥é“¾å¼è°ƒç”¨äº† `read_to_string`ã€‚ä»ç„¶éœ€è¦ `read_to_string` è°ƒç”¨ç»“å°¾çš„ `?`ï¼Œè€Œä¸”å½“ `File::open` å’Œ `read_to_string` éƒ½æˆåŠŸæ²¡æœ‰å¤±è´¥æ—¶è¿”å›åŒ…å«ç”¨æˆ·å `s` çš„ `Ok` å€¼ã€‚

---

å°†æ–‡ä»¶è¯»å–åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯ç›¸å½“å¸¸è§çš„æ“ä½œï¼Œæ‰€ä»¥æ ‡å‡†åº“æä¾›äº†åä¸º `fs::read_to_string` çš„å‡½æ•°ï¼Œå®ƒä¼šæ‰“å¼€æ–‡ä»¶ã€æ–°å»ºä¸€ä¸ª `String`ã€è¯»å–æ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶å°†å†…å®¹æ”¾å…¥ `String` å¹¶è¿”å›ã€‚

```rust
fn read_content(path: &str) -> Result<String, io::Error> {
    fs::read_to_string(path)
}
```

---

`?` è¿ç®—ç¬¦åªèƒ½è¢«ç”¨äºè¿”å›å€¼ä¸ `?` ä½œç”¨çš„å€¼ç›¸å…¼å®¹çš„å‡½æ•°ï¼Œå› ä¸º `?` è¿ç®—ç¬¦è¢«å®šä¹‰ä¸ºä»å‡½æ•°ä¸­æå‰è¿”å›ä¸€ä¸ªå€¼ï¼Œå¦‚æœè¦åœ¨ `main` å‡½æ•°ä¸­ä½¿ç”¨ï¼Œéœ€è¦ä¿®æ”¹å…¶è¿”å›å€¼ã€‚`main` å‡½æ•°æ˜¯å¯æ‰§è¡Œç¨‹åºçš„å…¥å£ç‚¹å’Œé€€å‡ºç‚¹ï¼Œä¸ºäº†ä½¿ç¨‹åºèƒ½æ­£å¸¸å·¥ä½œï¼Œå¯ä»¥è¿”å›çš„ç±»å‹æ˜¯æœ‰é™åˆ¶çš„ï¼Œä½†å¯ä»¥è¿”å› `Result<(), E>`ã€‚

```rust
fn main() -> Result<(), io::Error> {
    let f = File::open("hello")?;
    Ok(())
}
```

`?` ä¹Ÿå¯ç”¨äº `Option<T>` å€¼ï¼ŒåŒæ ·åªèƒ½åœ¨è¿”å› `Option` çš„å‡½æ•°ä¸­ä½¿ç”¨ã€‚åœ¨ `Option<T>` ä¸Šè°ƒç”¨ `?` è¿ç®—ç¬¦çš„è¡Œä¸ºä¸ `Result<T, E>` ç±»ä¼¼ï¼šè‹¥å€¼æ˜¯ `None`ï¼Œæ­¤æ—¶ `None` ä¼šä»å‡½æ•°ä¸­æå‰è¿”å›ï¼›è‹¥å€¼æ˜¯ `Some`ï¼Œ`Some` ä¸­çš„å€¼ä½œä¸ºè¡¨è¾¾å¼çš„è¿”å›å€¼ï¼Œå¹¶ç»§ç»­æ‰§è¡Œã€‚

```rust
fn plus_one(n: Option<i32>) -> Option<i32> {
    Some(n? + 1)
}
```

`?` å®é™…ä¸Šå°±æ˜¯ `try!` å®çš„è¯­æ³•ç³–ï¼Œä¸¤è€…éƒ½ä¼šå°è¯•å°†é”™è¯¯ç±»å‹è½¬æ¢ä¸ºåŒ¹é…è¿”å›çš„é”™è¯¯ç±»å‹ï¼ˆå‰ææ˜¯å®ç°äº† `From` traitï¼‰ï¼Œç”¨ `match` è¡¨è¾¾å¼çš„ä¼ªä»£ç å¤§è‡´è¡¨ç¤ºä¸ºï¼š

```rust
macro try {
    match exp {
        Ok(val) => val,
        Err(err) => {
            let converted = From::from(err);
            return Err(converted);
        }
    }
}
```

>   ç›®å‰ `try!` å·²ä¸å¸¸ç”¨ã€‚

